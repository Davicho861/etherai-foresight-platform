#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Oracle gatekeeper check
if command -v node >/dev/null 2>&1; then
  node --input-type=module -e "
    import Oracle from './server/src/oracle.js';
    const oracle = new Oracle();
    const result = await oracle.predictFailure('git push', 'pre-push validation');
    if (result.probability > 0.75) {
      console.log('Aborting push due to high failure probability:', result.suggestion);
      process.exit(1);
    }
  "
else
  echo "Node.js not found. Skipping Oracle check." >&2
fi

# Smart Test Runner - Precision Validation
if command -v npm >/dev/null 2>&1; then
  echo "Running smart tests..."
  npm run test:smart
else
  echo "npm not found. Skipping smart tests." >&2
fi

# Docker janitor cleanup
if command -v node >/dev/null 2>&1; then
  node scripts/docker-janitor.js
else
  echo "Node.js not found. Skipping Docker cleanup." >&2
fi