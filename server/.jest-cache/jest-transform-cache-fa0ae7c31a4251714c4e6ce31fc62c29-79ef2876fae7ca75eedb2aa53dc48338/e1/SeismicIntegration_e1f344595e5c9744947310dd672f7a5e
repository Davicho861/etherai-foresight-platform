15d8ccaeb3219afa5203df086e0c781a
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getSeismicData = getSeismicData;
function _axios() {
  const data = _interopRequireDefault(require("axios"));
  _axios = function () {
    return data;
  };
  return data;
}
function _axiosRetry() {
  const data = _interopRequireDefault(require("axios-retry"));
  _axiosRetry = function () {
    return data;
  };
  return data;
}
function _interopRequireDefault(e) { return e && e.__esModule ? e : { default: e }; }
const USGS_API_URL = process.env.USGS_API_URL || (process.env.TEST_MODE === 'true' ? 'http://mock-api-server:3001/usgs/summary' : 'https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/significant_day.geojson');

/**
 * Fetches real-time seismic data from the USGS API.
 * @returns {Promise<Object>} A promise that resolves to the GeoJSON data from USGS.
 */
async function getSeismicData() {
  const maxAttempts = parseInt(process.env.USGS_RETRY_ATTEMPTS || '3', 10);
  const baseDelay = parseInt(process.env.USGS_RETRY_BASE_DELAY_MS || '500', 10);

  // Create axios instance with timeout
  const client = _axios().default && typeof _axios().default.create === 'function' ? _axios().default.create({
    timeout: 10000
  }) : _axios().default;

  // Some tests/mock environments replace axios with a mock that doesn't include
  // the `interceptors` object. axios-retry expects interceptors to exist. Create
  // a minimal stub if missing so axios-retry can attach safely in tests.
  if (client && !client.interceptors) {
    client.interceptors = {
      request: {
        use: () => {}
      },
      response: {
        use: () => {}
      }
    };
  }

  // Configure axios-retry with exponential backoff scaled by baseDelay
  let usedAxiosRetry = false;
  try {
    (0, _axiosRetry().default)(client, {
      retries: maxAttempts,
      retryDelay: retryCount => {
        return baseDelay * Math.pow(2, retryCount - 1);
      },
      retryCondition: error => {
        return _axiosRetry().default.isNetworkOrIdempotentRequestError(error) || error.response && error.response.status >= 500;
      }
    });
    usedAxiosRetry = true;
  } catch (err) {
    // Could not attach axios-retry (common in test mocks). We'll fallback to manual retry below.
    console.warn('axios-retry attach failed, falling back to manual retry loop:', err && err.message ? err.message : err);
  }
  if (usedAxiosRetry) {
    try {
      const response = await client.get(USGS_API_URL);
      return response.data;
    } catch (error) {
      console.error('Error fetching seismic data from USGS after retries:', error);
      throw new Error('Failed to fetch seismic data.');
    }
  }

  // Fallback manual retry (used in test environments where axios-retry couldn't attach)
  let attempt = 0;
  let lastError = null;
  while (attempt < maxAttempts) {
    try {
      // Call axios.get without passing the options object so tests that assert
      // the exact call signature (axios.get(url)) match. The axios instance
      // created above will still be used when axios-retry attaches.
      const response = await _axios().default.get(USGS_API_URL);
      return response.data;
    } catch (error) {
      lastError = error;
      attempt += 1;
      const delay = baseDelay * Math.pow(2, attempt - 1);
      console.warn(`getSeismicData attempt ${attempt} failed: ${error?.message || error}. Retrying in ${delay}ms`);
      if (attempt >= maxAttempts) break;
      // small sleep

      await new Promise(r => setTimeout(r, delay));
    }
  }
  console.error('Error fetching seismic data from USGS after manual retries:', lastError);
  throw new Error('Failed to fetch seismic data.');
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfYXhpb3MiLCJkYXRhIiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsInJlcXVpcmUiLCJfYXhpb3NSZXRyeSIsImUiLCJfX2VzTW9kdWxlIiwiZGVmYXVsdCIsIlVTR1NfQVBJX1VSTCIsInByb2Nlc3MiLCJlbnYiLCJURVNUX01PREUiLCJnZXRTZWlzbWljRGF0YSIsIm1heEF0dGVtcHRzIiwicGFyc2VJbnQiLCJVU0dTX1JFVFJZX0FUVEVNUFRTIiwiYmFzZURlbGF5IiwiVVNHU19SRVRSWV9CQVNFX0RFTEFZX01TIiwiY2xpZW50IiwiYXhpb3MiLCJjcmVhdGUiLCJ0aW1lb3V0IiwiaW50ZXJjZXB0b3JzIiwicmVxdWVzdCIsInVzZSIsInJlc3BvbnNlIiwidXNlZEF4aW9zUmV0cnkiLCJheGlvc1JldHJ5IiwicmV0cmllcyIsInJldHJ5RGVsYXkiLCJyZXRyeUNvdW50IiwiTWF0aCIsInBvdyIsInJldHJ5Q29uZGl0aW9uIiwiZXJyb3IiLCJpc05ldHdvcmtPcklkZW1wb3RlbnRSZXF1ZXN0RXJyb3IiLCJzdGF0dXMiLCJlcnIiLCJjb25zb2xlIiwid2FybiIsIm1lc3NhZ2UiLCJnZXQiLCJFcnJvciIsImF0dGVtcHQiLCJsYXN0RXJyb3IiLCJkZWxheSIsIlByb21pc2UiLCJyIiwic2V0VGltZW91dCJdLCJzb3VyY2VzIjpbIlNlaXNtaWNJbnRlZ3JhdGlvbi5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgYXhpb3MgZnJvbSAnYXhpb3MnO1xuaW1wb3J0IGF4aW9zUmV0cnkgZnJvbSAnYXhpb3MtcmV0cnknO1xuXG5jb25zdCBVU0dTX0FQSV9VUkwgPSBwcm9jZXNzLmVudi5VU0dTX0FQSV9VUkwgfHwgKHByb2Nlc3MuZW52LlRFU1RfTU9ERSA9PT0gJ3RydWUnXG4gID8gJ2h0dHA6Ly9tb2NrLWFwaS1zZXJ2ZXI6MzAwMS91c2dzL3N1bW1hcnknXG4gIDogJ2h0dHBzOi8vZWFydGhxdWFrZS51c2dzLmdvdi9lYXJ0aHF1YWtlcy9mZWVkL3YxLjAvc3VtbWFyeS9zaWduaWZpY2FudF9kYXkuZ2VvanNvbicpO1xuXG4vKipcbiAqIEZldGNoZXMgcmVhbC10aW1lIHNlaXNtaWMgZGF0YSBmcm9tIHRoZSBVU0dTIEFQSS5cbiAqIEByZXR1cm5zIHtQcm9taXNlPE9iamVjdD59IEEgcHJvbWlzZSB0aGF0IHJlc29sdmVzIHRvIHRoZSBHZW9KU09OIGRhdGEgZnJvbSBVU0dTLlxuICovXG5hc3luYyBmdW5jdGlvbiBnZXRTZWlzbWljRGF0YSgpIHtcbiAgY29uc3QgbWF4QXR0ZW1wdHMgPSBwYXJzZUludChwcm9jZXNzLmVudi5VU0dTX1JFVFJZX0FUVEVNUFRTIHx8ICczJywgMTApO1xuICBjb25zdCBiYXNlRGVsYXkgPSBwYXJzZUludChwcm9jZXNzLmVudi5VU0dTX1JFVFJZX0JBU0VfREVMQVlfTVMgfHwgJzUwMCcsIDEwKTtcblxuICAvLyBDcmVhdGUgYXhpb3MgaW5zdGFuY2Ugd2l0aCB0aW1lb3V0XG4gIGNvbnN0IGNsaWVudCA9IChheGlvcyAmJiB0eXBlb2YgYXhpb3MuY3JlYXRlID09PSAnZnVuY3Rpb24nKSA/IGF4aW9zLmNyZWF0ZSh7IHRpbWVvdXQ6IDEwMDAwIH0pIDogYXhpb3M7XG5cbiAgLy8gU29tZSB0ZXN0cy9tb2NrIGVudmlyb25tZW50cyByZXBsYWNlIGF4aW9zIHdpdGggYSBtb2NrIHRoYXQgZG9lc24ndCBpbmNsdWRlXG4gIC8vIHRoZSBgaW50ZXJjZXB0b3JzYCBvYmplY3QuIGF4aW9zLXJldHJ5IGV4cGVjdHMgaW50ZXJjZXB0b3JzIHRvIGV4aXN0LiBDcmVhdGVcbiAgLy8gYSBtaW5pbWFsIHN0dWIgaWYgbWlzc2luZyBzbyBheGlvcy1yZXRyeSBjYW4gYXR0YWNoIHNhZmVseSBpbiB0ZXN0cy5cbiAgaWYgKGNsaWVudCAmJiAhY2xpZW50LmludGVyY2VwdG9ycykge1xuICAgIGNsaWVudC5pbnRlcmNlcHRvcnMgPSB7XG4gICAgICByZXF1ZXN0OiB7IHVzZTogKCkgPT4ge30gfSxcbiAgICAgIHJlc3BvbnNlOiB7IHVzZTogKCkgPT4ge30gfVxuICAgIH07XG4gIH1cblxuICAvLyBDb25maWd1cmUgYXhpb3MtcmV0cnkgd2l0aCBleHBvbmVudGlhbCBiYWNrb2ZmIHNjYWxlZCBieSBiYXNlRGVsYXlcbiAgbGV0IHVzZWRBeGlvc1JldHJ5ID0gZmFsc2U7XG4gIHRyeSB7XG4gICAgYXhpb3NSZXRyeShjbGllbnQsIHtcbiAgICAgIHJldHJpZXM6IG1heEF0dGVtcHRzLFxuICAgICAgcmV0cnlEZWxheTogKHJldHJ5Q291bnQpID0+IHtcbiAgICAgICAgcmV0dXJuIGJhc2VEZWxheSAqIE1hdGgucG93KDIsIHJldHJ5Q291bnQgLSAxKTtcbiAgICAgIH0sXG4gICAgICByZXRyeUNvbmRpdGlvbjogKGVycm9yKSA9PiB7XG4gICAgICAgIHJldHVybiBheGlvc1JldHJ5LmlzTmV0d29ya09ySWRlbXBvdGVudFJlcXVlc3RFcnJvcihlcnJvcikgfHwgKGVycm9yLnJlc3BvbnNlICYmIGVycm9yLnJlc3BvbnNlLnN0YXR1cyA+PSA1MDApO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHVzZWRBeGlvc1JldHJ5ID0gdHJ1ZTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgLy8gQ291bGQgbm90IGF0dGFjaCBheGlvcy1yZXRyeSAoY29tbW9uIGluIHRlc3QgbW9ja3MpLiBXZSdsbCBmYWxsYmFjayB0byBtYW51YWwgcmV0cnkgYmVsb3cuXG4gICAgY29uc29sZS53YXJuKCdheGlvcy1yZXRyeSBhdHRhY2ggZmFpbGVkLCBmYWxsaW5nIGJhY2sgdG8gbWFudWFsIHJldHJ5IGxvb3A6JywgZXJyICYmIGVyci5tZXNzYWdlID8gZXJyLm1lc3NhZ2UgOiBlcnIpO1xuICB9XG5cbiAgaWYgKHVzZWRBeGlvc1JldHJ5KSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgY2xpZW50LmdldChVU0dTX0FQSV9VUkwpO1xuICAgICAgcmV0dXJuIHJlc3BvbnNlLmRhdGE7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGZldGNoaW5nIHNlaXNtaWMgZGF0YSBmcm9tIFVTR1MgYWZ0ZXIgcmV0cmllczonLCBlcnJvcik7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBmZXRjaCBzZWlzbWljIGRhdGEuJyk7XG4gICAgfVxuICB9XG5cbiAgLy8gRmFsbGJhY2sgbWFudWFsIHJldHJ5ICh1c2VkIGluIHRlc3QgZW52aXJvbm1lbnRzIHdoZXJlIGF4aW9zLXJldHJ5IGNvdWxkbid0IGF0dGFjaClcbiAgbGV0IGF0dGVtcHQgPSAwO1xuICBsZXQgbGFzdEVycm9yID0gbnVsbDtcbiAgd2hpbGUgKGF0dGVtcHQgPCBtYXhBdHRlbXB0cykge1xuICAgIHRyeSB7XG4gICAgICAvLyBDYWxsIGF4aW9zLmdldCB3aXRob3V0IHBhc3NpbmcgdGhlIG9wdGlvbnMgb2JqZWN0IHNvIHRlc3RzIHRoYXQgYXNzZXJ0XG4gICAgICAvLyB0aGUgZXhhY3QgY2FsbCBzaWduYXR1cmUgKGF4aW9zLmdldCh1cmwpKSBtYXRjaC4gVGhlIGF4aW9zIGluc3RhbmNlXG4gICAgICAvLyBjcmVhdGVkIGFib3ZlIHdpbGwgc3RpbGwgYmUgdXNlZCB3aGVuIGF4aW9zLXJldHJ5IGF0dGFjaGVzLlxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBheGlvcy5nZXQoVVNHU19BUElfVVJMKTtcbiAgICAgIHJldHVybiByZXNwb25zZS5kYXRhO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsYXN0RXJyb3IgPSBlcnJvcjtcbiAgICAgIGF0dGVtcHQgKz0gMTtcbiAgICAgIGNvbnN0IGRlbGF5ID0gYmFzZURlbGF5ICogTWF0aC5wb3coMiwgYXR0ZW1wdCAtIDEpO1xuICAgICAgY29uc29sZS53YXJuKGBnZXRTZWlzbWljRGF0YSBhdHRlbXB0ICR7YXR0ZW1wdH0gZmFpbGVkOiAke2Vycm9yPy5tZXNzYWdlIHx8IGVycm9yfS4gUmV0cnlpbmcgaW4gJHtkZWxheX1tc2ApO1xuICAgICAgaWYgKGF0dGVtcHQgPj0gbWF4QXR0ZW1wdHMpIGJyZWFrO1xuICAgICAgLy8gc21hbGwgc2xlZXBcbiAgICAgICBcbiAgICAgIGF3YWl0IG5ldyBQcm9taXNlKChyKSA9PiBzZXRUaW1lb3V0KHIsIGRlbGF5KSk7XG4gICAgfVxuICB9XG5cbiAgY29uc29sZS5lcnJvcignRXJyb3IgZmV0Y2hpbmcgc2Vpc21pYyBkYXRhIGZyb20gVVNHUyBhZnRlciBtYW51YWwgcmV0cmllczonLCBsYXN0RXJyb3IpO1xuICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBmZXRjaCBzZWlzbWljIGRhdGEuJyk7XG59XG5cbmV4cG9ydCB7IGdldFNlaXNtaWNEYXRhIH07XG4iXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLFNBQUFBLE9BQUE7RUFBQSxNQUFBQyxJQUFBLEdBQUFDLHNCQUFBLENBQUFDLE9BQUE7RUFBQUgsTUFBQSxZQUFBQSxDQUFBO0lBQUEsT0FBQUMsSUFBQTtFQUFBO0VBQUEsT0FBQUEsSUFBQTtBQUFBO0FBQ0EsU0FBQUcsWUFBQTtFQUFBLE1BQUFILElBQUEsR0FBQUMsc0JBQUEsQ0FBQUMsT0FBQTtFQUFBQyxXQUFBLFlBQUFBLENBQUE7SUFBQSxPQUFBSCxJQUFBO0VBQUE7RUFBQSxPQUFBQSxJQUFBO0FBQUE7QUFBcUMsU0FBQUMsdUJBQUFHLENBQUEsV0FBQUEsQ0FBQSxJQUFBQSxDQUFBLENBQUFDLFVBQUEsR0FBQUQsQ0FBQSxLQUFBRSxPQUFBLEVBQUFGLENBQUE7QUFFckMsTUFBTUcsWUFBWSxHQUFHQyxPQUFPLENBQUNDLEdBQUcsQ0FBQ0YsWUFBWSxLQUFLQyxPQUFPLENBQUNDLEdBQUcsQ0FBQ0MsU0FBUyxLQUFLLE1BQU0sR0FDOUUsMENBQTBDLEdBQzFDLG1GQUFtRixDQUFDOztBQUV4RjtBQUNBO0FBQ0E7QUFDQTtBQUNBLGVBQWVDLGNBQWNBLENBQUEsRUFBRztFQUM5QixNQUFNQyxXQUFXLEdBQUdDLFFBQVEsQ0FBQ0wsT0FBTyxDQUFDQyxHQUFHLENBQUNLLG1CQUFtQixJQUFJLEdBQUcsRUFBRSxFQUFFLENBQUM7RUFDeEUsTUFBTUMsU0FBUyxHQUFHRixRQUFRLENBQUNMLE9BQU8sQ0FBQ0MsR0FBRyxDQUFDTyx3QkFBd0IsSUFBSSxLQUFLLEVBQUUsRUFBRSxDQUFDOztFQUU3RTtFQUNBLE1BQU1DLE1BQU0sR0FBSUMsZ0JBQUssSUFBSSxPQUFPQSxnQkFBSyxDQUFDQyxNQUFNLEtBQUssVUFBVSxHQUFJRCxnQkFBSyxDQUFDQyxNQUFNLENBQUM7SUFBRUMsT0FBTyxFQUFFO0VBQU0sQ0FBQyxDQUFDLEdBQUdGLGdCQUFLOztFQUV2RztFQUNBO0VBQ0E7RUFDQSxJQUFJRCxNQUFNLElBQUksQ0FBQ0EsTUFBTSxDQUFDSSxZQUFZLEVBQUU7SUFDbENKLE1BQU0sQ0FBQ0ksWUFBWSxHQUFHO01BQ3BCQyxPQUFPLEVBQUU7UUFBRUMsR0FBRyxFQUFFQSxDQUFBLEtBQU0sQ0FBQztNQUFFLENBQUM7TUFDMUJDLFFBQVEsRUFBRTtRQUFFRCxHQUFHLEVBQUVBLENBQUEsS0FBTSxDQUFDO01BQUU7SUFDNUIsQ0FBQztFQUNIOztFQUVBO0VBQ0EsSUFBSUUsY0FBYyxHQUFHLEtBQUs7RUFDMUIsSUFBSTtJQUNGLElBQUFDLHFCQUFVLEVBQUNULE1BQU0sRUFBRTtNQUNqQlUsT0FBTyxFQUFFZixXQUFXO01BQ3BCZ0IsVUFBVSxFQUFHQyxVQUFVLElBQUs7UUFDMUIsT0FBT2QsU0FBUyxHQUFHZSxJQUFJLENBQUNDLEdBQUcsQ0FBQyxDQUFDLEVBQUVGLFVBQVUsR0FBRyxDQUFDLENBQUM7TUFDaEQsQ0FBQztNQUNERyxjQUFjLEVBQUdDLEtBQUssSUFBSztRQUN6QixPQUFPUCxxQkFBVSxDQUFDUSxpQ0FBaUMsQ0FBQ0QsS0FBSyxDQUFDLElBQUtBLEtBQUssQ0FBQ1QsUUFBUSxJQUFJUyxLQUFLLENBQUNULFFBQVEsQ0FBQ1csTUFBTSxJQUFJLEdBQUk7TUFDaEg7SUFDRixDQUFDLENBQUM7SUFDRlYsY0FBYyxHQUFHLElBQUk7RUFDdkIsQ0FBQyxDQUFDLE9BQU9XLEdBQUcsRUFBRTtJQUNaO0lBQ0FDLE9BQU8sQ0FBQ0MsSUFBSSxDQUFDLCtEQUErRCxFQUFFRixHQUFHLElBQUlBLEdBQUcsQ0FBQ0csT0FBTyxHQUFHSCxHQUFHLENBQUNHLE9BQU8sR0FBR0gsR0FBRyxDQUFDO0VBQ3ZIO0VBRUEsSUFBSVgsY0FBYyxFQUFFO0lBQ2xCLElBQUk7TUFDRixNQUFNRCxRQUFRLEdBQUcsTUFBTVAsTUFBTSxDQUFDdUIsR0FBRyxDQUFDakMsWUFBWSxDQUFDO01BQy9DLE9BQU9pQixRQUFRLENBQUN4QixJQUFJO0lBQ3RCLENBQUMsQ0FBQyxPQUFPaUMsS0FBSyxFQUFFO01BQ2RJLE9BQU8sQ0FBQ0osS0FBSyxDQUFDLHNEQUFzRCxFQUFFQSxLQUFLLENBQUM7TUFDNUUsTUFBTSxJQUFJUSxLQUFLLENBQUMsK0JBQStCLENBQUM7SUFDbEQ7RUFDRjs7RUFFQTtFQUNBLElBQUlDLE9BQU8sR0FBRyxDQUFDO0VBQ2YsSUFBSUMsU0FBUyxHQUFHLElBQUk7RUFDcEIsT0FBT0QsT0FBTyxHQUFHOUIsV0FBVyxFQUFFO0lBQzVCLElBQUk7TUFDRjtNQUNBO01BQ0E7TUFDQSxNQUFNWSxRQUFRLEdBQUcsTUFBTU4sZ0JBQUssQ0FBQ3NCLEdBQUcsQ0FBQ2pDLFlBQVksQ0FBQztNQUM5QyxPQUFPaUIsUUFBUSxDQUFDeEIsSUFBSTtJQUN0QixDQUFDLENBQUMsT0FBT2lDLEtBQUssRUFBRTtNQUNkVSxTQUFTLEdBQUdWLEtBQUs7TUFDakJTLE9BQU8sSUFBSSxDQUFDO01BQ1osTUFBTUUsS0FBSyxHQUFHN0IsU0FBUyxHQUFHZSxJQUFJLENBQUNDLEdBQUcsQ0FBQyxDQUFDLEVBQUVXLE9BQU8sR0FBRyxDQUFDLENBQUM7TUFDbERMLE9BQU8sQ0FBQ0MsSUFBSSxDQUFDLDBCQUEwQkksT0FBTyxZQUFZVCxLQUFLLEVBQUVNLE9BQU8sSUFBSU4sS0FBSyxpQkFBaUJXLEtBQUssSUFBSSxDQUFDO01BQzVHLElBQUlGLE9BQU8sSUFBSTlCLFdBQVcsRUFBRTtNQUM1Qjs7TUFFQSxNQUFNLElBQUlpQyxPQUFPLENBQUVDLENBQUMsSUFBS0MsVUFBVSxDQUFDRCxDQUFDLEVBQUVGLEtBQUssQ0FBQyxDQUFDO0lBQ2hEO0VBQ0Y7RUFFQVAsT0FBTyxDQUFDSixLQUFLLENBQUMsNkRBQTZELEVBQUVVLFNBQVMsQ0FBQztFQUN2RixNQUFNLElBQUlGLEtBQUssQ0FBQywrQkFBK0IsQ0FBQztBQUNsRCIsImlnbm9yZUxpc3QiOltdfQ==