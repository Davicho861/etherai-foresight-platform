90e7d46cb7d77bcaeae9394d1ad5a755
"use strict";

var _server = require("../mocks/server.js");
const request = require('supertest');
const express = require('express');
describe('/api/demo routes', () => {
  beforeAll(() => {
    _server.server.listen({
      onUnhandledRequest: 'bypass'
    });
  });
  afterAll(() => {
    _server.server.close();
  });
  afterEach(() => {
    _server.server.resetHandlers();
    jest.resetModules();
    jest.restoreAllMocks();
    delete process.env.FORCE_MOCKS;
  });
  test('GET /full-state returns aggregated structure', async () => {
    await jest.isolateModulesAsync(async () => {
      // Mock prisma.moduleData.findMany to return some historical entries
      jest.doMock('../../src/prisma.js', () => ({
        moduleData: {
          findMany: jest.fn().mockResolvedValue([{
            timestamp: new Date('2025-04-01'),
            value: 90
          }, {
            timestamp: new Date('2025-05-01'),
            value: 92
          }, {
            timestamp: new Date('2025-06-01'),
            value: 91
          }])
        }
      }));
      const demoRouter = require('../../src/routes/demo.js');
      let router = demoRouter;
      if (router && router.default) router = router.default;
      const app = express();
      app.use('/api/demo', router);
      const res = await request(app).get('/api/demo/full-state').set('Host', 'localhost');
      expect(res.statusCode).toBe(200);
      expect(res.body.kpis).toBeDefined();
      expect(Array.isArray(res.body.countries)).toBe(true);
      expect(res.body.countries.length).toBeGreaterThan(0);
      expect(Array.isArray(res.body.chartData)).toBe(true);
    });
  });
  test('GET /mission-replays returns items from fallback when no chroma client', async () => {
    await jest.isolateModulesAsync(async () => {
      // Mock getChromaClient to return null so code reads local file
      jest.doMock('../../src/database.js', () => ({
        getChromaClient: jest.fn(() => null)
      }));

      // Mock fs/promises access and readFile
      jest.doMock('fs/promises', () => ({
        access: jest.fn().mockResolvedValue(true),
        readFile: jest.fn().mockResolvedValue(JSON.stringify({
          id: 'x'
        }) + '\n')
      }));
      const demoRouter = require('../../src/routes/demo.js');
      let router = demoRouter;
      if (router && router.default) router = router.default;
      const app = express();
      app.use('/api/demo', router);
      const res = await request(app).get('/api/demo/mission-replays').set('Host', 'localhost');
      expect(res.statusCode).toBe(200);
      expect(Array.isArray(res.body.taskReplays)).toBe(true);
      expect(res.body.taskReplays.length).toBeGreaterThanOrEqual(1);
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfc2VydmVyIiwicmVxdWlyZSIsInJlcXVlc3QiLCJleHByZXNzIiwiZGVzY3JpYmUiLCJiZWZvcmVBbGwiLCJzZXJ2ZXIiLCJsaXN0ZW4iLCJvblVuaGFuZGxlZFJlcXVlc3QiLCJhZnRlckFsbCIsImNsb3NlIiwiYWZ0ZXJFYWNoIiwicmVzZXRIYW5kbGVycyIsImplc3QiLCJyZXNldE1vZHVsZXMiLCJyZXN0b3JlQWxsTW9ja3MiLCJwcm9jZXNzIiwiZW52IiwiRk9SQ0VfTU9DS1MiLCJ0ZXN0IiwiaXNvbGF0ZU1vZHVsZXNBc3luYyIsImRvTW9jayIsIm1vZHVsZURhdGEiLCJmaW5kTWFueSIsImZuIiwibW9ja1Jlc29sdmVkVmFsdWUiLCJ0aW1lc3RhbXAiLCJEYXRlIiwidmFsdWUiLCJkZW1vUm91dGVyIiwicm91dGVyIiwiZGVmYXVsdCIsImFwcCIsInVzZSIsInJlcyIsImdldCIsInNldCIsImV4cGVjdCIsInN0YXR1c0NvZGUiLCJ0b0JlIiwiYm9keSIsImtwaXMiLCJ0b0JlRGVmaW5lZCIsIkFycmF5IiwiaXNBcnJheSIsImNvdW50cmllcyIsImxlbmd0aCIsInRvQmVHcmVhdGVyVGhhbiIsImNoYXJ0RGF0YSIsImdldENocm9tYUNsaWVudCIsImFjY2VzcyIsInJlYWRGaWxlIiwiSlNPTiIsInN0cmluZ2lmeSIsImlkIiwidGFza1JlcGxheXMiLCJ0b0JlR3JlYXRlclRoYW5PckVxdWFsIl0sInNvdXJjZXMiOlsiZGVtby5yb3V0ZS50ZXN0LmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHNlcnZlciB9IGZyb20gJy4uL21vY2tzL3NlcnZlci5qcyc7XG5jb25zdCByZXF1ZXN0ID0gcmVxdWlyZSgnc3VwZXJ0ZXN0Jyk7XG5jb25zdCBleHByZXNzID0gcmVxdWlyZSgnZXhwcmVzcycpO1xuXG5kZXNjcmliZSgnL2FwaS9kZW1vIHJvdXRlcycsICgpID0+IHtcbiAgYmVmb3JlQWxsKCgpID0+IHtcbiAgICBzZXJ2ZXIubGlzdGVuKHsgb25VbmhhbmRsZWRSZXF1ZXN0OiAnYnlwYXNzJyB9KTtcbiAgfSk7XG5cbiAgYWZ0ZXJBbGwoKCkgPT4ge1xuICAgIHNlcnZlci5jbG9zZSgpO1xuICB9KTtcblxuICBhZnRlckVhY2goKCkgPT4ge1xuICAgIHNlcnZlci5yZXNldEhhbmRsZXJzKCk7XG4gICAgamVzdC5yZXNldE1vZHVsZXMoKTtcbiAgICBqZXN0LnJlc3RvcmVBbGxNb2NrcygpO1xuICAgIGRlbGV0ZSBwcm9jZXNzLmVudi5GT1JDRV9NT0NLUztcbiAgfSk7XG5cbiAgdGVzdCgnR0VUIC9mdWxsLXN0YXRlIHJldHVybnMgYWdncmVnYXRlZCBzdHJ1Y3R1cmUnLCBhc3luYyAoKSA9PiB7XG4gICAgYXdhaXQgamVzdC5pc29sYXRlTW9kdWxlc0FzeW5jKGFzeW5jICgpID0+IHtcbiAgICAgIC8vIE1vY2sgcHJpc21hLm1vZHVsZURhdGEuZmluZE1hbnkgdG8gcmV0dXJuIHNvbWUgaGlzdG9yaWNhbCBlbnRyaWVzXG4gICAgICBqZXN0LmRvTW9jaygnLi4vLi4vc3JjL3ByaXNtYS5qcycsICgpID0+ICh7XG4gICAgICAgIG1vZHVsZURhdGE6IHtcbiAgICAgICAgICBmaW5kTWFueTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKFtcbiAgICAgICAgICAgIHsgdGltZXN0YW1wOiBuZXcgRGF0ZSgnMjAyNS0wNC0wMScpLCB2YWx1ZTogOTAgfSxcbiAgICAgICAgICAgIHsgdGltZXN0YW1wOiBuZXcgRGF0ZSgnMjAyNS0wNS0wMScpLCB2YWx1ZTogOTIgfSxcbiAgICAgICAgICAgIHsgdGltZXN0YW1wOiBuZXcgRGF0ZSgnMjAyNS0wNi0wMScpLCB2YWx1ZTogOTEgfVxuICAgICAgICAgIF0pXG4gICAgICAgIH1cbiAgICAgIH0pKTtcblxuICAgICAgY29uc3QgZGVtb1JvdXRlciA9IHJlcXVpcmUoJy4uLy4uL3NyYy9yb3V0ZXMvZGVtby5qcycpO1xuICAgICAgbGV0IHJvdXRlciA9IGRlbW9Sb3V0ZXI7XG4gICAgICBpZiAocm91dGVyICYmIHJvdXRlci5kZWZhdWx0KSByb3V0ZXIgPSByb3V0ZXIuZGVmYXVsdDtcblxuICAgICAgY29uc3QgYXBwID0gZXhwcmVzcygpO1xuICAgICAgYXBwLnVzZSgnL2FwaS9kZW1vJywgcm91dGVyKTtcblxuICAgICAgY29uc3QgcmVzID0gYXdhaXQgcmVxdWVzdChhcHApLmdldCgnL2FwaS9kZW1vL2Z1bGwtc3RhdGUnKS5zZXQoJ0hvc3QnLCAnbG9jYWxob3N0Jyk7XG4gICAgICBleHBlY3QocmVzLnN0YXR1c0NvZGUpLnRvQmUoMjAwKTtcbiAgICAgIGV4cGVjdChyZXMuYm9keS5rcGlzKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KEFycmF5LmlzQXJyYXkocmVzLmJvZHkuY291bnRyaWVzKSkudG9CZSh0cnVlKTtcbiAgICAgIGV4cGVjdChyZXMuYm9keS5jb3VudHJpZXMubGVuZ3RoKS50b0JlR3JlYXRlclRoYW4oMCk7XG4gICAgICBleHBlY3QoQXJyYXkuaXNBcnJheShyZXMuYm9keS5jaGFydERhdGEpKS50b0JlKHRydWUpO1xuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdHRVQgL21pc3Npb24tcmVwbGF5cyByZXR1cm5zIGl0ZW1zIGZyb20gZmFsbGJhY2sgd2hlbiBubyBjaHJvbWEgY2xpZW50JywgYXN5bmMgKCkgPT4ge1xuICAgIGF3YWl0IGplc3QuaXNvbGF0ZU1vZHVsZXNBc3luYyhhc3luYyAoKSA9PiB7XG4gICAgICAvLyBNb2NrIGdldENocm9tYUNsaWVudCB0byByZXR1cm4gbnVsbCBzbyBjb2RlIHJlYWRzIGxvY2FsIGZpbGVcbiAgICAgIGplc3QuZG9Nb2NrKCcuLi8uLi9zcmMvZGF0YWJhc2UuanMnLCAoKSA9PiAoeyBnZXRDaHJvbWFDbGllbnQ6IGplc3QuZm4oKCkgPT4gbnVsbCkgfSkpO1xuXG4gICAgICAvLyBNb2NrIGZzL3Byb21pc2VzIGFjY2VzcyBhbmQgcmVhZEZpbGVcbiAgICAgIGplc3QuZG9Nb2NrKCdmcy9wcm9taXNlcycsICgpID0+ICh7XG4gICAgICAgIGFjY2VzczogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHRydWUpLFxuICAgICAgICByZWFkRmlsZTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKEpTT04uc3RyaW5naWZ5KHsgaWQ6ICd4JyB9KSArICdcXG4nKVxuICAgICAgfSkpO1xuXG4gICAgICBjb25zdCBkZW1vUm91dGVyID0gcmVxdWlyZSgnLi4vLi4vc3JjL3JvdXRlcy9kZW1vLmpzJyk7XG4gICAgICBsZXQgcm91dGVyID0gZGVtb1JvdXRlcjtcbiAgICAgIGlmIChyb3V0ZXIgJiYgcm91dGVyLmRlZmF1bHQpIHJvdXRlciA9IHJvdXRlci5kZWZhdWx0O1xuXG4gICAgICBjb25zdCBhcHAgPSBleHByZXNzKCk7XG4gICAgICBhcHAudXNlKCcvYXBpL2RlbW8nLCByb3V0ZXIpO1xuXG4gICAgICBjb25zdCByZXMgPSBhd2FpdCByZXF1ZXN0KGFwcCkuZ2V0KCcvYXBpL2RlbW8vbWlzc2lvbi1yZXBsYXlzJykuc2V0KCdIb3N0JywgJ2xvY2FsaG9zdCcpO1xuICAgICAgZXhwZWN0KHJlcy5zdGF0dXNDb2RlKS50b0JlKDIwMCk7XG4gICAgICBleHBlY3QoQXJyYXkuaXNBcnJheShyZXMuYm9keS50YXNrUmVwbGF5cykpLnRvQmUodHJ1ZSk7XG4gICAgICBleHBlY3QocmVzLmJvZHkudGFza1JlcGxheXMubGVuZ3RoKS50b0JlR3JlYXRlclRoYW5PckVxdWFsKDEpO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl0sIm1hcHBpbmdzIjoiOztBQUFBLElBQUFBLE9BQUEsR0FBQUMsT0FBQTtBQUNBLE1BQU1DLE9BQU8sR0FBR0QsT0FBTyxDQUFDLFdBQVcsQ0FBQztBQUNwQyxNQUFNRSxPQUFPLEdBQUdGLE9BQU8sQ0FBQyxTQUFTLENBQUM7QUFFbENHLFFBQVEsQ0FBQyxrQkFBa0IsRUFBRSxNQUFNO0VBQ2pDQyxTQUFTLENBQUMsTUFBTTtJQUNkQyxjQUFNLENBQUNDLE1BQU0sQ0FBQztNQUFFQyxrQkFBa0IsRUFB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