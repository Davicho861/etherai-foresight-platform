c05d0b943595ec508986aeae2dce6162
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
var _resilience = require("../utils/resilience.js");
var _safeFetch = _interopRequireDefault(require("../lib/safeFetch.js"));
var _forceMocks = require("../lib/force-mocks.js");
function _interopRequireDefault(e) { return e && e.__esModule ? e : { default: e }; }
class GdeltIntegration {
  constructor() {
    const native = process.env.NATIVE_DEV_MODE === 'true' || process.env.FORCE_MOCKS === 'true';
    const gdeltMockPort = process.env.GDELT_MOCK_PORT || 4020;
    this.baseUrl = native ? `http://localhost:${gdeltMockPort}/gdelt/events` : process.env.TEST_MODE === 'true' ? 'http://mock-api-server:3001/gdelt' // internal mock server used in CI
    : 'https://api.gdeltproject.org/api/v2/doc/doc';
    // Debug: log which baseUrl is being used to help troubleshoot native dev mode

    console.log(`[GdeltIntegration] NATIVE_DEV_MODE=${process.env.NATIVE_DEV_MODE}; using baseUrl=${this.baseUrl}`);
    // Use shorter circuit breaker window in tests to avoid long waits/logs
    const isTest = process.env.NODE_ENV === 'test' || process.env.TEST_MODE === 'true';
    this.circuitBreaker = new _resilience.CircuitBreaker(isTest ? 1 : 5, isTest ? 1000 : 600000); // failures, recovery ms
  }
  async getSocialEvents(country, startDate, endDate) {
    // Check if FORCE_MOCKS is enabled for testing
    if ((0, _forceMocks.forceMocksEnabled)()) {
      return this.getMockSocialEvents(country, startDate, endDate);
    }

    // PRAEVISIO ELITE EXPERIENCE: ZERO MOCKS ALLOWED
    // La belleza sin verdad es una ilusión. Los datos sin explicación son ruido.
    // Esta integración siempre intenta obtener datos reales, nunca usa mocks.

    try {
      const result = await this.circuitBreaker.execute(async () => {
        // Reduce retries/delays when running tests to keep test suites fast and deterministic
        const isTest = process.env.NODE_ENV === 'test' || process.env.TEST_MODE === 'true' || process.env.CI === 'true';
        const retries = isTest ? 1 : 3;
        const baseDelay = isTest ? 50 : 5000; // ms
        const maxDelay = isTest ? 200 : 30000; // ms

        return await (0, _resilience.retryWithBackoff)(async () => {
          // GDELT API query for social unrest events
          // Using keywords like protest, riot, etc.
          const query = `(protest OR riot OR strike OR demonstration)`;
          // GDELT expects two-letter country codes in many queries; map common ISO3 -> ISO2
          const iso3ToIso2 = iso3 => {
            if (!iso3) return '';
            const map = {
              COL: 'CO',
              PER: 'PE',
              BRA: 'BR',
              MEX: 'MX',
              ARG: 'AR',
              CHL: 'CL'
            };
            const c = String(iso3).toUpperCase();
            return map[c] || c.slice(0, 2);
          };
          const countryFilter = `sourcecountry:${iso3ToIso2(country)}`;
          const startDateTime = startDate.replace(/-/g, '') + '000000';
          const endDateTime = endDate.replace(/-/g, '') + '235959';
          const url = `${this.baseUrl}?query=${encodeURIComponent(`${query} ${countryFilter}`)}&startdatetime=${startDateTime}&enddatetime=${endDateTime}&mode=artlist&format=json&maxrecords=250`;

          // Use safeFetch to get parsed JSON with retries and timeout. Add Accept header to favor JSON responses.
          let data;
          try {
            data = await (0, _safeFetch.default)(url, {
              headers: {
                'User-Agent': 'Praevisio/1.0 (+https://praevisio.local)',
                Accept: 'application/json'
              }
            }, {
              timeout: 20000,
              retries
            });
          } catch (err) {
            // convert known cases into expressive errors for retry logic
            if (err.message && err.message.includes('429')) {
              throw new Error(`GDELT API rate limit exceeded: ${err.message}`);
            }
            throw err;
          }

          // Validate data structure
          if (!data || typeof data !== 'object') {
            throw new Error('GDELT API returned invalid data structure');
          }

          // Process articles to count events
          const events = data.articles || [];
          const eventCount = events.length;

          // Calculate intensity based on number of articles and themes
          let intensity = 0;
          events.forEach(article => {
            if (article.themes) {
              const themes = article.themes.split(';');
              if (themes.includes('PROTEST')) intensity += 2;
              if (themes.includes('RIOT')) intensity += 3;
              if (themes.includes('STRIKE')) intensity += 1.5;
              if (themes.includes('DEMONSTRATION')) intensity += 1;
            }
          });
          return {
            country,
            period: {
              start: startDate,
              end: endDate
            },
            eventCount,
            socialIntensity: intensity,
            articles: events.slice(0, 10),
            // Top 10 articles
            isMock: false
          };
        }, retries, baseDelay, maxDelay); // configurable retries/delays (shorter in tests)
      });
      return result;
    } catch (error) {
      console.log(`GDELT API failed for ${country} (${startDate}-${endDate}): ${error.message}.`);

      // Check if FORCE_MOCKS is enabled for fallback in tests
      if ((0, _forceMocks.forceMocksEnabled)()) {
        return this.getMockSocialEvents(country, startDate, endDate);
      }

      // PRAEVISIO ELITE EXPERIENCE: ZERO MOCKS ALLOWED
      // Si falla la API real, propagar el error - no usar mocks
      throw new Error(`GDELT API failed for ${country} (${startDate}-${endDate}): ${error && error.message ? error.message : 'Unknown error'}`);
    }
  }

  // High-fidelity mock data for fallback when API fails
  getMockSocialEvents(country, startDate, endDate) {
    const mockEvents = [{
      id: 'mock-event-1',
      date: startDate,
      country: country,
      type: 'protest',
      themes: 'PROTEST;DEMONSTRATION',
      title: 'Mock Social Protest Event',
      url: 'https://example.com/mock-event-1'
    }, {
      id: 'mock-event-2',
      date: endDate,
      country: country,
      type: 'strike',
      themes: 'STRIKE;LABOR',
      title: 'Mock Labor Strike Event',
      url: 'https://example.com/mock-event-2'
    }];

    // Calculate intensity based on mock events
    let intensity = 0;
    mockEvents.forEach(event => {
      if (event.themes) {
        const themes = event.themes.split(';');
        if (themes.includes('PROTEST')) intensity += 2;
        if (themes.includes('RIOT')) intensity += 3;
        if (themes.includes('STRIKE')) intensity += 1.5;
        if (themes.includes('DEMONSTRATION')) intensity += 1;
      }
    });
    return {
      country,
      period: {
        start: startDate,
        end: endDate
      },
      eventCount: mockEvents.length,
      socialIntensity: intensity,
      articles: mockEvents.slice(0, 10),
      isMock: true,
      note: 'High-fidelity mock data - API unavailable'
    };
  }
}
var _default = exports.default = GdeltIntegration;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfcmVzaWxpZW5jZSIsInJlcXVpcmUiLCJfc2FmZUZldGNoIiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsIl9mb3JjZU1vY2tzIiwiZSIsIl9fZXNNb2R1bGUiLCJkZWZhdWx0IiwiR2RlbHRJbnRlZ3JhdGlvbiIsImNvbnN0cnVjdG9yIiwibmF0aXZlIiwicHJvY2VzcyIsImVudiIsIk5BVElWRV9ERVZfTU9ERSIsIkZPUkNFX01PQ0tTIiwiZ2RlbHRNb2NrUG9ydCIsIkdERUxUX01PQ0tfUE9SVCIsImJhc2VVcmwiLCJURVNUX01PREUiLCJjb25zb2xlIiwibG9nIiwiaXNUZXN0IiwiTk9ERV9FTlYiLCJjaXJjdWl0QnJlYWtlciIsIkNpcmN1aXRCcmVha2VyIiwiZ2V0U29jaWFsRXZlbnRzIiwiY291bnRyeSIsInN0YXJ0RGF0ZSIsImVuZERhdGUiLCJmb3JjZU1vY2tzRW5hYmxlZCIsImdldE1vY2tTb2NpYWxFdmVudHMiLCJyZXN1bHQiLCJleGVjdXRlIiwiQ0kiLCJyZXRyaWVzIiwiYmFzZURlbGF5IiwibWF4RGVsYXkiLCJyZXRyeVdpdGhCYWNrb2ZmIiwicXVlcnkiLCJpc28zVG9Jc28yIiwiaXNvMyIsIm1hcCIsIkNPTCIsIlBFUiIsIkJSQSIsIk1FWCIsIkFSRyIsIkNITCIsImMiLCJTdHJpbmciLCJ0b1VwcGVyQ2FzZSIsInNsaWNlIiwiY291bnRyeUZpbHRlciIsInN0YXJ0RGF0ZVRpbWUiLCJyZXBsYWNlIiwiZW5kRGF0ZVRpbWUiLCJ1cmwiLCJlbmNvZGVVUklDb21wb25lbnQiLCJkYXRhIiwic2FmZUZldGNoIiwiaGVhZGVycyIsIkFjY2VwdCIsInRpbWVvdXQiLCJlcnIiLCJtZXNzYWdlIiwiaW5jbHVkZXMiLCJFcnJvciIsImV2ZW50cyIsImFydGljbGVzIiwiZXZlbnRDb3VudCIsImxlbmd0aCIsImludGVuc2l0eSIsImZvckVhY2giLCJhcnRpY2xlIiwidGhlbWVzIiwic3BsaXQiLCJwZXJpb2QiLCJzdGFydCIsImVuZCIsInNvY2lhbEludGVuc2l0eSIsImlzTW9jayIsImVycm9yIiwibW9ja0V2ZW50cyIsImlkIiwiZGF0ZSIsInR5cGUiLCJ0aXRsZSIsImV2ZW50Iiwibm90ZSIsIl9kZWZhdWx0IiwiZXhwb3J0cyJdLCJzb3VyY2VzIjpbIkdkZWx0SW50ZWdyYXRpb24uanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ2lyY3VpdEJyZWFrZXIsIHJldHJ5V2l0aEJhY2tvZmYsIGZldGNoV2l0aFRpbWVvdXQsIGlzSnNvblJlc3BvbnNlIH0gZnJvbSAnLi4vdXRpbHMvcmVzaWxpZW5jZS5qcyc7XG5pbXBvcnQgc2FmZUZldGNoIGZyb20gJy4uL2xpYi9zYWZlRmV0Y2guanMnO1xuaW1wb3J0IHsgZm9yY2VNb2Nrc0VuYWJsZWQgfSBmcm9tICcuLi9saWIvZm9yY2UtbW9ja3MuanMnO1xuXG5jbGFzcyBHZGVsdEludGVncmF0aW9uIHtcbiAgY29uc3RydWN0b3IoKSB7XG4gICAgY29uc3QgbmF0aXZlID0gcHJvY2Vzcy5lbnYuTkFUSVZFX0RFVl9NT0RFID09PSAndHJ1ZScgfHwgcHJvY2Vzcy5lbnYuRk9SQ0VfTU9DS1MgPT09ICd0cnVlJztcbiAgICBjb25zdCBnZGVsdE1vY2tQb3J0ID0gcHJvY2Vzcy5lbnYuR0RFTFRfTU9DS19QT1JUIHx8IDQwMjA7XG4gICAgdGhpcy5iYXNlVXJsID0gbmF0aXZlXG4gICAgICA/IGBodHRwOi8vbG9jYWxob3N0OiR7Z2RlbHRNb2NrUG9ydH0vZ2RlbHQvZXZlbnRzYFxuICAgICAgOiAocHJvY2Vzcy5lbnYuVEVTVF9NT0RFID09PSAndHJ1ZSdcbiAgICAgICAgPyAnaHR0cDovL21vY2stYXBpLXNlcnZlcjozMDAxL2dkZWx0JyAvLyBpbnRlcm5hbCBtb2NrIHNlcnZlciB1c2VkIGluIENJXG4gICAgICAgIDogJ2h0dHBzOi8vYXBpLmdkZWx0cHJvamVjdC5vcmcvYXBpL3YyL2RvYy9kb2MnKTtcbiAgICAvLyBEZWJ1ZzogbG9nIHdoaWNoIGJhc2VVcmwgaXMgYmVpbmcgdXNlZCB0byBoZWxwIHRyb3VibGVzaG9vdCBuYXRpdmUgZGV2IG1vZGVcblxuICAgIGNvbnNvbGUubG9nKGBbR2RlbHRJbnRlZ3JhdGlvbl0gTkFUSVZFX0RFVl9NT0RFPSR7cHJvY2Vzcy5lbnYuTkFUSVZFX0RFVl9NT0RFfTsgdXNpbmcgYmFzZVVybD0ke3RoaXMuYmFzZVVybH1gKTtcbiAgICAvLyBVc2Ugc2hvcnRlciBjaXJjdWl0IGJyZWFrZXIgd2luZG93IGluIHRlc3RzIHRvIGF2b2lkIGxvbmcgd2FpdHMvbG9nc1xuICAgIGNvbnN0IGlzVGVzdCA9IHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAndGVzdCcgfHwgcHJvY2Vzcy5lbnYuVEVTVF9NT0RFID09PSAndHJ1ZSc7XG4gICAgdGhpcy5jaXJjdWl0QnJlYWtlciA9IG5ldyBDaXJjdWl0QnJlYWtlcihpc1Rlc3QgPyAxIDogNSwgaXNUZXN0ID8gMTAwMCA6IDYwMDAwMCk7IC8vIGZhaWx1cmVzLCByZWNvdmVyeSBtc1xuICB9XG5cbiAgYXN5bmMgZ2V0U29jaWFsRXZlbnRzKGNvdW50cnksIHN0YXJ0RGF0ZSwgZW5kRGF0ZSkge1xuICAgIC8vIENoZWNrIGlmIEZPUkNFX01PQ0tTIGlzIGVuYWJsZWQgZm9yIHRlc3RpbmdcbiAgICBpZiAoZm9yY2VNb2Nrc0VuYWJsZWQoKSkge1xuICAgICAgcmV0dXJuIHRoaXMuZ2V0TW9ja1NvY2lhbEV2ZW50cyhjb3VudHJ5LCBzdGFydERhdGUsIGVuZERhdGUpO1xuICAgIH1cblxuICAgIC8vIFBSQUVWSVNJTyBFTElURSBFWFBFUklFTkNFOiBaRVJPIE1PQ0tTIEFMTE9XRURcbiAgICAvLyBMYSBiZWxsZXphIHNpbiB2ZXJkYWQgZXMgdW5hIGlsdXNpw7NuLiBMb3MgZGF0b3Mgc2luIGV4cGxpY2FjacOzbiBzb24gcnVpZG8uXG4gICAgLy8gRXN0YSBpbnRlZ3JhY2nDs24gc2llbXByZSBpbnRlbnRhIG9idGVuZXIgZGF0b3MgcmVhbGVzLCBudW5jYSB1c2EgbW9ja3MuXG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5jaXJjdWl0QnJlYWtlci5leGVjdXRlKGFzeW5jICgpID0+IHtcbiAgICAgICAgLy8gUmVkdWNlIHJldHJpZXMvZGVsYXlzIHdoZW4gcnVubmluZyB0ZXN0cyB0byBrZWVwIHRlc3Qgc3VpdGVzIGZhc3QgYW5kIGRldGVybWluaXN0aWNcbiAgICAgICAgY29uc3QgaXNUZXN0ID0gcHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09ICd0ZXN0JyB8fCBwcm9jZXNzLmVudi5URVNUX01PREUgPT09ICd0cnVlJyB8fCBwcm9jZXNzLmVudi5DSSA9PT0gJ3RydWUnO1xuICAgICAgICBjb25zdCByZXRyaWVzID0gaXNUZXN0ID8gMSA6IDM7XG4gICAgICAgIGNvbnN0IGJhc2VEZWxheSA9IGlzVGVzdCA/IDUwIDogNTAwMDsgLy8gbXNcbiAgICAgICAgY29uc3QgbWF4RGVsYXkgPSBpc1Rlc3QgPyAyMDAgOiAzMDAwMDsgLy8gbXNcblxuICAgICAgICByZXR1cm4gYXdhaXQgcmV0cnlXaXRoQmFja29mZihhc3luYyAoKSA9PiB7XG4gICAgICAgICAgLy8gR0RFTFQgQVBJIHF1ZXJ5IGZvciBzb2NpYWwgdW5yZXN0IGV2ZW50c1xuICAgICAgICAgIC8vIFVzaW5nIGtleXdvcmRzIGxpa2UgcHJvdGVzdCwgcmlvdCwgZXRjLlxuICAgICAgICAgIGNvbnN0IHF1ZXJ5ID0gYChwcm90ZXN0IE9SIHJpb3QgT1Igc3RyaWtlIE9SIGRlbW9uc3RyYXRpb24pYDtcbiAgICAgICAgICAvLyBHREVMVCBleHBlY3RzIHR3by1sZXR0ZXIgY291bnRyeSBjb2RlcyBpbiBtYW55IHF1ZXJpZXM7IG1hcCBjb21tb24gSVNPMyAtPiBJU08yXG4gICAgICAgICAgY29uc3QgaXNvM1RvSXNvMiA9IChpc28zKSA9PiB7XG4gICAgICAgICAgICBpZiAoIWlzbzMpIHJldHVybiAnJztcbiAgICAgICAgICAgIGNvbnN0IG1hcCA9IHtcbiAgICAgICAgICAgICAgQ09MOiAnQ08nLCBQRVI6ICdQRScsIEJSQTogJ0JSJywgTUVYOiAnTVgnLCBBUkc6ICdBUicsIENITDogJ0NMJ1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGNvbnN0IGMgPSBTdHJpbmcoaXNvMykudG9VcHBlckNhc2UoKTtcbiAgICAgICAgICAgIHJldHVybiBtYXBbY10gfHwgYy5zbGljZSgwLCAyKTtcbiAgICAgICAgICB9O1xuICAgICAgICAgIGNvbnN0IGNvdW50cnlGaWx0ZXIgPSBgc291cmNlY291bnRyeToke2lzbzNUb0lzbzIoY291bnRyeSl9YDtcblxuICAgICAgICAgIGNvbnN0IHN0YXJ0RGF0ZVRpbWUgPSBzdGFydERhdGUucmVwbGFjZSgvLS9nLCAnJykgKyAnMDAwMDAwJztcbiAgICAgICAgICBjb25zdCBlbmREYXRlVGltZSA9IGVuZERhdGUucmVwbGFjZSgvLS9nLCAnJykgKyAnMjM1OTU5JztcblxuICAgICAgICAgIGNvbnN0IHVybCA9IGAke3RoaXMuYmFzZVVybH0/cXVlcnk9JHtlbmNvZGVVUklDb21wb25lbnQoYCR7cXVlcnl9ICR7Y291bnRyeUZpbHRlcn1gKX0mc3RhcnRkYXRldGltZT0ke3N0YXJ0RGF0ZVRpbWV9JmVuZGRhdGV0aW1lPSR7ZW5kRGF0ZVRpbWV9Jm1vZGU9YXJ0bGlzdCZmb3JtYXQ9anNvbiZtYXhyZWNvcmRzPTI1MGA7XG5cbiAgICAgICAgICAvLyBVc2Ugc2FmZUZldGNoIHRvIGdldCBwYXJzZWQgSlNPTiB3aXRoIHJldHJpZXMgYW5kIHRpbWVvdXQuIEFkZCBBY2NlcHQgaGVhZGVyIHRvIGZhdm9yIEpTT04gcmVzcG9uc2VzLlxuICAgICAgICAgIGxldCBkYXRhO1xuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICBkYXRhID0gYXdhaXQgc2FmZUZldGNoKHVybCwgeyBoZWFkZXJzOiB7ICdVc2VyLUFnZW50JzogJ1ByYWV2aXNpby8xLjAgKCtodHRwczovL3ByYWV2aXNpby5sb2NhbCknLCBBY2NlcHQ6ICdhcHBsaWNhdGlvbi9qc29uJyB9IH0sIHsgdGltZW91dDogMjAwMDAsIHJldHJpZXMgfSk7XG4gICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICAvLyBjb252ZXJ0IGtub3duIGNhc2VzIGludG8gZXhwcmVzc2l2ZSBlcnJvcnMgZm9yIHJldHJ5IGxvZ2ljXG4gICAgICAgICAgICBpZiAoZXJyLm1lc3NhZ2UgJiYgZXJyLm1lc3NhZ2UuaW5jbHVkZXMoJzQyOScpKSB7XG4gICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgR0RFTFQgQVBJIHJhdGUgbGltaXQgZXhjZWVkZWQ6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgLy8gVmFsaWRhdGUgZGF0YSBzdHJ1Y3R1cmVcbiAgICAgICAgICBpZiAoIWRhdGEgfHwgdHlwZW9mIGRhdGEgIT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0dERUxUIEFQSSByZXR1cm5lZCBpbnZhbGlkIGRhdGEgc3RydWN0dXJlJyk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgLy8gUHJvY2VzcyBhcnRpY2xlcyB0byBjb3VudCBldmVudHNcbiAgICAgICAgICBjb25zdCBldmVudHMgPSBkYXRhLmFydGljbGVzIHx8IFtdO1xuICAgICAgICAgIGNvbnN0IGV2ZW50Q291bnQgPSBldmVudHMubGVuZ3RoO1xuXG4gICAgICAgICAgLy8gQ2FsY3VsYXRlIGludGVuc2l0eSBiYXNlZCBvbiBudW1iZXIgb2YgYXJ0aWNsZXMgYW5kIHRoZW1lc1xuICAgICAgICAgIGxldCBpbnRlbnNpdHkgPSAwO1xuICAgICAgICAgIGV2ZW50cy5mb3JFYWNoKGFydGljbGUgPT4ge1xuICAgICAgICAgICAgaWYgKGFydGljbGUudGhlbWVzKSB7XG4gICAgICAgICAgICAgIGNvbnN0IHRoZW1lcyA9IGFydGljbGUudGhlbWVzLnNwbGl0KCc7Jyk7XG4gICAgICAgICAgICAgIGlmICh0aGVtZXMuaW5jbHVkZXMoJ1BST1RFU1QnKSkgaW50ZW5zaXR5ICs9IDI7XG4gICAgICAgICAgICAgIGlmICh0aGVtZXMuaW5jbHVkZXMoJ1JJT1QnKSkgaW50ZW5zaXR5ICs9IDM7XG4gICAgICAgICAgICAgIGlmICh0aGVtZXMuaW5jbHVkZXMoJ1NUUklLRScpKSBpbnRlbnNpdHkgKz0gMS41O1xuICAgICAgICAgICAgICBpZiAodGhlbWVzLmluY2x1ZGVzKCdERU1PTlNUUkFUSU9OJykpIGludGVuc2l0eSArPSAxO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGNvdW50cnksXG4gICAgICAgICAgICBwZXJpb2Q6IHsgc3RhcnQ6IHN0YXJ0RGF0ZSwgZW5kOiBlbmREYXRlIH0sXG4gICAgICAgICAgICBldmVudENvdW50LFxuICAgICAgICAgICAgc29jaWFsSW50ZW5zaXR5OiBpbnRlbnNpdHksXG4gICAgICAgICAgICBhcnRpY2xlczogZXZlbnRzLnNsaWNlKDAsIDEwKSwgLy8gVG9wIDEwIGFydGljbGVzXG4gICAgICAgICAgICBpc01vY2s6IGZhbHNlXG4gICAgICAgICAgfTtcbiAgICAgICAgfSwgcmV0cmllcywgYmFzZURlbGF5LCBtYXhEZWxheSk7IC8vIGNvbmZpZ3VyYWJsZSByZXRyaWVzL2RlbGF5cyAoc2hvcnRlciBpbiB0ZXN0cylcbiAgICAgIH0pO1xuXG4gICAgICByZXR1cm4gcmVzdWx0O1xuXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUubG9nKGBHREVMVCBBUEkgZmFpbGVkIGZvciAke2NvdW50cnl9ICgke3N0YXJ0RGF0ZX0tJHtlbmREYXRlfSk6ICR7ZXJyb3IubWVzc2FnZX0uYCk7XG5cbiAgICAgIC8vIENoZWNrIGlmIEZPUkNFX01PQ0tTIGlzIGVuYWJsZWQgZm9yIGZhbGxiYWNrIGluIHRlc3RzXG4gICAgICBpZiAoZm9yY2VNb2Nrc0VuYWJsZWQoKSkge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRNb2NrU29jaWFsRXZlbnRzKGNvdW50cnksIHN0YXJ0RGF0ZSwgZW5kRGF0ZSk7XG4gICAgICB9XG5cbiAgICAgIC8vIFBSQUVWSVNJTyBFTElURSBFWFBFUklFTkNFOiBaRVJPIE1PQ0tTIEFMTE9XRURcbiAgICAgIC8vIFNpIGZhbGxhIGxhIEFQSSByZWFsLCBwcm9wYWdhciBlbCBlcnJvciAtIG5vIHVzYXIgbW9ja3NcbiAgICAgIHRocm93IG5ldyBFcnJvcihgR0RFTFQgQVBJIGZhaWxlZCBmb3IgJHtjb3VudHJ5fSAoJHtzdGFydERhdGV9LSR7ZW5kRGF0ZX0pOiAke2Vycm9yICYmIGVycm9yLm1lc3NhZ2UgPyBlcnJvci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InfWApO1xuICAgIH1cbiAgfVxuXG4gIC8vIEhpZ2gtZmlkZWxpdHkgbW9jayBkYXRhIGZvciBmYWxsYmFjayB3aGVuIEFQSSBmYWlsc1xuICBnZXRNb2NrU29jaWFsRXZlbnRzKGNvdW50cnksIHN0YXJ0RGF0ZSwgZW5kRGF0ZSkge1xuICAgIGNvbnN0IG1vY2tFdmVudHMgPSBbXG4gICAgICB7XG4gICAgICAgIGlkOiAnbW9jay1ldmVudC0xJyxcbiAgICAgICAgZGF0ZTogc3RhcnREYXRlLFxuICAgICAgICBjb3VudHJ5OiBjb3VudHJ5LFxuICAgICAgICB0eXBlOiAncHJvdGVzdCcsXG4gICAgICAgIHRoZW1lczogJ1BST1RFU1Q7REVNT05TVFJBVElPTicsXG4gICAgICAgIHRpdGxlOiAnTW9jayBTb2NpYWwgUHJvdGVzdCBFdmVudCcsXG4gICAgICAgIHVybDogJ2h0dHBzOi8vZXhhbXBsZS5jb20vbW9jay1ldmVudC0xJ1xuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgaWQ6ICdtb2NrLWV2ZW50LTInLFxuICAgICAgICBkYXRlOiBlbmREYXRlLFxuICAgICAgICBjb3VudHJ5OiBjb3VudHJ5LFxuICAgICAgICB0eXBlOiAnc3RyaWtlJyxcbiAgICAgICAgdGhlbWVzOiAnU1RSSUtFO0xBQk9SJyxcbiAgICAgICAgdGl0bGU6ICdNb2NrIExhYm9yIFN0cmlrZSBFdmVudCcsXG4gICAgICAgIHVybDogJ2h0dHBzOi8vZXhhbXBsZS5jb20vbW9jay1ldmVudC0yJ1xuICAgICAgfVxuICAgIF07XG5cbiAgICAvLyBDYWxjdWxhdGUgaW50ZW5zaXR5IGJhc2VkIG9uIG1vY2sgZXZlbnRzXG4gICAgbGV0IGludGVuc2l0eSA9IDA7XG4gICAgbW9ja0V2ZW50cy5mb3JFYWNoKGV2ZW50ID0+IHtcbiAgICAgIGlmIChldmVudC50aGVtZXMpIHtcbiAgICAgICAgY29uc3QgdGhlbWVzID0gZXZlbnQudGhlbWVzLnNwbGl0KCc7Jyk7XG4gICAgICAgIGlmICh0aGVtZXMuaW5jbHVkZXMoJ1BST1RFU1QnKSkgaW50ZW5zaXR5ICs9IDI7XG4gICAgICAgIGlmICh0aGVtZXMuaW5jbHVkZXMoJ1JJT1QnKSkgaW50ZW5zaXR5ICs9IDM7XG4gICAgICAgIGlmICh0aGVtZXMuaW5jbHVkZXMoJ1NUUklLRScpKSBpbnRlbnNpdHkgKz0gMS41O1xuICAgICAgICBpZiAodGhlbWVzLmluY2x1ZGVzKCdERU1PTlNUUkFUSU9OJykpIGludGVuc2l0eSArPSAxO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIGNvdW50cnksXG4gICAgICBwZXJpb2Q6IHsgc3RhcnQ6IHN0YXJ0RGF0ZSwgZW5kOiBlbmREYXRlIH0sXG4gICAgICBldmVudENvdW50OiBtb2NrRXZlbnRzLmxlbmd0aCxcbiAgICAgIHNvY2lhbEludGVuc2l0eTogaW50ZW5zaXR5LFxuICAgICAgYXJ0aWNsZXM6IG1vY2tFdmVudHMuc2xpY2UoMCwgMTApLFxuICAgICAgaXNNb2NrOiB0cnVlLFxuICAgICAgbm90ZTogJ0hpZ2gtZmlkZWxpdHkgbW9jayBkYXRhIC0gQVBJIHVuYXZhaWxhYmxlJ1xuICAgIH07XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgR2RlbHRJbnRlZ3JhdGlvbjsiXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLElBQUFBLFdB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