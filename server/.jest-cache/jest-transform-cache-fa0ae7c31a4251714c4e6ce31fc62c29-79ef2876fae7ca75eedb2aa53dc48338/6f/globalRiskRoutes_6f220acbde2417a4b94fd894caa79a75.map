{"version":3,"names":["_express","_interopRequireDefault","require","_path","e","__esModule","default","_interopRequireWildcard","t","WeakMap","r","n","o","i","f","__proto__","has","get","set","hasOwnProperty","call","Object","defineProperty","getOwnPropertyDescriptor","__dirname","path","resolve","process","cwd","router","express","Router","safeLoad","modulePath","fullPath","module","specifier","Promise","then","s","error","console","Error","req","res","getFoodSecurityIndex","data","status","json","success","source","message","cryptoIds","query","cryptoList","split","map","id","trim","getCryptoMarketAnalysis","serviceData","volatilityIndex","undefined","value","unit","topic","timestamp","Date","toISOString","getClimateExtremesIndex","countries","days","countryList","Array","isArray","c","filter","Boolean","getCommunityResilienceIndex","Number","avg","globalResilienceAssessment","averageResilience","Math","round","resilienceAnalysis","focusAreas","timeHorizon","detailLevel","language","getRiskIndices","riskData","generatePredictiveNarrative","options","a","narrative","_default","exports"],"sources":["globalRiskRoutes.js"],"sourcesContent":["import express from 'express';\nimport path from 'path';\n\n// Resolve a stable __dirname for this module in both ESM and CommonJS\n// test environments. Some test runners (Jest + babel-jest) may not\n// support `import.meta.url` during transformation, which causes\n// \"Cannot use 'import.meta' outside a module\" errors. To avoid that\n// and keep module resolution deterministic, use the repository's\n// `src/routes` folder as base when import.meta is unavailable.\nconst __dirname = path.resolve(process.cwd(), 'src', 'routes');\nconst router = express.Router();\n\n// Helper to dynamically load a module\nasync function safeLoad(modulePath) {\n  try {\n    const fullPath = path.resolve(__dirname, modulePath);\n    const module = await import(fullPath);\n    return module.default || module;\n  } catch (error) {\n    console.error(`Error loading module ${modulePath}:`, error);\n    throw new Error(`Failed to load module: ${modulePath}`);\n  }\n}\n\n// GET /api/global-risk/food-security \nrouter.get('/food-security', async (req, res) => {\n  try {\n    const { getFoodSecurityIndex } = await safeLoad('../services/foodSecurityService.js');\n    const data = await getFoodSecurityIndex();\n    \n    res.status(200).json({\n      success: true,\n      source: 'Praevisio-Aion-Simulated-WorldBank',\n      data\n    });\n  } catch (error) {\n    console.error('Error retrieving food security data:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Internal Server Error: Could not retrieve food security data.'\n    });\n  }\n});\n\n// GET /api/global-risk/crypto-volatility\nrouter.get('/crypto-volatility', async (req, res) => {\n  try {\n    const { cryptoIds = 'bitcoin,ethereum' } = req.query;\n    const cryptoList = cryptoIds.split(',').map(id => id.trim());\n    const { getCryptoMarketAnalysis } = await safeLoad('../services/cryptoService.js');\n    const serviceData = await getCryptoMarketAnalysis(cryptoList);\n\n    // Normalize/augment returned service data for backward compatibility\n    if (serviceData && typeof serviceData === 'object') {\n      // If the service provides a volatilityIndex, expose it as `value` to match tests\n      if (serviceData.volatilityIndex !== undefined) {\n        serviceData.value = serviceData.volatilityIndex;\n      }\n      // Add unit and topic defaults if not present\n      serviceData.unit = serviceData.unit || '%';\n      serviceData.topic = serviceData.topic || 'crypto-volatility';\n      // Ensure timestamp exists\n      serviceData.timestamp = serviceData.timestamp || new Date().toISOString();\n    }\n\n    res.status(200).json({\n      success: true,\n      status: 'OK',\n      source: 'Praevisio-Aion-CryptoService',\n      timestamp: new Date().toISOString(),\n      data: serviceData\n    });\n  } catch (error) {\n    console.error('Error retrieving crypto volatility data:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Internal Server Error: Could not retrieve crypto volatility data.'\n    });\n  }\n});\n\n// GET /api/global-risk/climate-extremes\nrouter.get('/climate-extremes', async (req, res) => {\n  try {\n    const { getClimateExtremesIndex } = await safeLoad('../services/climateService.js');\n    const serviceData = await getClimateExtremesIndex();\n\n    res.status(200).json({\n      success: true,\n      source: 'Praevisio-Aion-NASA-POWER-Integration',\n      timestamp: new Date().toISOString(),\n      data: serviceData\n    });\n  } catch (error) {\n    console.error('Error retrieving climate extremes data:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Internal Server Error: Could not retrieve climate extremes data.'\n    });\n  }\n});\n\n// GET /api/global-risk/community-resilience\nrouter.get('/community-resilience', async (req, res) => {\n  try {\n    const { countries = 'COL,PER,ARG', days = 30 } = req.query;\n    const countryList = Array.isArray(countries) ? countries : countries.split(',').map(c => c.trim()).filter(Boolean);\n\n    const { getCommunityResilienceIndex } = await safeLoad('../services/communityResilienceService.js');\n    const serviceData = await getCommunityResilienceIndex(countryList, Number(days));\n\n    // Build a normalized metric value: 100 - averageResilience\n    const avg = serviceData?.globalResilienceAssessment?.averageResilience;\n    const value = typeof avg === 'number' ? Math.round(100 - avg) : undefined;\n\n    const data = {\n      timestamp: serviceData?.timestamp || new Date().toISOString(),\n      topic: 'community-resilience',\n      unit: '%',\n      value,\n      resilienceAnalysis: serviceData?.resilienceAnalysis || {},\n      globalResilienceAssessment: serviceData?.globalResilienceAssessment || {}\n    };\n\n    res.status(200).json({\n      success: true,\n      status: 'OK',\n      source: 'Praevisio-Aion-CommunityResilienceAgent',\n      timestamp: new Date().toISOString(),\n      data\n    });\n  } catch (error) {\n    console.error('Error retrieving community resilience data:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Internal Server Error: Could not retrieve community resilience data.'\n    });\n  }\n});\n\n/**\n * @route GET /api/generative-analysis\n * @description Provides generative AI analysis of risk data with narrative insights.\n * @access Public\n */\nrouter.get('/generative-analysis', async (req, res) => {\n  try {\n    const { focusAreas = ['climate', 'economic', 'social'], timeHorizon = '6months', detailLevel = 'comprehensive', language = 'es' } = req.query;\n\n    const { getRiskIndices } = await safeLoad('../services/predictionEngine.js');\n    const riskData = await getRiskIndices();\n\n    const { generatePredictiveNarrative } = await safeLoad('../services/generativeAIService.js');\n    \n    const options = {\n      focusAreas: Array.isArray(focusAreas) ? focusAreas : focusAreas.split(',').map(a => a.trim()),\n      timeHorizon,\n      detailLevel,\n      language\n    };\n\n    const narrative = await generatePredictiveNarrative(riskData, options);\n\n    res.status(200).json({\n      success: true,\n      status: 'OK',\n      source: 'Praevisio-Aion-GenerativeAI',\n      timestamp: new Date().toISOString(),\n      data: narrative\n    });\n  } catch (error) {\n    console.error('Error generating AI analysis:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Internal Server Error: Could not generate AI analysis.'\n    });\n  }\n});\n\nexport default router;\n"],"mappings":";;;;;;AAAA,IAAAA,QAAA,GAAAC,sBAAA,CAAAC,OAAA;AACA,IAAAC,KAAA,GAAAF,sBAAA,CAAAC,OAAA;AAAwB,SAAAD,uBAAAG,CAAA,WAAAA,CAAA,IAAAA,CAAA,CAAAC,UAAA,GAAAD,CAAA,KAAAE,OAAA,EAAAF,CAAA;AAAA,SAAAG,wBAAAH,CAAA,EAAAI,CAAA,6BAAAC,OAAA,MAAAC,CAAA,OAAAD,OAAA,IAAAE,CAAA,OAAAF,OAAA,YAAAF,uBAAA,YAAAA,CAAAH,CAAA,EAAAI,CAAA,SAAAA,CAAA,IAAAJ,CAAA,IAAAA,CAAA,CAAAC,UAAA,SAAAD,CAAA,MAAAQ,CAAA,EAAAC,CAAA,EAAAC,CAAA,KAAAC,SAAA,QAAAT,OAAA,EAAAF,CAAA,iBAAAA,CAAA,uBAAAA,CAAA,yBAAAA,CAAA,SAAAU,CAAA,MAAAF,CAAA,GAAAJ,CAAA,GAAAG,CAAA,GAAAD,CAAA,QAAAE,CAAA,CAAAI,GAAA,CAAAZ,CAAA,UAAAQ,CAAA,CAAAK,GAAA,CAAAb,CAAA,GAAAQ,CAAA,CAAAM,GAAA,CAAAd,CAAA,EAAAU,CAAA,gBAAAN,CAAA,IAAAJ,CAAA,gBAAAI,CAAA,OAAAW,cAAA,CAAAC,IAAA,CAAAhB,CAAA,EAAAI,CAAA,OAAAK,CAAA,IAAAD,CAAA,GAAAS,MAAA,CAAAC,cAAA,KAAAD,MAAA,CAAAE,wBAAA,CAAAnB,CAAA,EAAAI,CAAA,OAAAK,CAAA,CAAAI,GAAA,IAAAJ,CAAA,CAAAK,GAAA,IAAAN,CAAA,CAAAE,CAAA,EAAAN,CAAA,EAAAK,CAAA,IAAAC,CAAA,CAAAN,CAAA,IAAAJ,CAAA,CAAAI,CAAA,WAAAM,CAAA,KAAAV,CAAA,EAAAI,CAAA;AAExB;AACA;AACA;AACA;AACA;AACA;AACA,MAAMgB,QAAS,GAAGC,aAAI,CAACC,OAAO,CAACC,OAAO,CAACC,GAAG,CAAC,CAAC,EAAE,KAAK,EAAE,QAAQ,CAAC;AAC9D,MAAMC,MAAM,GAAGC,gBAAO,CAACC,MAAM,CAAC,CAAC;;AAE/B;AACA,eAAeC,QAAQA,CAACC,UAAU,EAAE;EAClC,IAAI;IACF,MAAMC,QAAQ,GAAGT,aAAI,CAACC,OAAO,CAACF,QAAS,EAAES,UAAU,CAAC;IACpD,MAAME,MAAM,GAAG,OAAAC,SAAA,QAAAC,OAAA,CAAA3B,CAAA,IAAAA,CAAA,IAAA0B,SAAA,KAAAE,IAAA,CAAAC,CAAA,IAAAhC,uBAAA,CAAAL,OAAA,CAAAqC,CAAA,KAAaL,QAAQ,CAAC;IACrC,OAAOC,MAAM,CAAC7B,OAAO,IAAI6B,MAAM;EACjC,CAAC,CAAC,OAAOK,KAAK,EAAE;IACdC,OAAO,CAACD,KAAK,CAAC,wBAAwBP,UAAU,GAAG,EAAEO,KAAK,CAAC;IAC3D,MAAM,IAAIE,KAAK,CAAC,0BAA0BT,UAAU,EAAE,CAAC;EACzD;AACF;;AAEA;AACAJ,MAAM,CAACZ,GAAG,CAAC,gBAAgB,EAAE,OAAO0B,GAAG,EAAEC,GAAG,KAAK;EAC/C,IAAI;IACF,MAAM;MAAEC;IAAqB,CAAC,GAAG,MAAMb,QAAQ,CAAC,oCAAoC,CAAC;IACrF,MAAMc,IAAI,GAAG,MAAMD,oBAAoB,CAAC,CAAC;IAEzCD,GAAG,CAACG,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC;MACnBC,OAAO,EAAE,IAAI;MACbC,MAAM,EAAE,oCAAoC;MAC5CJ;IACF,CAAC,CAAC;EACJ,CAAC,CAAC,OAAON,KAAK,EAAE;IACdC,OAAO,CAACD,KAAK,CAAC,sCAAsC,EAAEA,KAAK,CAAC;IAC5DI,GAAG,CAACG,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC;MACnBC,OAAO,EAAE,KAAK;MACdE,OAAO,EAAE;IACX,CAAC,CAAC;EACJ;AACF,CAAC,CAAC;;AAEF;AACAtB,MAAM,CAACZ,GAAG,CAAC,oBAAoB,EAAE,OAAO0B,GAAG,EAAEC,GAAG,KAAK;EACnD,IAAI;IACF,MAAM;MAAEQ,SAAS,GAAG;IAAmB,CAAC,GAAGT,GAAG,CAACU,KAAK;IACpD,MAAMC,UAAU,GAAGF,SAAS,CAACG,KAAK,CAAC,GAAG,CAAC,CAACC,GAAG,CAACC,EAAE,IAAIA,EAAE,CAACC,IAAI,CAAC,CAAC,CAAC;IAC5D,MAAM;MAAEC;IAAwB,CAAC,GAAG,MAAM3B,QAAQ,CAAC,8BAA8B,CAAC;IAClF,MAAM4B,WAAW,GAAG,MAAMD,uBAAuB,CAACL,UAAU,CAAC;;IAE7D;IACA,IAAIM,WAAW,IAAI,OAAOA,WAAW,KAAK,QAAQ,EAAE;MAClD;MACA,IAAIA,WAAW,CAACC,eAAe,KAAKC,SAAS,EAAE;QAC7CF,WAAW,CAACG,KAAK,GAAGH,WAAW,CAACC,eAAe;MACjD;MACA;MACAD,WAAW,CAACI,IAAI,GAAGJ,WAAW,CAACI,IAAI,IAAI,GAAG;MAC1CJ,WAAW,CAACK,KAAK,GAAGL,WAAW,CAACK,KAAK,IAAI,mBAAmB;MAC5D;MACAL,WAAW,CAACM,SAAS,GAAGN,WAAW,CAACM,SAAS,IAAI,IAAIC,IAAI,CAAC,CAAC,CAACC,WAAW,CAAC,CAAC;IAC3E;IAEAxB,GAAG,CAACG,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC;MACnBC,OAAO,EAAE,IAAI;MACbF,MAAM,EAAE,IAAI;MACZG,MAAM,EAAE,8BAA8B;MACtCgB,SAAS,EAAE,IAAIC,IAAI,CAAC,CAAC,CAACC,WAAW,CAAC,CAAC;MACnCtB,IAAI,EAAEc;IACR,CAAC,CAAC;EACJ,CAAC,CAAC,OAAOpB,KAAK,EAAE;IACdC,OAAO,CAACD,KAAK,CAAC,0CAA0C,EAAEA,KAAK,CAAC;IAChEI,GAAG,CAACG,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC;MACnBC,OAAO,EAAE,KAAK;MACdE,OAAO,EAAE;IACX,CAAC,CAAC;EACJ;AACF,CAAC,CAAC;;AAEF;AACAtB,MAAM,CAACZ,GAAG,CAAC,mBAAmB,EAAE,OAAO0B,GAAG,EAAEC,GAAG,KAAK;EAClD,IAAI;IACF,MAAM;MAAEyB;IAAwB,CAAC,GAAG,MAAMrC,QAAQ,CAAC,+BAA+B,CAAC;IACnF,MAAM4B,WAAW,GAAG,MAAMS,uBAAuB,CAAC,CAAC;IAEnDzB,GAAG,CAACG,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC;MACnBC,OAAO,EAAE,IAAI;MACbC,MAAM,EAAE,uCAAuC;MAC/CgB,SAAS,EAAE,IAAIC,IAAI,CAAC,CAAC,CAACC,WAAW,CAAC,CAAC;MACnCtB,IAAI,EAAEc;IACR,CAAC,CAAC;EACJ,CAAC,CAAC,OAAOpB,KAAK,EAAE;IACdC,OAAO,CAACD,KAAK,CAAC,yCAAyC,EAAEA,KAAK,CAAC;IAC/DI,GAAG,CAACG,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC;MACnBC,OAAO,EAAE,KAAK;MACdE,OAAO,EAAE;IACX,CAAC,CAAC;EACJ;AACF,CAAC,CAAC;;AAEF;AACAtB,MAAM,CAACZ,GAAG,CAAC,uBAAuB,EAAE,OAAO0B,GAAG,EAAEC,GAAG,KAAK;EACtD,IAAI;IACF,MAAM;MAAE0B,SAAS,GAAG,aAAa;MAAEC,IAAI,GAAG;IAAG,CAAC,GAAG5B,GAAG,CAACU,KAAK;IAC1D,MAAMmB,WAAW,GAAGC,KAAK,CAACC,OAAO,CAACJ,SAAS,CAAC,GAAGA,SAAS,GAAGA,SAAS,CAACf,KAAK,CAAC,GAAG,CAAC,CAACC,GAAG,CAACmB,CAAC,IAAIA,CAAC,CAACjB,IAAI,CAAC,CAAC,CAAC,CAACkB,MAAM,CAACC,OAAO,CAAC;IAElH,MAAM;MAAEC;IAA4B,CAAC,GAAG,MAAM9C,QAAQ,CAAC,2CAA2C,CAAC;IACnG,MAAM4B,WAAW,GAAG,MAAMkB,2BAA2B,CAACN,WAAW,EAAEO,MAAM,CAACR,IAAI,CAAC,CAAC;;IAEhF;IACA,MAAMS,GAAG,GAAGpB,WAAW,EAAEqB,0BAA0B,EAAEC,iBAAiB;IACtE,MAAMnB,KAAK,GAAG,OAAOiB,GAAG,KAAK,QAAQ,GAAGG,IAAI,CAACC,KAAK,CAAC,GAAG,GAAGJ,GAAG,CAAC,GAAGlB,SAAS;IAEzE,MAAMhB,IAAI,GAAG;MACXoB,SAAS,EAAEN,WAAW,EAAEM,SAAS,IAAI,IAAIC,IAAI,CAAC,CAAC,CAACC,WAAW,CAAC,CAAC;MAC7DH,KAAK,EAAE,sBAAsB;MAC7BD,IAAI,EAAE,GAAG;MACTD,KAAK;MACLsB,kBAAkB,EAAEzB,WAAW,EAAEyB,kBAAkB,IAAI,CAAC,CAAC;MACzDJ,0BAA0B,EAAErB,WAAW,EAAEqB,0BAA0B,IAAI,CAAC;IAC1E,CAAC;IAEDrC,GAAG,CAACG,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC;MACnBC,OAAO,EAAE,IAAI;MACbF,MAAM,EAAE,IAAI;MACZG,MAAM,EAAE,yCAAyC;MACjDgB,SAAS,EAAE,IAAIC,IAAI,CAAC,CAAC,CAACC,WAAW,CAAC,CAAC;MACnCtB;IACF,CAAC,CAAC;EACJ,CAAC,CAAC,OAAON,KAAK,EAAE;IACdC,OAAO,CAACD,KAAK,CAAC,6CAA6C,EAAEA,KAAK,CAAC;IACnEI,GAAG,CAACG,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC;MACnBC,OAAO,EAAE,KAAK;MACdE,OAAO,EAAE;IACX,CAAC,CAAC;EACJ;AACF,CAAC,CAAC;;AAEF;AACA;AACA;AACA;AACA;AACAtB,MAAM,CAACZ,GAAG,CAAC,sBAAsB,EAAE,OAAO0B,GAAG,EAAEC,GAAG,KAAK;EACrD,IAAI;IACF,MAAM;MAAE0C,UAAU,GAAG,CAAC,SAAS,EAAE,UAAU,EAAE,QAAQ,CAAC;MAAEC,WAAW,GAAG,SAAS;MAAEC,WAAW,GAAG,eAAe;MAAEC,QAAQ,GAAG;IAAK,CAAC,GAAG9C,GAAG,CAACU,KAAK;IAE7I,MAAM;MAAEqC;IAAe,CAAC,GAAG,MAAM1D,QAAQ,CAAC,iCAAiC,CAAC;IAC5E,MAAM2D,QAAQ,GAAG,MAAMD,cAAc,CAAC,CAAC;IAEvC,MAAM;MAAEE;IAA4B,CAAC,GAAG,MAAM5D,QAAQ,CAAC,oCAAoC,CAAC;IAE5F,MAAM6D,OAAO,GAAG;MACdP,UAAU,EAAEb,KAAK,CAACC,OAAO,CAACY,UAAU,CAAC,GAAGA,UAAU,GAAGA,UAAU,CAAC/B,KAAK,CAAC,GAAG,CAAC,CAACC,GAAG,CAACsC,CAAC,IAAIA,CAAC,CAACpC,IAAI,CAAC,CAAC,CAAC;MAC7F6B,WAAW;MACXC,WAAW;MACXC;IACF,CAAC;IAED,MAAMM,SAAS,GAAG,MAAMH,2BAA2B,CAACD,QAAQ,EAAEE,OAAO,CAAC;IAEtEjD,GAAG,CAACG,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC;MACnBC,OAAO,EAAE,IAAI;MACbF,MAAM,EAAE,IAAI;MACZG,MAAM,EAAE,6BAA6B;MACrCgB,SAAS,EAAE,IAAIC,IAAI,CAAC,CAAC,CAACC,WAAW,CAAC,CAAC;MACnCtB,IAAI,EAAEiD;IACR,CAAC,CAAC;EACJ,CAAC,CAAC,OAAOvD,KAAK,EAAE;IACdC,OAAO,CAACD,KAAK,CAAC,+BAA+B,EAAEA,KAAK,CAAC;IACrDI,GAAG,CAACG,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC;MACnBC,OAAO,EAAE,KAAK;MACdE,OAAO,EAAE;IACX,CAAC,CAAC;EACJ;AACF,CAAC,CAAC;AAAC,IAAA6C,QAAA,GAAAC,OAAA,CAAA3F,OAAA,GAEYuB,MAAM","ignoreList":[]}