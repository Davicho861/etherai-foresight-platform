6778e303266eb4a2f23bee23dc508230
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
}); // src/Interceptor.ts
var _logger = require('@open-draft/logger');
var _stricteventemitter = require('strict-event-emitter');
var INTERNAL_REQUEST_ID_HEADER_NAME = "x-interceptors-internal-request-id";
function getGlobalSymbol(symbol) {
  return (
    // @ts-ignore https://github.com/Microsoft/TypeScript/issues/24587
    globalThis[symbol] || void 0
  );
}
function setGlobalSymbol(symbol, value) {
  globalThis[symbol] = value;
}
function deleteGlobalSymbol(symbol) {
  delete globalThis[symbol];
}
var InterceptorReadyState = /* @__PURE__ */(InterceptorReadyState2 => {
  InterceptorReadyState2["INACTIVE"] = "INACTIVE";
  InterceptorReadyState2["APPLYING"] = "APPLYING";
  InterceptorReadyState2["APPLIED"] = "APPLIED";
  InterceptorReadyState2["DISPOSING"] = "DISPOSING";
  InterceptorReadyState2["DISPOSED"] = "DISPOSED";
  return InterceptorReadyState2;
})(InterceptorReadyState || {});
var Interceptor = class {
  constructor(symbol) {
    this.symbol = symbol;
    this.readyState = "INACTIVE" /* INACTIVE */;
    this.emitter = new (0, _stricteventemitter.Emitter)();
    this.subscriptions = [];
    this.logger = new (0, _logger.Logger)(symbol.description);
    this.emitter.setMaxListeners(0);
    this.logger.info("constructing the interceptor...");
  }
  /**
   * Determine if this interceptor can be applied
   * in the current environment.
   */
  checkEnvironment() {
    return true;
  }
  /**
   * Apply this interceptor to the current process.
   * Returns an already running interceptor instance if it's present.
   */
  apply() {
    const logger = this.logger.extend("apply");
    logger.info("applying the interceptor...");
    if (this.readyState === "APPLIED" /* APPLIED */) {
      logger.info("intercepted already applied!");
      return;
    }
    const shouldApply = this.checkEnvironment();
    if (!shouldApply) {
      logger.info("the interceptor cannot be applied in this environment!");
      return;
    }
    this.readyState = "APPLYING" /* APPLYING */;
    const runningInstance = this.getInstance();
    if (runningInstance) {
      logger.info("found a running instance, reusing...");
      this.on = (event, listener) => {
        logger.info('proxying the "%s" listener', event);
        runningInstance.emitter.addListener(event, listener);
        this.subscriptions.push(() => {
          runningInstance.emitter.removeListener(event, listener);
          logger.info('removed proxied "%s" listener!', event);
        });
        return this;
      };
      this.readyState = "APPLIED" /* APPLIED */;
      return;
    }
    logger.info("no running instance found, setting up a new instance...");
    this.setup();
    this.setInstance();
    this.readyState = "APPLIED" /* APPLIED */;
  }
  /**
   * Setup the module augments and stubs necessary for this interceptor.
   * This method is not run if there's a running interceptor instance
   * to prevent instantiating an interceptor multiple times.
   */
  setup() {}
  /**
   * Listen to the interceptor's public events.
   */
  on(event, listener) {
    const logger = this.logger.extend("on");
    if (this.readyState === "DISPOSING" /* DISPOSING */ || this.readyState === "DISPOSED" /* DISPOSED */) {
      logger.info("cannot listen to events, already disposed!");
      return this;
    }
    logger.info('adding "%s" event listener:', event, listener);
    this.emitter.on(event, listener);
    return this;
  }
  once(event, listener) {
    this.emitter.once(event, listener);
    return this;
  }
  off(event, listener) {
    this.emitter.off(event, listener);
    return this;
  }
  removeAllListeners(event) {
    this.emitter.removeAllListeners(event);
    return this;
  }
  /**
   * Disposes of any side-effects this interceptor has introduced.
   */
  dispose() {
    const logger = this.logger.extend("dispose");
    if (this.readyState === "DISPOSED" /* DISPOSED */) {
      logger.info("cannot dispose, already disposed!");
      return;
    }
    logger.info("disposing the interceptor...");
    this.readyState = "DISPOSING" /* DISPOSING */;
    if (!this.getInstance()) {
      logger.info("no interceptors running, skipping dispose...");
      return;
    }
    this.clearInstance();
    logger.info("global symbol deleted:", getGlobalSymbol(this.symbol));
    if (this.subscriptions.length > 0) {
      logger.info("disposing of %d subscriptions...", this.subscriptions.length);
      for (const dispose of this.subscriptions) {
        dispose();
      }
      this.subscriptions = [];
      logger.info("disposed of all subscriptions!", this.subscriptions.length);
    }
    this.emitter.removeAllListeners();
    logger.info("destroyed the listener!");
    this.readyState = "DISPOSED" /* DISPOSED */;
  }
  getInstance() {
    var _a;
    const instance = getGlobalSymbol(this.symbol);
    this.logger.info("retrieved global instance:", (_a = instance == null ? void 0 : instance.constructor) == null ? void 0 : _a.name);
    return instance;
  }
  setInstance() {
    setGlobalSymbol(this.symbol, this);
    this.logger.info("set global instance!", this.symbol.description);
  }
  clearInstance() {
    deleteGlobalSymbol(this.symbol);
    this.logger.info("cleared global instance!", this.symbol.description);
  }
};

// src/createRequestId.ts
function createRequestId() {
  return Math.random().toString(16).slice(2);
}
exports.INTERNAL_REQUEST_ID_HEADER_NAME = INTERNAL_REQUEST_ID_HEADER_NAME;
exports.getGlobalSymbol = getGlobalSymbol;
exports.deleteGlobalSymbol = deleteGlobalSymbol;
exports.InterceptorReadyState = InterceptorReadyState;
exports.Interceptor = Interceptor;
exports.createRequestId = createRequestId;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfbG9nZ2VyIiwicmVxdWlyZSIsIl9zdHJpY3RldmVudGVtaXR0ZXIiLCJJTlRFUk5BTF9SRVFVRVNUX0lEX0hFQURFUl9OQU1FIiwiZ2V0R2xvYmFsU3ltYm9sIiwic3ltYm9sIiwiZ2xvYmFsVGhpcyIsInNldEdsb2JhbFN5bWJvbCIsInZhbHVlIiwiZGVsZXRlR2xvYmFsU3ltYm9sIiwiSW50ZXJjZXB0b3JSZWFkeVN0YXRlIiwiSW50ZXJjZXB0b3JSZWFkeVN0YXRlMiIsIkludGVyY2VwdG9yIiwiY29uc3RydWN0b3IiLCJyZWFkeVN0YXRlIiwiZW1pdHRlciIsIkVtaXR0ZXIiLCJzdWJzY3JpcHRpb25zIiwibG9nZ2VyIiwiTG9nZ2VyIiwiZGVzY3JpcHRpb24iLCJzZXRNYXhMaXN0ZW5lcnMiLCJpbmZvIiwiY2hlY2tFbnZpcm9ubWVudCIsImFwcGx5IiwiZXh0ZW5kIiwic2hvdWxkQXBwbHkiLCJydW5uaW5nSW5zdGFuY2UiLCJnZXRJbnN0YW5jZSIsIm9uIiwiZXZlbnQiLCJsaXN0ZW5lciIsImFkZExpc3RlbmVyIiwicHVzaCIsInJlbW92ZUxpc3RlbmVyIiwic2V0dXAiLCJzZXRJbnN0YW5jZSIsIm9uY2UiLCJvZmYiLCJyZW1vdmVBbGxMaXN0ZW5lcnMiLCJkaXNwb3NlIiwiY2xlYXJJbnN0YW5jZSIsImxlbmd0aCIsIl9hIiwiaW5zdGFuY2UiLCJuYW1lIiwiY3JlYXRlUmVxdWVzdElkIiwiTWF0aCIsInJhbmRvbSIsInRvU3RyaW5nIiwic2xpY2UiXSwic291cmNlcyI6WyIuLi8uLi9zcmMvSW50ZXJjZXB0b3IudHMiLCIuLi8uLi9zcmMvY3JlYXRlUmVxdWVzdElkLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IExvZ2dlciB9IGZyb20gJ0BvcGVuLWRyYWZ0L2xvZ2dlcidcbmltcG9ydCB7IEVtaXR0ZXIsIExpc3RlbmVyIH0gZnJvbSAnc3RyaWN0LWV2ZW50LWVtaXR0ZXInXG5cbmV4cG9ydCB0eXBlIEludGVyY2VwdG9yRXZlbnRNYXAgPSBSZWNvcmQ8c3RyaW5nLCBhbnk+XG5leHBvcnQgdHlwZSBJbnRlcmNlcHRvclN1YnNjcmlwdGlvbiA9ICgpID0+IHZvaWRcblxuLyoqXG4gKiBSZXF1ZXN0IGhlYWRlciBuYW1lIHRvIGRldGVjdCB3aGVuIGEgc2luZ2xlIHJlcXVlc3RcbiAqIGlzIGJlaW5nIGhhbmRsZWQgYnkgbmVzdGVkIGludGVyY2VwdG9ycyAoWEhSIC0+IENsaWVudFJlcXVlc3QpLlxuICogT2JzY3VyZSBieSBkZXNpZ24gdG8gcHJldmVudCBjb2xsaXNpb25zIHdpdGggdXNlci1kZWZpbmVkIGhlYWRlcnMuXG4gKiBJZGVhbGx5LCBjb21lIHVwIHdpdGggdGhlIEludGVyY2VwdG9yLWxldmVsIG1lY2hhbmlzbSBmb3IgdGhpcy5cbiAqIEBzZWUgaHR0cHM6Ly9naXRodWIuY29tL21zd2pzL2ludGVyY2VwdG9ycy9pc3N1ZXMvMzc4XG4gKi9cbmV4cG9ydCBjb25zdCBJTlRFUk5BTF9SRVFVRVNUX0lEX0hFQURFUl9OQU1FID1cbiAgJ3gtaW50ZXJjZXB0b3JzLWludGVybmFsLXJlcXVlc3QtaWQnXG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRHbG9iYWxTeW1ib2w8Vj4oc3ltYm9sOiBTeW1ib2wpOiBWIHwgdW5kZWZpbmVkIHtcbiAgcmV0dXJuIChcbiAgICAvLyBAdHMtaWdub3JlIGh0dHBzOi8vZ2l0aHViLmNvbS9NaWNyb3NvZnQvVHlwZVNjcmlwdC9pc3N1ZXMvMjQ1ODdcbiAgICBnbG9iYWxUaGlzW3N5bWJvbF0gfHwgdW5kZWZpbmVkXG4gIClcbn1cblxuZnVuY3Rpb24gc2V0R2xvYmFsU3ltYm9sKHN5bWJvbDogU3ltYm9sLCB2YWx1ZTogYW55KTogdm9pZCB7XG4gIC8vIEB0cy1pZ25vcmVcbiAgZ2xvYmFsVGhpc1tzeW1ib2xdID0gdmFsdWVcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRlbGV0ZUdsb2JhbFN5bWJvbChzeW1ib2w6IFN5bWJvbCk6IHZvaWQge1xuICAvLyBAdHMtaWdub3JlXG4gIGRlbGV0ZSBnbG9iYWxUaGlzW3N5bWJvbF1cbn1cblxuZXhwb3J0IGVudW0gSW50ZXJjZXB0b3JSZWFkeVN0YXRlIHtcbiAgSU5BQ1RJVkUgPSAnSU5BQ1RJVkUnLFxuICBBUFBMWUlORyA9ICdBUFBMWUlORycsXG4gIEFQUExJRUQgPSAnQVBQTElFRCcsXG4gIERJU1BPU0lORyA9ICdESVNQT1NJTkcnLFxuICBESVNQT1NFRCA9ICdESVNQT1NFRCcsXG59XG5cbmV4cG9ydCB0eXBlIEV4dHJhY3RFdmVudE5hbWVzPEV2ZW50cyBleHRlbmRzIFJlY29yZDxzdHJpbmcsIGFueT4+ID1cbiAgRXZlbnRzIGV4dGVuZHMgUmVjb3JkPGluZmVyIEV2ZW50TmFtZSwgYW55PiA/IEV2ZW50TmFtZSA6IG5ldmVyXG5cbmV4cG9ydCBjbGFzcyBJbnRlcmNlcHRvcjxFdmVudHMgZXh0ZW5kcyBJbnRlcmNlcHRvckV2ZW50TWFwPiB7XG4gIHByb3RlY3RlZCBlbWl0dGVyOiBFbWl0dGVyPEV2ZW50cz5cbiAgcHJvdGVjdGVkIHN1YnNjcmlwdGlvbnM6IEFycmF5PEludGVyY2VwdG9yU3Vic2NyaXB0aW9uPlxuICBwcm90ZWN0ZWQgbG9nZ2VyOiBMb2dnZXJcblxuICBwdWJsaWMgcmVhZHlTdGF0ZTogSW50ZXJjZXB0b3JSZWFkeVN0YXRlXG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBzeW1ib2w6IHN5bWJvbCkge1xuICAgIHRoaXMucmVhZHlTdGF0ZSA9IEludGVyY2VwdG9yUmVhZHlTdGF0ZS5JTkFDVElWRVxuXG4gICAgdGhpcy5lbWl0dGVyID0gbmV3IEVtaXR0ZXIoKVxuICAgIHRoaXMuc3Vic2NyaXB0aW9ucyA9IFtdXG4gICAgdGhpcy5sb2dnZXIgPSBuZXcgTG9nZ2VyKHN5bWJvbC5kZXNjcmlwdGlvbiEpXG5cbiAgICAvLyBEbyBub3QgbGltaXQgdGhlIG1heGltdW0gbnVtYmVyIG9mIGxpc3RlbmVyc1xuICAgIC8vIHNvIG5vdCB0byBsaW1pdCB0aGUgbWF4aW11bSBhbW91bnQgb2YgcGFyYWxsZWwgZXZlbnRzIGVtaXR0ZWQuXG4gICAgdGhpcy5lbWl0dGVyLnNldE1heExpc3RlbmVycygwKVxuXG4gICAgdGhpcy5sb2dnZXIuaW5mbygnY29uc3RydWN0aW5nIHRoZSBpbnRlcmNlcHRvci4uLicpXG4gIH1cblxuICAvKipcbiAgICogRGV0ZXJtaW5lIGlmIHRoaXMgaW50ZXJjZXB0b3IgY2FuIGJlIGFwcGxpZWRcbiAgICogaW4gdGhlIGN1cnJlbnQgZW52aXJvbm1lbnQuXG4gICAqL1xuICBwcm90ZWN0ZWQgY2hlY2tFbnZpcm9ubWVudCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdHJ1ZVxuICB9XG5cbiAgLyoqXG4gICAqIEFwcGx5IHRoaXMgaW50ZXJjZXB0b3IgdG8gdGhlIGN1cnJlbnQgcHJvY2Vzcy5cbiAgICogUmV0dXJucyBhbiBhbHJlYWR5IHJ1bm5pbmcgaW50ZXJjZXB0b3IgaW5zdGFuY2UgaWYgaXQncyBwcmVzZW50LlxuICAgKi9cbiAgcHVibGljIGFwcGx5KCk6IHZvaWQge1xuICAgIGNvbnN0IGxvZ2dlciA9IHRoaXMubG9nZ2VyLmV4dGVuZCgnYXBwbHknKVxuICAgIGxvZ2dlci5pbmZvKCdhcHBseWluZyB0aGUgaW50ZXJjZXB0b3IuLi4nKVxuXG4gICAgaWYgKHRoaXMucmVhZHlTdGF0ZSA9PT0gSW50ZXJjZXB0b3JSZWFkeVN0YXRlLkFQUExJRUQpIHtcbiAgICAgIGxvZ2dlci5pbmZvKCdpbnRlcmNlcHRlZCBhbHJlYWR5IGFwcGxpZWQhJylcbiAgICAgIHJldHVyblxuICAgIH1cblxuICAgIGNvbnN0IHNob3VsZEFwcGx5ID0gdGhpcy5jaGVja0Vudmlyb25tZW50KClcblxuICAgIGlmICghc2hvdWxkQXBwbHkpIHtcbiAgICAgIGxvZ2dlci5pbmZvKCd0aGUgaW50ZXJjZXB0b3IgY2Fubm90IGJlIGFwcGxpZWQgaW4gdGhpcyBlbnZpcm9ubWVudCEnKVxuICAgICAgcmV0dXJuXG4gICAgfVxuXG4gICAgdGhpcy5yZWFkeVN0YXRlID0gSW50ZXJjZXB0b3JSZWFkeVN0YXRlLkFQUExZSU5HXG5cbiAgICAvLyBXaGVuZXZlciBhcHBseWluZyBhIG5ldyBpbnRlcmNlcHRvciwgY2hlY2sgaWYgaXQgaGFzbid0IGJlZW4gYXBwbGllZCBhbHJlYWR5LlxuICAgIC8vIFRoaXMgZW5hYmxlcyB0byBhcHBseSB0aGUgc2FtZSBpbnRlcmNlcHRvciBtdWx0aXBsZSB0aW1lcywgZm9yIGV4YW1wbGUgZnJvbSBhIGRpZmZlcmVudFxuICAgIC8vIGludGVyY2VwdG9yLCBvbmx5IHByb3h5aW5nIGV2ZW50cyBidXQga2VlcGluZyB0aGUgc3R1YnMgaW4gYSBzaW5nbGUgcGxhY2UuXG4gICAgY29uc3QgcnVubmluZ0luc3RhbmNlID0gdGhpcy5nZXRJbnN0YW5jZSgpXG5cbiAgICBpZiAocnVubmluZ0luc3RhbmNlKSB7XG4gICAgICBsb2dnZXIuaW5mbygnZm91bmQgYSBydW5uaW5nIGluc3RhbmNlLCByZXVzaW5nLi4uJylcblxuICAgICAgLy8gUHJveHkgYW55IGxpc3RlbmVycyB5b3Ugc2V0IG9uIHRoaXMgaW5zdGFuY2UgdG8gdGhlIHJ1bm5pbmcgaW5zdGFuY2UuXG4gICAgICB0aGlzLm9uID0gKGV2ZW50LCBsaXN0ZW5lcikgPT4ge1xuICAgICAgICBsb2dnZXIuaW5mbygncHJveHlpbmcgdGhlIFwiJXNcIiBsaXN0ZW5lcicsIGV2ZW50KVxuXG4gICAgICAgIC8vIEFkZCBsaXN0ZW5lcnMgdG8gdGhlIHJ1bm5pbmcgaW5zdGFuY2Ugc28gdGhleSBhcHBlYXJcbiAgICAgICAgLy8gYXQgdGhlIHRvcCBvZiB0aGUgZXZlbnQgbGlzdGVuZXJzIGxpc3QgYW5kIGFyZSBleGVjdXRlZCBmaXJzdC5cbiAgICAgICAgcnVubmluZ0luc3RhbmNlLmVtaXR0ZXIuYWRkTGlzdGVuZXIoZXZlbnQsIGxpc3RlbmVyKVxuXG4gICAgICAgIC8vIEVuc3VyZSB0aGF0IG9uY2UgdGhpcyBpbnRlcmNlcHRvciBpbnN0YW5jZSBpcyBkaXNwb3NlZCxcbiAgICAgICAgLy8gaXQgcmVtb3ZlcyBhbGwgbGlzdGVuZXJzIGl0IGhhcyBhcHBlbmRlZCB0byB0aGUgcnVubmluZyBpbnRlcmNlcHRvciBpbnN0YW5jZS5cbiAgICAgICAgdGhpcy5zdWJzY3JpcHRpb25zLnB1c2goKCkgPT4ge1xuICAgICAgICAgIHJ1bm5pbmdJbnN0YW5jZS5lbWl0dGVyLnJlbW92ZUxpc3RlbmVyKGV2ZW50LCBsaXN0ZW5lcilcbiAgICAgICAgICBsb2dnZXIuaW5mbygncmVtb3ZlZCBwcm94aWVkIFwiJXNcIiBsaXN0ZW5lciEnLCBldmVudClcbiAgICAgICAgfSlcblxuICAgICAgICByZXR1cm4gdGhpc1xuICAgICAgfVxuXG4gICAgICB0aGlzLnJlYWR5U3RhdGUgPSBJbnRlcmNlcHRvclJlYWR5U3RhdGUuQVBQTElFRFxuXG4gICAgICByZXR1cm5cbiAgICB9XG5cbiAgICBsb2dnZXIuaW5mbygnbm8gcnVubmluZyBpbnN0YW5jZSBmb3VuZCwgc2V0dGluZyB1cCBhIG5ldyBpbnN0YW5jZS4uLicpXG5cbiAgICAvLyBTZXR1cCB0aGUgaW50ZXJjZXB0b3IuXG4gICAgdGhpcy5zZXR1cCgpXG5cbiAgICAvLyBTdG9yZSB0aGUgbmV3bHkgYXBwbGllZCBpbnRlcmNlcHRvciBpbnN0YW5jZSBnbG9iYWxseS5cbiAgICB0aGlzLnNldEluc3RhbmNlKClcblxuICAgIHRoaXMucmVhZHlTdGF0ZSA9IEludGVyY2VwdG9yUmVhZHlTdGF0ZS5BUFBMSUVEXG4gIH1cblxuICAvKipcbiAgICogU2V0dXAgdGhlIG1vZHVsZSBhdWdtZW50cyBhbmQgc3R1YnMgbmVjZXNzYXJ5IGZvciB0aGlzIGludGVyY2VwdG9yLlxuICAgKiBUaGlzIG1ldGhvZCBpcyBub3QgcnVuIGlmIHRoZXJlJ3MgYSBydW5uaW5nIGludGVyY2VwdG9yIGluc3RhbmNlXG4gICAqIHRvIHByZXZlbnQgaW5zdGFudGlhdGluZyBhbiBpbnRlcmNlcHRvciBtdWx0aXBsZSB0aW1lcy5cbiAgICovXG4gIHByb3RlY3RlZCBzZXR1cCgpOiB2b2lkIHt9XG5cbiAgLyoqXG4gICAqIExpc3RlbiB0byB0aGUgaW50ZXJjZXB0b3IncyBwdWJsaWMgZXZlbnRzLlxuICAgKi9cbiAgcHVibGljIG9uPEV2ZW50TmFtZSBleHRlbmRzIEV4dHJhY3RFdmVudE5hbWVzPEV2ZW50cz4+KFxuICAgIGV2ZW50OiBFdmVudE5hbWUsXG4gICAgbGlzdGVuZXI6IExpc3RlbmVyPEV2ZW50c1tFdmVudE5hbWVdPlxuICApOiB0aGlzIHtcbiAgICBjb25zdCBsb2dnZXIgPSB0aGlzLmxvZ2dlci5leHRlbmQoJ29uJylcblxuICAgIGlmIChcbiAgICAgIHRoaXMucmVhZHlTdGF0ZSA9PT0gSW50ZXJjZXB0b3JSZWFkeVN0YXRlLkRJU1BPU0lORyB8fFxuICAgICAgdGhpcy5yZWFkeVN0YXRlID09PSBJbnRlcmNlcHRvclJlYWR5U3RhdGUuRElTUE9TRURcbiAgICApIHtcbiAgICAgIGxvZ2dlci5pbmZvKCdjYW5ub3QgbGlzdGVuIHRvIGV2ZW50cywgYWxyZWFkeSBkaXNwb3NlZCEnKVxuICAgICAgcmV0dXJuIHRoaXNcbiAgICB9XG5cbiAgICBsb2dnZXIuaW5mbygnYWRkaW5nIFwiJXNcIiBldmVudCBsaXN0ZW5lcjonLCBldmVudCwgbGlzdGVuZXIpXG5cbiAgICB0aGlzLmVtaXR0ZXIub24oZXZlbnQsIGxpc3RlbmVyKVxuICAgIHJldHVybiB0aGlzXG4gIH1cblxuICBwdWJsaWMgb25jZTxFdmVudE5hbWUgZXh0ZW5kcyBFeHRyYWN0RXZlbnROYW1lczxFdmVudHM+PihcbiAgICBldmVudDogRXZlbnROYW1lLFxuICAgIGxpc3RlbmVyOiBMaXN0ZW5lcjxFdmVudHNbRXZlbnROYW1lXT5cbiAgKTogdGhpcyB7XG4gICAgdGhpcy5lbWl0dGVyLm9uY2UoZXZlbnQsIGxpc3RlbmVyKVxuICAgIHJldHVybiB0aGlzXG4gIH1cblxuICBwdWJsaWMgb2ZmPEV2ZW50TmFtZSBleHRlbmRzIEV4dHJhY3RFdmVudE5hbWVzPEV2ZW50cz4+KFxuICAgIGV2ZW50OiBFdmVudE5hbWUsXG4gICAgbGlzdGVuZXI6IExpc3RlbmVyPEV2ZW50c1tFdmVudE5hbWVdPlxuICApOiB0aGlzIHtcbiAgICB0aGlzLmVtaXR0ZXIub2ZmKGV2ZW50LCBsaXN0ZW5lcilcbiAgICByZXR1cm4gdGhpc1xuICB9XG5cbiAgcHVibGljIHJlbW92ZUFsbExpc3RlbmVyczxFdmVudE5hbWUgZXh0ZW5kcyBFeHRyYWN0RXZlbnROYW1lczxFdmVudHM+PihcbiAgICBldmVudD86IEV2ZW50TmFtZVxuICApOiB0aGlzIHtcbiAgICB0aGlzLmVtaXR0ZXIucmVtb3ZlQWxsTGlzdGVuZXJzKGV2ZW50KVxuICAgIHJldHVybiB0aGlzXG4gIH1cblxuICAvKipcbiAgICogRGlzcG9zZXMgb2YgYW55IHNpZGUtZWZmZWN0cyB0aGlzIGludGVyY2VwdG9yIGhhcyBpbnRyb2R1Y2VkLlxuICAgKi9cbiAgcHVibGljIGRpc3Bvc2UoKTogdm9pZCB7XG4gICAgY29uc3QgbG9nZ2VyID0gdGhpcy5sb2dnZXIuZXh0ZW5kKCdkaXNwb3NlJylcblxuICAgIGlmICh0aGlzLnJlYWR5U3RhdGUgPT09IEludGVyY2VwdG9yUmVhZHlTdGF0ZS5ESVNQT1NFRCkge1xuICAgICAgbG9nZ2VyLmluZm8oJ2Nhbm5vdCBkaXNwb3NlLCBhbHJlYWR5IGRpc3Bvc2VkIScpXG4gICAgICByZXR1cm5cbiAgICB9XG5cbiAgICBsb2dnZXIuaW5mbygnZGlzcG9zaW5nIHRoZSBpbnRlcmNlcHRvci4uLicpXG4gICAgdGhpcy5yZWFkeVN0YXRlID0gSW50ZXJjZXB0b3JSZWFkeVN0YXRlLkRJU1BPU0lOR1xuXG4gICAgaWYgKCF0aGlzLmdldEluc3RhbmNlKCkpIHtcbiAgICAgIGxvZ2dlci5pbmZvKCdubyBpbnRlcmNlcHRvcnMgcnVubmluZywgc2tpcHBpbmcgZGlzcG9zZS4uLicpXG4gICAgICByZXR1cm5cbiAgICB9XG5cbiAgICAvLyBEZWxldGUgdGhlIGdsb2JhbCBzeW1ib2wgYXMgc29vbiBhcyBwb3NzaWJsZSxcbiAgICAvLyBpbmRpY2F0aW5nIHRoYXQgdGhlIGludGVyY2VwdG9yIGlzIG5vIGxvbmdlciBydW5uaW5nLlxuICAgIHRoaXMuY2xlYXJJbnN0YW5jZSgpXG5cbiAgICBsb2dnZXIuaW5mbygnZ2xvYmFsIHN5bWJvbCBkZWxldGVkOicsIGdldEdsb2JhbFN5bWJvbCh0aGlzLnN5bWJvbCkpXG5cbiAgICBpZiAodGhpcy5zdWJzY3JpcHRpb25zLmxlbmd0aCA+IDApIHtcbiAgICAgIGxvZ2dlci5pbmZvKCdkaXNwb3Npbmcgb2YgJWQgc3Vic2NyaXB0aW9ucy4uLicsIHRoaXMuc3Vic2NyaXB0aW9ucy5sZW5ndGgpXG5cbiAgICAgIGZvciAoY29uc3QgZGlzcG9zZSBvZiB0aGlzLnN1YnNjcmlwdGlvbnMpIHtcbiAgICAgICAgZGlzcG9zZSgpXG4gICAgICB9XG5cbiAgICAgIHRoaXMuc3Vic2NyaXB0aW9ucyA9IFtdXG5cbiAgICAgIGxvZ2dlci5pbmZvKCdkaXNwb3NlZCBvZiBhbGwgc3Vic2NyaXB0aW9ucyEnLCB0aGlzLnN1YnNjcmlwdGlvbnMubGVuZ3RoKVxuICAgIH1cblxuICAgIHRoaXMuZW1pdHRlci5yZW1vdmVBbGxMaXN0ZW5lcnMoKVxuICAgIGxvZ2dlci5pbmZvKCdkZXN0cm95ZWQgdGhlIGxpc3RlbmVyIScpXG5cbiAgICB0aGlzLnJlYWR5U3RhdGUgPSBJbnRlcmNlcHRvclJlYWR5U3RhdGUuRElTUE9TRURcbiAgfVxuXG4gIHByaXZhdGUgZ2V0SW5zdGFuY2UoKTogdGhpcyB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgaW5zdGFuY2UgPSBnZXRHbG9iYWxTeW1ib2w8dGhpcz4odGhpcy5zeW1ib2wpXG4gICAgdGhpcy5sb2dnZXIuaW5mbygncmV0cmlldmVkIGdsb2JhbCBpbnN0YW5jZTonLCBpbnN0YW5jZT8uY29uc3RydWN0b3I/Lm5hbWUpXG4gICAgcmV0dXJuIGluc3RhbmNlXG4gIH1cblxuICBwcml2YXRlIHNldEluc3RhbmNlKCk6IHZvaWQge1xuICAgIHNldEdsb2JhbFN5bWJvbCh0aGlzLnN5bWJvbCwgdGhpcylcbiAgICB0aGlzLmxvZ2dlci5pbmZvKCdzZXQgZ2xvYmFsIGluc3RhbmNlIScsIHRoaXMuc3ltYm9sLmRlc2NyaXB0aW9uKVxuICB9XG5cbiAgcHJpdmF0ZSBjbGVhckluc3RhbmNlKCk6IHZvaWQge1xuICAgIGRlbGV0ZUdsb2JhbFN5bWJvbCh0aGlzLnN5bWJvbClcbiAgICB0aGlzLmxvZ2dlci5pbmZvKCdjbGVhcmVkIGdsb2JhbCBpbnN0YW5jZSEnLCB0aGlzLnN5bWJvbC5kZXNjcmlwdGlvbilcbiAgfVxufVxuIiwiLyoqXG4gKiBHZW5lcmF0ZSBhIHJhbmRvbSBJRCBzdHJpbmcgdG8gcmVwcmVzZW50IGEgcmVxdWVzdC5cbiAqIEBleGFtcGxlXG4gKiBjcmVhdGVSZXF1ZXN0SWQoKVxuICogLy8gXCJmNzc0YjZjOWM2MDBmXCJcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZVJlcXVlc3RJZCgpOiBzdHJpbmcge1xuICByZXR1cm4gTWF0aC5yYW5kb20oKS50b1N0cmluZygxNikuc2xpY2UoMilcbn1cbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxJQUFBQSxPQUFTLEdBQUFDLE9BQUEscUJBQWM7QUFDdkIsSUFBQUMsbUJBQVMsR0FBeUJELE9BQUE7QUFZM0IsSUFBTUUsK0JBQUEsR0FDWDtBQUVLLFNBQVNDLGdCQUFtQkMsTUFBQSxFQUErQjtFQUNoRTtJQUFBO0lBRUVDLFVBQUEsQ0FBV0QsTUFBTSxLQUFLO0VBQUE7QUFFMUI7QUFFQSxTQUFTRSxnQkFBZ0JGLE1BQUEsRUFBZ0JHLEtBQUEsRUFBa0I7RUFFekRGLFVBQUEsQ0FBV0QsTUFBTSxJQUFJRyxLQUFBO0FBQ3ZCO0FBRU8sU0FBU0MsbUJBQW1CSixNQUFBLEVBQXNCO0VBRXZELE9BQU9DLFVBQUEsQ0FBV0QsTUFBTTtBQUMxQjtBQUVPLElBQUtLLHFCQUFBLEdBQUwsZ0JBQUtDLHNCQUFBLElBQUw7RUFDTEEsc0JBQUEsZUFBVztFQUNYQSxzQkFBQSxlQUFXO0VBQ1hBLHNCQUFBLGNBQVU7RUFDVkEsc0JBQUEsZ0JBQVk7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