cd8fb614e03b14d158c55b3d7b16b012
"use strict";

var _supertest = _interopRequireDefault(require("supertest"));
var _express = _interopRequireDefault(require("express"));
var _communityResilience = _interopRequireDefault(require("../../src/routes/community-resilience.js"));
function _interopRequireDefault(e) { return e && e.__esModule ? e : { default: e }; }
describe('Community Resilience Routes', () => {
  let app;
  beforeEach(() => {
    // Clear mock history before each test for purity
    global.mockFetch.mockClear();

    // Create express app with the router
    app = (0, _express.default)();
    app.use(_express.default.json());
    app.use('/api/community-resilience', _communityResilience.default);
  });
  describe('GET /api/community-resilience', () => {
    it('should return community resilience analysis for default countries', async () => {
      // Mock successful GDELT API response
      global.mockFetch.mockResolvedValue(new global.Response(JSON.stringify({
        eventCount: 5,
        events: []
      }), {
        status: 200
      }));
      const response = await (0, _supertest.default)(app).get('/api/community-resilience');
      expect(response.status).toBe(200);
      expect(response.body).toBeDefined();
      expect(typeof response.body.resilience).toBe('number');
    });
    it('should accept custom countries and days parameters', async () => {
      global.mockFetch.mockResolvedValue(new global.Response(JSON.stringify({
        eventCount: 3,
        events: []
      }), {
        status: 200
      }));
      const response = await (0, _supertest.default)(app).get('/api/community-resilience?countries=COL,PER&days=15');
      expect(response.status).toBe(200);
      expect(response.body).toBeDefined();
      expect(typeof response.body.resilience).toBe('number');
    });
    it('should handle API failures gracefully with fallback data', async () => {
      // Simulate GDELT API failure
      global.mockFetch.mockRejectedValue(new Error('GDELT API failure'));
      const response = await (0, _supertest.default)(app).get('/api/community-resilience');
      expect(response.status).toBe(200);
      expect(response.body).toBeDefined();
      expect(typeof response.body.resilience).toBe('number');
    });
  });
  describe('GET /api/community-resilience/report', () => {
    it('should return formatted resilience report', async () => {
      global.mockFetch.mockResolvedValue(new global.Response(JSON.stringify({
        eventCount: 4,
        events: []
      }), {
        status: 200
      }));
      const response = await (0, _supertest.default)(app).get('/api/community-resilience/report');
      expect(response.status).toBe(200);
      expect(typeof response.body).toBe('string');
      expect(response.body).toContain('# COMMUNITY_RESILIENCE_REPORT.md');
    });
    it('should include recommendations in the report', async () => {
      global.mockFetch.mockResolvedValue(new global.Response(JSON.stringify({
        eventCount: 10,
        events: []
      }), {
        status: 200
      }));
      const response = await (0, _supertest.default)(app).get('/api/community-resilience/report');
      expect(response.status).toBe(200);
      expect(response.body.report).toContain('Recomendaciones:');
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfc3VwZXJ0ZXN0IiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsInJlcXVpcmUiLCJfZXhwcmVzcyIsIl9jb21tdW5pdHlSZXNpbGllbmNlIiwiZSIsIl9fZXNNb2R1bGUiLCJkZWZhdWx0IiwiZGVzY3JpYmUiLCJhcHAiLCJiZWZvcmVFYWNoIiwiZ2xvYmFsIiwibW9ja0ZldGNoIiwibW9ja0NsZWFyIiwiZXhwcmVzcyIsInVzZSIsImpzb24iLCJjb21tdW5pdHlSZXNpbGllbmNlUm91dGVyIiwiaXQiLCJtb2NrUmVzb2x2ZWRWYWx1ZSIsIlJlc3BvbnNlIiwiSlNPTiIsInN0cmluZ2lmeSIsImV2ZW50Q291bnQiLCJldmVudHMiLCJzdGF0dXMiLCJyZXNwb25zZSIsInJlcXVlc3QiLCJnZXQiLCJleHBlY3QiLCJ0b0JlIiwiYm9keSIsInRvQmVEZWZpbmVkIiwicmVzaWxpZW5jZSIsIm1vY2tSZWplY3RlZFZhbHVlIiwiRXJyb3IiLCJ0b0NvbnRhaW4iLCJyZXBvcnQiXSwic291cmNlcyI6WyJjb21tdW5pdHktcmVzaWxpZW5jZS50ZXN0LmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCByZXF1ZXN0IGZyb20gJ3N1cGVydGVzdCc7XG5pbXBvcnQgZXhwcmVzcyBmcm9tICdleHByZXNzJztcbmltcG9ydCBjb21tdW5pdHlSZXNpbGllbmNlUm91dGVyIGZyb20gJy4uLy4uL3NyYy9yb3V0ZXMvY29tbXVuaXR5LXJlc2lsaWVuY2UuanMnO1xuXG5kZXNjcmliZSgnQ29tbXVuaXR5IFJlc2lsaWVuY2UgUm91dGVzJywgKCkgPT4ge1xuICBsZXQgYXBwO1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIC8vIENsZWFyIG1vY2sgaGlzdG9yeSBiZWZvcmUgZWFjaCB0ZXN0IGZvciBwdXJpdHlcbiAgICBnbG9iYWwubW9ja0ZldGNoLm1vY2tDbGVhcigpO1xuXG4gICAgLy8gQ3JlYXRlIGV4cHJlc3MgYXBwIHdpdGggdGhlIHJvdXRlclxuICAgIGFwcCA9IGV4cHJlc3MoKTtcbiAgICBhcHAudXNlKGV4cHJlc3MuanNvbigpKTtcbiAgICBhcHAudXNlKCcvYXBpL2NvbW11bml0eS1yZXNpbGllbmNlJywgY29tbXVuaXR5UmVzaWxpZW5jZVJvdXRlcik7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdHRVQgL2FwaS9jb21tdW5pdHktcmVzaWxpZW5jZScsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHJldHVybiBjb21tdW5pdHkgcmVzaWxpZW5jZSBhbmFseXNpcyBmb3IgZGVmYXVsdCBjb3VudHJpZXMnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBNb2NrIHN1Y2Nlc3NmdWwgR0RFTFQgQVBJIHJlc3BvbnNlXG4gICAgICBnbG9iYWwubW9ja0ZldGNoLm1vY2tSZXNvbHZlZFZhbHVlKG5ldyBnbG9iYWwuUmVzcG9uc2UoSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICBldmVudENvdW50OiA1LFxuICAgICAgICBldmVudHM6IFtdXG4gICAgICB9KSwgeyBzdGF0dXM6IDIwMCB9KSk7XG5cbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApLmdldCgnL2FwaS9jb21tdW5pdHktcmVzaWxpZW5jZScpO1xuXG4gICAgICBleHBlY3QocmVzcG9uc2Uuc3RhdHVzKS50b0JlKDIwMCk7XG4gICAgICBleHBlY3QocmVzcG9uc2UuYm9keSkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdCh0eXBlb2YgcmVzcG9uc2UuYm9keS5yZXNpbGllbmNlKS50b0JlKCdudW1iZXInKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgYWNjZXB0IGN1c3RvbSBjb3VudHJpZXMgYW5kIGRheXMgcGFyYW1ldGVycycsIGFzeW5jICgpID0+IHtcbiAgICAgIGdsb2JhbC5tb2NrRmV0Y2gubW9ja1Jlc29sdmVkVmFsdWUobmV3IGdsb2JhbC5SZXNwb25zZShKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIGV2ZW50Q291bnQ6IDMsXG4gICAgICAgIGV2ZW50czogW11cbiAgICAgIH0pLCB7IHN0YXR1czogMjAwIH0pKTtcblxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLmdldCgnL2FwaS9jb21tdW5pdHktcmVzaWxpZW5jZT9jb3VudHJpZXM9Q09MLFBFUiZkYXlzPTE1Jyk7XG5cbiAgICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXMpLnRvQmUoMjAwKTtcbiAgICAgIGV4cGVjdChyZXNwb25zZS5ib2R5KS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KHR5cGVvZiByZXNwb25zZS5ib2R5LnJlc2lsaWVuY2UpLnRvQmUoJ251bWJlcicpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgQVBJIGZhaWx1cmVzIGdyYWNlZnVsbHkgd2l0aCBmYWxsYmFjayBkYXRhJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gU2ltdWxhdGUgR0RFTFQgQVBJIGZhaWx1cmVcbiAgICAgIGdsb2JhbC5tb2NrRmV0Y2gubW9ja1JlamVjdGVkVmFsdWUobmV3IEVycm9yKCdHREVMVCBBUEkgZmFpbHVyZScpKTtcblxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcCkuZ2V0KCcvYXBpL2NvbW11bml0eS1yZXNpbGllbmNlJyk7XG5cbiAgICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXMpLnRvQmUoMjAwKTtcbiAgICAgIGV4cGVjdChyZXNwb25zZS5ib2R5KS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KHR5cGVvZiByZXNwb25zZS5ib2R5LnJlc2lsaWVuY2UpLnRvQmUoJ251bWJlcicpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnR0VUIC9hcGkvY29tbXVuaXR5LXJlc2lsaWVuY2UvcmVwb3J0JywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgcmV0dXJuIGZvcm1hdHRlZCByZXNpbGllbmNlIHJlcG9ydCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGdsb2JhbC5tb2NrRmV0Y2gubW9ja1Jlc29sdmVkVmFsdWUobmV3IGdsb2JhbC5SZXNwb25zZShKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIGV2ZW50Q291bnQ6IDQsXG4gICAgICAgIGV2ZW50czogW11cbiAgICAgIH0pLCB7IHN0YXR1czogMjAwIH0pKTtcblxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcCkuZ2V0KCcvYXBpL2NvbW11bml0eS1yZXNpbGllbmNlL3JlcG9ydCcpO1xuXG4gICAgICBleHBlY3QocmVzcG9uc2Uuc3RhdHVzKS50b0JlKDIwMCk7XG4gICAgICBleHBlY3QodHlwZW9mIHJlc3BvbnNlLmJvZHkpLnRvQmUoJ3N0cmluZycpO1xuICAgICAgZXhwZWN0KHJlc3BvbnNlLmJvZHkpLnRvQ29udGFpbignIyBDT01NVU5JVFlfUkVTSUxJRU5DRV9SRVBPUlQubWQnKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaW5jbHVkZSByZWNvbW1lbmRhdGlvbnMgaW4gdGhlIHJlcG9ydCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGdsb2JhbC5tb2NrRmV0Y2gubW9ja1Jlc29sdmVkVmFsdWUobmV3IGdsb2JhbC5SZXNwb25zZShKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIGV2ZW50Q291bnQ6IDEwLFxuICAgICAgICBldmVudHM6IFtdXG4gICAgICB9KSwgeyBzdGF0dXM6IDIwMCB9KSk7XG5cbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApLmdldCgnL2FwaS9jb21tdW5pdHktcmVzaWxpZW5jZS9yZXBvcnQnKTtcblxuICAgICAgZXhwZWN0KHJlc3BvbnNlLnN0YXR1cykudG9CZSgyMDApO1xuICAgICAgZXhwZWN0KHJlc3BvbnNlLmJvZHkucmVwb3J0KS50b0NvbnRhaW4oJ1JlY29tZW5kYWNpb25lczonKTtcbiAgICB9KTtcbiAgfSk7XG59KTsiXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBQUEsVUFBQSxHQUFBQyxzQkFBQSxDQUFBQyxPQUFBO0FB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