7121293efc91367a60ccba33f3caf0ab
"use strict";

var __defProp = Object.defineProperty;
var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
var __getOwnPropNames = Object.getOwnPropertyNames;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __export = (target, all) => {
  for (var name in all) __defProp(target, name, {
    get: all[name],
    enumerable: true
  });
};
var __copyProps = (to, from, except, desc) => {
  if (from && typeof from === "object" || typeof from === "function") {
    for (let key of __getOwnPropNames(from)) if (!__hasOwnProp.call(to, key) && key !== except) __defProp(to, key, {
      get: () => from[key],
      enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable
    });
  }
  return to;
};
var __toCommonJS = mod => __copyProps(__defProp({}, "__esModule", {
  value: true
}), mod);
var WebSocketClientManager_exports = {};
__export(WebSocketClientManager_exports, {
  WebSocketClientManager: () => WebSocketClientManager,
  WebSocketRemoteClientConnection: () => WebSocketRemoteClientConnection
});
module.exports = __toCommonJS(WebSocketClientManager_exports);
var import_WebSocketMemoryClientStore = require("./WebSocketMemoryClientStore");
var import_WebSocketIndexedDBClientStore = require("./WebSocketIndexedDBClientStore");
class WebSocketClientManager {
  constructor(channel) {
    this.channel = channel;
    this.store = typeof indexedDB !== "undefined" ? new import_WebSocketIndexedDBClientStore.WebSocketIndexedDBClientStore() : new import_WebSocketMemoryClientStore.WebSocketMemoryClientStore();
    this.runtimeClients = /* @__PURE__ */new Map();
    this.allClients = /* @__PURE__ */new Set();
    this.channel.addEventListener("message", message => {
      if (message.data?.type === "db:update") {
        this.flushDatabaseToMemory();
      }
    });
    if (typeof window !== "undefined") {
      window.addEventListener("message", async message => {
        if (message.data?.type === "msw/worker:stop") {
          await this.removeRuntimeClients();
        }
      });
    }
  }
  store;
  runtimeClients;
  allClients;
  async flushDatabaseToMemory() {
    const storedClients = await this.store.getAll();
    this.allClients = new Set(storedClients.map(client => {
      const runtimeClient = this.runtimeClients.get(client.id);
      if (runtimeClient) {
        return runtimeClient;
      }
      return new WebSocketRemoteClientConnection(client.id, new URL(client.url), this.channel);
    }));
  }
  async removeRuntimeClients() {
    await this.store.deleteMany(Array.from(this.runtimeClients.keys()));
    this.runtimeClients.clear();
    await this.flushDatabaseToMemory();
    this.notifyOthersAboutDatabaseUpdate();
  }
  /**
   * All active WebSocket client connections.
   */
  get clients() {
    return this.allClients;
  }
  /**
   * Notify other runtimes about the database update
   * using the shared `BroadcastChannel` instance.
   */
  notifyOthersAboutDatabaseUpdate() {
    this.channel.postMessage({
      type: "db:update"
    });
  }
  async addClient(client) {
    await this.store.add(client);
    await this.flushDatabaseToMemory();
    this.notifyOthersAboutDatabaseUpdate();
  }
  /**
   * Adds the given `WebSocket` client connection to the set
   * of all connections. The given connection is always the complete
   * connection object because `addConnection()` is called only
   * for the opened connections in the same runtime.
   */
  async addConnection(client) {
    this.runtimeClients.set(client.id, client);
    await this.addClient(client);
    const handleExtraneousMessage = message => {
      const {
        type,
        payload
      } = message.data;
      if (typeof payload === "object" && "clientId" in payload && payload.clientId !== client.id) {
        return;
      }
      switch (type) {
        case "extraneous:send":
          {
            client.send(payload.data);
            break;
          }
        case "extraneous:close":
          {
            client.close(payload.code, payload.reason);
            break;
          }
      }
    };
    const abortController = new AbortController();
    this.channel.addEventListener("message", handleExtraneousMessage, {
      signal: abortController.signal
    });
    client.addEventListener("close", () => abortController.abort(), {
      once: true
    });
  }
}
class WebSocketRemoteClientConnection {
  constructor(id, url, channel) {
    this.id = id;
    this.url = url;
    this.channel = channel;
  }
  send(data) {
    this.channel.postMessage({
      type: "extraneous:send",
      payload: {
        clientId: this.id,
        data
      }
    });
  }
  close(code, reason) {
    this.channel.postMessage({
      type: "extraneous:close",
      payload: {
        clientId: this.id,
        code,
        reason
      }
    });
  }
  addEventListener(_type, _listener, _options) {
    throw new Error("WebSocketRemoteClientConnection.addEventListener is not supported");
  }
  removeEventListener(_event, _listener, _options) {
    throw new Error("WebSocketRemoteClientConnection.removeEventListener is not supported");
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJXZWJTb2NrZXRDbGllbnRNYW5hZ2VyX2V4cG9ydHMiLCJfX2V4cG9ydCIsIldlYlNvY2tldENsaWVudE1hbmFnZXIiLCJXZWJTb2NrZXRSZW1vdGVDbGllbnRDb25uZWN0aW9uIiwibW9kdWxlIiwiZXhwb3J0cyIsIl9fdG9Db21tb25KUyIsImltcG9ydF9XZWJTb2NrZXRNZW1vcnlDbGllbnRTdG9yZSIsInJlcXVpcmUiLCJpbXBvcnRfV2ViU29ja2V0SW5kZXhlZERCQ2xpZW50U3RvcmUiLCJjb25zdHJ1Y3RvciIsImNoYW5uZWwiLCJzdG9yZSIsImluZGV4ZWREQiIsIldlYlNvY2tldEluZGV4ZWREQkNsaWVudFN0b3JlIiwiV2ViU29ja2V0TWVtb3J5Q2xpZW50U3RvcmUiLCJydW50aW1lQ2xpZW50cyIsIk1hcCIsImFsbENsaWVudHMiLCJTZXQiLCJhZGRFdmVudExpc3RlbmVyIiwibWVzc2FnZSIsImRhdGEiLCJ0eXBlIiwiZmx1c2hEYXRhYmFzZVRvTWVtb3J5Iiwid2luZG93IiwicmVtb3ZlUnVudGltZUNsaWVudHMiLCJzdG9yZWRDbGllbnRzIiwiZ2V0QWxsIiwibWFwIiwiY2xpZW50IiwicnVudGltZUNsaWVudCIsImdldCIsImlkIiwiVVJMIiwidXJsIiwiZGVsZXRlTWFueSIsIkFycmF5IiwiZnJvbSIsImtleXMiLCJjbGVhciIsIm5vdGlmeU90aGVyc0Fib3V0RGF0YWJhc2VVcGRhdGUiLCJjbGllbnRzIiwicG9zdE1lc3NhZ2UiLCJhZGRDbGllbnQiLCJhZGQiLCJhZGRDb25uZWN0aW9uIiwic2V0IiwiaGFuZGxlRXh0cmFuZW91c01lc3NhZ2UiLCJwYXlsb2FkIiwiY2xpZW50SWQiLCJzZW5kIiwiY2xvc2UiLCJjb2RlIiwicmVhc29uIiwiYWJvcnRDb250cm9sbGVyIiwiQWJvcnRDb250cm9sbGVyIiwic2lnbmFsIiwiYWJvcnQiLCJvbmNlIiwiX3R5cGUiLCJfbGlzdGVuZXIiLCJfb3B0aW9ucyIsIkVycm9yIiwicmVtb3ZlRXZlbnRMaXN0ZW5lciIsIl9ldmVudCJdLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb3JlL3dzL1dlYlNvY2tldENsaWVudE1hbmFnZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUge1xuICBXZWJTb2NrZXREYXRhLFxuICBXZWJTb2NrZXRDbGllbnRDb25uZWN0aW9uUHJvdG9jb2wsXG4gIFdlYlNvY2tldENsaWVudEV2ZW50TWFwLFxufSBmcm9tICdAbXN3anMvaW50ZXJjZXB0b3JzL1dlYlNvY2tldCdcbmltcG9ydCB7IFdlYlNvY2tldENsaWVudFN0b3JlIH0gZnJvbSAnLi9XZWJTb2NrZXRDbGllbnRTdG9yZSdcbmltcG9ydCB7IFdlYlNvY2tldE1lbW9yeUNsaWVudFN0b3JlIH0gZnJvbSAnLi9XZWJTb2NrZXRNZW1vcnlDbGllbnRTdG9yZSdcbmltcG9ydCB7IFdlYlNvY2tldEluZGV4ZWREQkNsaWVudFN0b3JlIH0gZnJvbSAnLi9XZWJTb2NrZXRJbmRleGVkREJDbGllbnRTdG9yZSdcblxuZXhwb3J0IHR5cGUgV2ViU29ja2V0QnJvYWRjYXN0Q2hhbm5lbE1lc3NhZ2UgPVxuICB8IHtcbiAgICAgIHR5cGU6ICdleHRyYW5lb3VzOnNlbmQnXG4gICAgICBwYXlsb2FkOiB7XG4gICAgICAgIGNsaWVudElkOiBzdHJpbmdcbiAgICAgICAgZGF0YTogV2ViU29ja2V0RGF0YVxuICAgICAgfVxuICAgIH1cbiAgfCB7XG4gICAgICB0eXBlOiAnZXh0cmFuZW91czpjbG9zZSdcbiAgICAgIHBheWxvYWQ6IHtcbiAgICAgICAgY2xpZW50SWQ6IHN0cmluZ1xuICAgICAgICBjb2RlPzogbnVtYmVyXG4gICAgICAgIHJlYXNvbj86IHN0cmluZ1xuICAgICAgfVxuICAgIH1cblxuLyoqXG4gKiBBIG1hbmFnZXIgcmVzcG9uc2libGUgZm9yIGFjY3VtdWxhdGluZyBXZWJTb2NrZXQgY2xpZW50XG4gKiBjb25uZWN0aW9ucyBhY3Jvc3MgZGlmZmVyZW50IGJyb3dzZXIgcnVudGltZXMuXG4gKi9cbmV4cG9ydCBjbGFzcyBXZWJTb2NrZXRDbGllbnRNYW5hZ2VyIHtcbiAgcHJpdmF0ZSBzdG9yZTogV2ViU29ja2V0Q2xpZW50U3RvcmVcbiAgcHJpdmF0ZSBydW50aW1lQ2xpZW50czogTWFwPHN0cmluZywgV2ViU29ja2V0Q2xpZW50Q29ubmVjdGlvblByb3RvY29sPlxuICBwcml2YXRlIGFsbENsaWVudHM6IFNldDxXZWJTb2NrZXRDbGllbnRDb25uZWN0aW9uUHJvdG9jb2w+XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBjaGFubmVsOiBCcm9hZGNhc3RDaGFubmVsKSB7XG4gICAgLy8gU3RvcmUgdGhlIGNsaWVudHMgaW4gdGhlIEluZGV4ZWREQiBpbiB0aGUgYnJvd3NlcixcbiAgICAvLyBvdGhlcndpc2UsIHN0b3JlIHRoZSBjbGllbnRzIGluIG1lbW9yeS5cbiAgICB0aGlzLnN0b3JlID1cbiAgICAgIHR5cGVvZiBpbmRleGVkREIgIT09ICd1bmRlZmluZWQnXG4gICAgICAgID8gbmV3IFdlYlNvY2tldEluZGV4ZWREQkNsaWVudFN0b3JlKClcbiAgICAgICAgOiBuZXcgV2ViU29ja2V0TWVtb3J5Q2xpZW50U3RvcmUoKVxuXG4gICAgdGhpcy5ydW50aW1lQ2xpZW50cyA9IG5ldyBNYXAoKVxuICAgIHRoaXMuYWxsQ2xpZW50cyA9IG5ldyBTZXQoKVxuXG4gICAgdGhpcy5jaGFubmVsLmFkZEV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCAobWVzc2FnZSkgPT4ge1xuICAgICAgaWYgKG1lc3NhZ2UuZGF0YT8udHlwZSA9PT0gJ2RiOnVwZGF0ZScpIHtcbiAgICAgICAgdGhpcy5mbHVzaERhdGFiYXNlVG9NZW1vcnkoKVxuICAgICAgfVxuICAgIH0pXG5cbiAgICBpZiAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgYXN5bmMgKG1lc3NhZ2UpID0+IHtcbiAgICAgICAgaWYgKG1lc3NhZ2UuZGF0YT8udHlwZSA9PT0gJ21zdy93b3JrZXI6c3RvcCcpIHtcbiAgICAgICAgICBhd2FpdCB0aGlzLnJlbW92ZVJ1bnRpbWVDbGllbnRzKClcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGZsdXNoRGF0YWJhc2VUb01lbW9yeSgpIHtcbiAgICBjb25zdCBzdG9yZWRDbGllbnRzID0gYXdhaXQgdGhpcy5zdG9yZS5nZXRBbGwoKVxuXG4gICAgdGhpcy5hbGxDbGllbnRzID0gbmV3IFNldChcbiAgICAgIHN0b3JlZENsaWVudHMubWFwKChjbGllbnQpID0+IHtcbiAgICAgICAgY29uc3QgcnVudGltZUNsaWVudCA9IHRoaXMucnVudGltZUNsaWVudHMuZ2V0KGNsaWVudC5pZClcblxuICAgICAgICAvKipcbiAgICAgICAgICogQG5vdGUgRm9yIGNsaWVudHMgb3JpZ2luYXRpbmcgaW4gdGhpcyBydW50aW1lLCB1c2UgdGhlaXJcbiAgICAgICAgICogZGlyZWN0IHJlZmVyZW5jZXMuIE5vIG5lZWQgdG8gd3JhcCB0aGVtIGluIGEgcmVtb3RlIGNvbm5lY3Rpb24uXG4gICAgICAgICAqL1xuICAgICAgICBpZiAocnVudGltZUNsaWVudCkge1xuICAgICAgICAgIHJldHVybiBydW50aW1lQ2xpZW50XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbmV3IFdlYlNvY2tldFJlbW90ZUNsaWVudENvbm5lY3Rpb24oXG4gICAgICAgICAgY2xpZW50LmlkLFxuICAgICAgICAgIG5ldyBVUkwoY2xpZW50LnVybCksXG4gICAgICAgICAgdGhpcy5jaGFubmVsLFxuICAgICAgICApXG4gICAgICB9KSxcbiAgICApXG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHJlbW92ZVJ1bnRpbWVDbGllbnRzKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGF3YWl0IHRoaXMuc3RvcmUuZGVsZXRlTWFueShBcnJheS5mcm9tKHRoaXMucnVudGltZUNsaWVudHMua2V5cygpKSlcbiAgICB0aGlzLnJ1bnRpbWVDbGllbnRzLmNsZWFyKClcbiAgICBhd2FpdCB0aGlzLmZsdXNoRGF0YWJhc2VUb01lbW9yeSgpXG4gICAgdGhpcy5ub3RpZnlPdGhlcnNBYm91dERhdGFiYXNlVXBkYXRlKClcbiAgfVxuXG4gIC8qKlxuICAgKiBBbGwgYWN0aXZlIFdlYlNvY2tldCBjbGllbnQgY29ubmVjdGlvbnMuXG4gICAqL1xuICBnZXQgY2xpZW50cygpOiBTZXQ8V2ViU29ja2V0Q2xpZW50Q29ubmVjdGlvblByb3RvY29sPiB7XG4gICAgcmV0dXJuIHRoaXMuYWxsQ2xpZW50c1xuICB9XG5cbiAgLyoqXG4gICAqIE5vdGlmeSBvdGhlciBydW50aW1lcyBhYm91dCB0aGUgZGF0YWJhc2UgdXBkYXRlXG4gICAqIHVzaW5nIHRoZSBzaGFyZWQgYEJyb2FkY2FzdENoYW5uZWxgIGluc3RhbmNlLlxuICAgKi9cbiAgcHJpdmF0ZSBub3RpZnlPdGhlcnNBYm91dERhdGFiYXNlVXBkYXRlKCk6IHZvaWQge1xuICAgIHRoaXMuY2hhbm5lbC5wb3N0TWVzc2FnZSh7IHR5cGU6ICdkYjp1cGRhdGUnIH0pXG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGFkZENsaWVudChcbiAgICBjbGllbnQ6IFdlYlNvY2tldENsaWVudENvbm5lY3Rpb25Qcm90b2NvbCxcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgdGhpcy5zdG9yZS5hZGQoY2xpZW50KVxuICAgIC8vIFN5bmMgdGhlIGluLW1lbW9yeSBjbGllbnRzIGluIHRoaXMgcnVudGltZSB3aXRoIHRoZVxuICAgIC8vIHVwZGF0ZWQgZGF0YWJhc2UuIFRoaXMgcHVsbHMgaW4gYWxsIHRoZSBzdG9yZWQgY2xpZW50cy5cbiAgICBhd2FpdCB0aGlzLmZsdXNoRGF0YWJhc2VUb01lbW9yeSgpXG4gICAgdGhpcy5ub3RpZnlPdGhlcnNBYm91dERhdGFiYXNlVXBkYXRlKClcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGRzIHRoZSBnaXZlbiBgV2ViU29ja2V0YCBjbGllbnQgY29ubmVjdGlvbiB0byB0aGUgc2V0XG4gICAqIG9mIGFsbCBjb25uZWN0aW9ucy4gVGhlIGdpdmVuIGNvbm5lY3Rpb24gaXMgYWx3YXlzIHRoZSBjb21wbGV0ZVxuICAgKiBjb25uZWN0aW9uIG9iamVjdCBiZWNhdXNlIGBhZGRDb25uZWN0aW9uKClgIGlzIGNhbGxlZCBvbmx5XG4gICAqIGZvciB0aGUgb3BlbmVkIGNvbm5lY3Rpb25zIGluIHRoZSBzYW1lIHJ1bnRpbWUuXG4gICAqL1xuICBwdWJsaWMgYXN5bmMgYWRkQ29ubmVjdGlvbihcbiAgICBjbGllbnQ6IFdlYlNvY2tldENsaWVudENvbm5lY3Rpb25Qcm90b2NvbCxcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgLy8gU3RvcmUgdGhpcyBjbGllbnQgaW4gdGhlIG1hcCBvZiBjbGllbnRzIGNyZWF0ZWQgaW4gdGhpcyBydW50aW1lLlxuICAgIC8vIFRoaXMgd2F5LCB0aGUgbWFuYWdlciBjYW4gZGlzdGluZ3Vpc2ggYmV0d2VlbiB0aGlzIHJ1bnRpbWUgY2xpZW50c1xuICAgIC8vIGFuZCBleHRyYW5lb3VzIHJ1bnRpbWUgY2xpZW50cyB3aGVuIHN5bmNocm9uaXppbmcgY2xpZW50cyBzdG9yYWdlLlxuICAgIHRoaXMucnVudGltZUNsaWVudHMuc2V0KGNsaWVudC5pZCwgY2xpZW50KVxuXG4gICAgLy8gQWRkIHRoZSBuZXcgY2xpZW50IHRvIHRoZSBzdG9yYWdlLlxuICAgIGF3YWl0IHRoaXMuYWRkQ2xpZW50KGNsaWVudClcblxuICAgIC8vIEhhbmRsZSB0aGUgaW5jb21pbmcgQnJvYWRjYXN0Q2hhbm5lbCBtZXNzYWdlcyBmcm9tIG90aGVyIHJ1bnRpbWVzXG4gICAgLy8gdGhhdCBhdHRlbXB0IHRvIGNvbnRyb2wgdGhpcyBydW50aW1lICh2aWEgYSByZW1vdGUgY29ubmVjdGlvbiB3cmFwcGVyKS5cbiAgICAvLyBFLmcuIGFub3RoZXIgcnVudGltZSBjYWxsaW5nIGBjbGllbnQuc2VuZCgpYCBmb3IgdGhlIGNsaWVudCBpbiB0aGlzIHJ1bnRpbWUuXG4gICAgY29uc3QgaGFuZGxlRXh0cmFuZW91c01lc3NhZ2UgPSAoXG4gICAgICBtZXNzYWdlOiBNZXNzYWdlRXZlbnQ8V2ViU29ja2V0QnJvYWRjYXN0Q2hhbm5lbE1lc3NhZ2U+LFxuICAgICkgPT4ge1xuICAgICAgY29uc3QgeyB0eXBlLCBwYXlsb2FkIH0gPSBtZXNzYWdlLmRhdGFcblxuICAgICAgLy8gSWdub3JlIGJyb2FkY2FzdGVkIG1lc3NhZ2VzIGZvciBvdGhlciBjbGllbnRzLlxuICAgICAgaWYgKFxuICAgICAgICB0eXBlb2YgcGF5bG9hZCA9PT0gJ29iamVjdCcgJiZcbiAgICAgICAgJ2NsaWVudElkJyBpbiBwYXlsb2FkICYmXG4gICAgICAgIHBheWxvYWQuY2xpZW50SWQgIT09IGNsaWVudC5pZFxuICAgICAgKSB7XG4gICAgICAgIHJldHVyblxuICAgICAgfVxuXG4gICAgICBzd2l0Y2ggKHR5cGUpIHtcbiAgICAgICAgY2FzZSAnZXh0cmFuZW91czpzZW5kJzoge1xuICAgICAgICAgIGNsaWVudC5zZW5kKHBheWxvYWQuZGF0YSlcbiAgICAgICAgICBicmVha1xuICAgICAgICB9XG5cbiAgICAgICAgY2FzZSAnZXh0cmFuZW91czpjbG9zZSc6IHtcbiAgICAgICAgICBjbGllbnQuY2xvc2UocGF5bG9hZC5jb2RlLCBwYXlsb2FkLnJlYXNvbilcbiAgICAgICAgICBicmVha1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgYWJvcnRDb250cm9sbGVyID0gbmV3IEFib3J0Q29udHJvbGxlcigpXG5cbiAgICB0aGlzLmNoYW5uZWwuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIGhhbmRsZUV4dHJhbmVvdXNNZXNzYWdlLCB7XG4gICAgICBzaWduYWw6IGFib3J0Q29udHJvbGxlci5zaWduYWwsXG4gICAgfSlcblxuICAgIC8vIE9uY2UgY2xvc2VkLCB0aGlzIGNvbm5lY3Rpb24gY2Fubm90IGJlIG9wZXJhdGVkIG9uLlxuICAgIC8vIFRoaXMgbXVzdCBpbmNsdWRlIHRoZSBleHRyYW5lb3VzIHJ1bnRpbWVzIGFzIHdlbGwuXG4gICAgY2xpZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2Nsb3NlJywgKCkgPT4gYWJvcnRDb250cm9sbGVyLmFib3J0KCksIHtcbiAgICAgIG9uY2U6IHRydWUsXG4gICAgfSlcbiAgfVxufVxuXG4vKipcbiAqIEEgd3JhcHBlciBjbGFzcyB0byBvcGVyYXRlIHdpdGggV2ViU29ja2V0IGNsaWVudCBjb25uZWN0aW9uc1xuICogZnJvbSBvdGhlciBydW50aW1lcy4gVGhpcyBjbGFzcyBtYWludGFpbnMgMS0xIHB1YmxpYyBBUElcbiAqIGNvbXBhdGliaWxpdHkgdG8gdGhlIGBXZWJTb2NrZXRDbGllbnRDb25uZWN0aW9uYCBidXQgcmVsaWVzXG4gKiBvbiB0aGUgZ2l2ZW4gYEJyb2FkY2FzdENoYW5uZWxgIHRvIGNvbW11bmljYXRlIGluc3RydWN0aW9uc1xuICogd2l0aCB0aGUgY2xpZW50IGNvbm5lY3Rpb25zIGZyb20gb3RoZXIgcnVudGltZXMuXG4gKi9cbmV4cG9ydCBjbGFzcyBXZWJTb2NrZXRSZW1vdGVDbGllbnRDb25uZWN0aW9uXG4gIGltcGxlbWVudHMgV2ViU29ja2V0Q2xpZW50Q29ubmVjdGlvblByb3RvY29sXG57XG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyByZWFkb25seSBpZDogc3RyaW5nLFxuICAgIHB1YmxpYyByZWFkb25seSB1cmw6IFVSTCxcbiAgICBwcml2YXRlIGNoYW5uZWw6IEJyb2FkY2FzdENoYW5uZWwsXG4gICkge31cblxuICBzZW5kKGRhdGE6IFdlYlNvY2tldERhdGEpOiB2b2lkIHtcbiAgICB0aGlzLmNoYW5uZWwucG9zdE1lc3NhZ2Uoe1xuICAgICAgdHlwZTogJ2V4dHJhbmVvdXM6c2VuZCcsXG4gICAgICBwYXlsb2FkOiB7XG4gICAgICAgIGNsaWVudElkOiB0aGlzLmlkLFxuICAgICAgICBkYXRhLFxuICAgICAgfSxcbiAgICB9IGFzIFdlYlNvY2tldEJyb2FkY2FzdENoYW5uZWxNZXNzYWdlKVxuICB9XG5cbiAgY2xvc2UoY29kZT86IG51bWJlciB8IHVuZGVmaW5lZCwgcmVhc29uPzogc3RyaW5nIHwgdW5kZWZpbmVkKTogdm9pZCB7XG4gICAgdGhpcy5jaGFubmVsLnBvc3RNZXNzYWdlKHtcbiAgICAgIHR5cGU6ICdleHRyYW5lb3VzOmNsb3NlJyxcbiAgICAgIHBheWxvYWQ6IHtcbiAgICAgICAgY2xpZW50SWQ6IHRoaXMuaWQsXG4gICAgICAgIGNvZGUsXG4gICAgICAgIHJlYXNvbixcbiAgICAgIH0sXG4gICAgfSBhcyBXZWJTb2NrZXRCcm9hZGNhc3RDaGFubmVsTWVzc2FnZSlcbiAgfVxuXG4gIGFkZEV2ZW50TGlzdGVuZXI8RXZlbnRUeXBlIGV4dGVuZHMga2V5b2YgV2ViU29ja2V0Q2xpZW50RXZlbnRNYXA+KFxuICAgIF90eXBlOiBFdmVudFR5cGUsXG4gICAgX2xpc3RlbmVyOiAoXG4gICAgICB0aGlzOiBXZWJTb2NrZXQsXG4gICAgICBldmVudDogV2ViU29ja2V0Q2xpZW50RXZlbnRNYXBbRXZlbnRUeXBlXSxcbiAgICApID0+IHZvaWQsXG4gICAgX29wdGlvbnM/OiBBZGRFdmVudExpc3RlbmVyT3B0aW9ucyB8IGJvb2xlYW4sXG4gICk6IHZvaWQge1xuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICdXZWJTb2NrZXRSZW1vdGVDbGllbnRDb25uZWN0aW9uLmFkZEV2ZW50TGlzdGVuZXIgaXMgbm90IHN1cHBvcnRlZCcsXG4gICAgKVxuICB9XG5cbiAgcmVtb3ZlRXZlbnRMaXN0ZW5lcjxFdmVudFR5cGUgZXh0ZW5kcyBrZXlvZiBXZWJTb2NrZXRDbGllbnRFdmVudE1hcD4oXG4gICAgX2V2ZW50OiBFdmVudFR5cGUsXG4gICAgX2xpc3RlbmVyOiAoXG4gICAgICB0aGlzOiBXZWJTb2NrZXQsXG4gICAgICBldmVudDogV2ViU29ja2V0Q2xpZW50RXZlbnRNYXBbRXZlbnRUeXBlXSxcbiAgICApID0+IHZvaWQsXG4gICAgX29wdGlvbnM/OiBFdmVudExpc3RlbmVyT3B0aW9ucyB8IGJvb2xlYW4sXG4gICk6IHZvaWQge1xuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICdXZWJTb2NrZXRSZW1vdGVDbGllbnRDb25uZWN0aW9uLnJlbW92ZUV2ZW50TGlzdGVuZXIgaXMgbm90IHN1cHBvcnRlZCcsXG4gICAgKVxuICB9XG59XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLElBQUFBLDhCQUFBO0FBQUFDLFFBQUEsQ0FBQUQsOEJBQUE7RUFBQUUsc0JBQUEsRUFBQUEsQ0FBQSxLQUFBQSxzQkFBQTtFQUFBQywrQkFBQSxFQUFBQSxDQUFBLEtBQUFBO0FBQUE7QUFBQUMsTUFBQSxDQUFBQyxPQUFBLEdBQUFDLFlBQUEsQ0FBQU4sOEJBQUE7QUFNQSxJQUFBTyxpQ0FBQSxHQUEyQ0MsT0FBQTtBQUMzQyxJQUFBQyxvQ0FBQSxHQUE4Q0QsT0FBQTtBQXVCdkMsTUFBTU4sc0JBQUEsQ0FBdUI7RUFLbENRLFlBQW9CQyxPQUFBLEVBQTJCO0lBQTNCLEtBQUFBLE9BQUEsR0FBQUEsT0FBQTtJQUdsQixLQUFLQyxLQUFBLEdBQ0gsT0FBT0MsU0FBQSxLQUFjLGNBQ2pCLElBQUlKLG9DQUFBLENBQUFLLDZCQUFBLENBQThCLElBQ2xDLElBQUlQLGlDQUFBLENBQUFRLDBCQUFBLENBQTJCO0lBRXJDLEtBQUtDLGNBQUEsR0FBaUIsbUJBQUlDLEdBQUEsQ0FBSTtJQUM5QixLQUFLQyxVQUFBLEdBQWEsbUJBQUlDLEdBQUEsQ0FBSTtJQUUxQixLQUFLUixPQUFBLENBQVFTLGdCQUFBLENBQWlCLFdBQVlDLE9BQUEsSUFBWTtNQUNwRCxJQUFJQSxPQUFBLENBQVFDLElBQUEsRUFBTUMsSUFBQSxLQUFTLGFBQWE7UUFDdEMsS0FBS0MscUJBQUEsQ0FBc0I7TUFDN0I7SUFDRixDQUFDO0lBRUQsSUFBSSxPQUFPQyxNQUFBLEtBQVcsYUFBYTtNQUNqQ0EsTUFBQSxDQUFPTCxnQkFBQSxDQUFpQixXQUFXLE1BQU9DLE9BQUEsSUFBWTtR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