{"version":3,"names":["request","require","express","describe","afterEach","jest","resetModules","restoreAllMocks","test","isolateModulesAsync","doMock","getChromaClient","fn","access","mockResolvedValue","readFile","JSON","stringify","id","routerMod","router","default","app","use","res","get","set","expect","statusCode","toBe","body","source","Array","isArray","items","fakeCollection","ids","documents","metadatas","timestamp","Date","now","getOrCreateCollection"],"sources":["consciousness.route.test.js"],"sourcesContent":["const request = require('supertest');\nconst express = require('express');\n\ndescribe('/api/consciousness route', () => {\n  afterEach(() => {\n    jest.resetModules();\n    jest.restoreAllMocks();\n  });\n\n  test('returns local fallback when chroma client unavailable', async () => {\n    await jest.isolateModulesAsync(async () => {\n      jest.doMock('../../src/database.js', () => ({ getChromaClient: jest.fn(() => null) }));\n      jest.doMock('fs/promises', () => ({\n        access: jest.fn().mockResolvedValue(true),\n        readFile: jest.fn().mockResolvedValue(JSON.stringify({ id: 'a' }) + '\\n')\n      }));\n\n      const routerMod = require('../../src/routes/consciousness.js');\n      let router = routerMod;\n      if (router && router.default) router = router.default;\n\n      const app = express();\n      app.use('/api/consciousness', router);\n\n      const res = await request(app).get('/api/consciousness').set('Host', 'localhost');\n      expect(res.statusCode).toBe(200);\n      expect(res.body.source).toBe('local');\n      expect(Array.isArray(res.body.items)).toBe(true);\n    });\n  });\n\n  test('returns chroma source when client provides collection', async () => {\n    await jest.isolateModulesAsync(async () => {\n      const fakeCollection = { get: jest.fn().mockResolvedValue({ ids: ['id1'], documents: ['err'], metadatas: [{ timestamp: Date.now() }] }) };\n      jest.doMock('../../src/database.js', () => ({ getChromaClient: jest.fn(() => ({ getOrCreateCollection: jest.fn().mockResolvedValue(fakeCollection) })) }));\n\n      const routerMod = require('../../src/routes/consciousness.js');\n      let router = routerMod;\n      if (router && router.default) router = router.default;\n\n      const app = express();\n      app.use('/api/consciousness', router);\n\n      const res = await request(app).get('/api/consciousness').set('Host', 'localhost');\n      expect(res.statusCode).toBe(200);\n      expect(res.body.source).toBe('chroma');\n      expect(Array.isArray(res.body.items)).toBe(true);\n      expect(res.body.items[0].id).toBe('id1');\n    });\n  });\n});\n"],"mappings":"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","ignoreList":[]}