ffbc3c3a37d4b9ae2d4357dd0cb88a07
"use strict";

const express = require('express');
const request = require('supertest');
describe('routes/gdelt.js - router', () => {
  beforeEach(() => {
    jest.resetModules();
    process.env.NODE_ENV = 'test';
  });
  afterEach(() => {
    delete process.env.FORCE_MOCKS;
    delete process.env.NODE_ENV;
    jest.clearAllMocks();
  });
  test('GET /api/gdelt/events returns 400 when missing params', async () => {
    // No need to mock integration for validation failure
    const gdeltRouter = require('../../src/routes/gdelt.js').default || require('../../src/routes/gdelt.js');
    const app = express();
    app.use('/api/gdelt', gdeltRouter);
    const res = await request(app).get('/api/gdelt/events');
    expect(res.status).toBe(400);
    expect(res.body).toHaveProperty('error');
  });
  test('GET /api/gdelt/events returns data from GdeltIntegration', async () => {
    const mockData = {
      country: 'COL',
      period: {
        start: '2025-01-01',
        end: '2025-01-02'
      },
      eventCount: 2,
      socialIntensity: 3.5,
      articles: [{
        title: 'A',
        url: 'u1'
      }, {
        title: 'B',
        url: 'u2'
      }],
      isMock: true
    };

    // Mock the integration before importing the router
    jest.doMock('../../src/integrations/GdeltIntegration.js', () => {
      return jest.fn().mockImplementation(() => ({
        getSocialEvents: jest.fn().mockResolvedValue(mockData)
      }));
    });
    const gdeltRouter = require('../../src/routes/gdelt.js').default || require('../../src/routes/gdelt.js');
    const app = express();
    app.use('/api/gdelt', gdeltRouter);
    const res = await request(app).get('/api/gdelt/events').query({
      country: 'COL',
      startDate: '2025-01-01',
      endDate: '2025-01-02'
    });
    expect(res.status).toBe(200);
    expect(res.body).toMatchObject({
      country: 'COL'
    });
    expect(res.body).toHaveProperty('articles');
    expect(Array.isArray(res.body.articles)).toBe(true);
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJleHByZXNzIiwicmVxdWlyZSIsInJlcXVlc3QiLCJkZXNjcmliZSIsImJlZm9yZUVhY2giLCJqZXN0IiwicmVzZXRNb2R1bGVzIiwicHJvY2VzcyIsImVudiIsIk5PREVfRU5WIiwiYWZ0ZXJFYWNoIiwiRk9SQ0VfTU9DS1MiLCJjbGVhckFsbE1vY2tzIiwidGVzdCIsImdkZWx0Um91dGVyIiwiZGVmYXVsdCIsImFwcCIsInVzZSIsInJlcyIsImdldCIsImV4cGVjdCIsInN0YXR1cyIsInRvQmUiLCJib2R5IiwidG9IYXZlUHJvcGVydHkiLCJtb2NrRGF0YSIsImNvdW50cnkiLCJwZXJpb2QiLCJzdGFydCIsImVuZCIsImV2ZW50Q291bnQiLCJzb2NpYWxJbnRlbnNpdHkiLCJhcnRpY2xlcyIsInRpdGxlIiwidXJsIiwiaXNNb2NrIiwiZG9Nb2NrIiwiZm4iLCJtb2NrSW1wbGVtZW50YXRpb24iLCJnZXRTb2NpYWxFdmVudHMiLCJtb2NrUmVzb2x2ZWRWYWx1ZSIsInF1ZXJ5Iiwic3RhcnREYXRlIiwiZW5kRGF0ZSIsInRvTWF0Y2hPYmplY3QiLCJBcnJheSIsImlzQXJyYXkiXSwic291cmNlcyI6WyJnZGVsdC51bml0LnRlc3QuanMiXSwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgZXhwcmVzcyA9IHJlcXVpcmUoJ2V4cHJlc3MnKVxuY29uc3QgcmVxdWVzdCA9IHJlcXVpcmUoJ3N1cGVydGVzdCcpXG5cbmRlc2NyaWJlKCdyb3V0ZXMvZ2RlbHQuanMgLSByb3V0ZXInLCAoKSA9PiB7XG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIGplc3QucmVzZXRNb2R1bGVzKClcbiAgICBwcm9jZXNzLmVudi5OT0RFX0VOViA9ICd0ZXN0J1xuICB9KVxuXG4gIGFmdGVyRWFjaCgoKSA9PiB7XG4gICAgZGVsZXRlIHByb2Nlc3MuZW52LkZPUkNFX01PQ0tTXG4gICAgZGVsZXRlIHByb2Nlc3MuZW52Lk5PREVfRU5WXG4gICAgamVzdC5jbGVhckFsbE1vY2tzKClcbiAgfSlcblxuICB0ZXN0KCdHRVQgL2FwaS9nZGVsdC9ldmVudHMgcmV0dXJucyA0MDAgd2hlbiBtaXNzaW5nIHBhcmFtcycsIGFzeW5jICgpID0+IHtcbiAgICAvLyBObyBuZWVkIHRvIG1vY2sgaW50ZWdyYXRpb24gZm9yIHZhbGlkYXRpb24gZmFpbHVyZVxuICAgIGNvbnN0IGdkZWx0Um91dGVyID0gcmVxdWlyZSgnLi4vLi4vc3JjL3JvdXRlcy9nZGVsdC5qcycpLmRlZmF1bHQgfHwgcmVxdWlyZSgnLi4vLi4vc3JjL3JvdXRlcy9nZGVsdC5qcycpXG4gICAgY29uc3QgYXBwID0gZXhwcmVzcygpXG4gICAgYXBwLnVzZSgnL2FwaS9nZGVsdCcsIGdkZWx0Um91dGVyKVxuXG4gICAgY29uc3QgcmVzID0gYXdhaXQgcmVxdWVzdChhcHApLmdldCgnL2FwaS9nZGVsdC9ldmVudHMnKVxuICAgIGV4cGVjdChyZXMuc3RhdHVzKS50b0JlKDQwMClcbiAgICBleHBlY3QocmVzLmJvZHkpLnRvSGF2ZVByb3BlcnR5KCdlcnJvcicpXG4gIH0pXG5cbiAgdGVzdCgnR0VUIC9hcGkvZ2RlbHQvZXZlbnRzIHJldHVybnMgZGF0YSBmcm9tIEdkZWx0SW50ZWdyYXRpb24nLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgbW9ja0RhdGEgPSB7XG4gICAgICBjb3VudHJ5OiAnQ09MJyxcbiAgICAgIHBlcmlvZDogeyBzdGFydDogJzIwMjUtMDEtMDEnLCBlbmQ6ICcyMDI1LTAxLTAyJyB9LFxuICAgICAgZXZlbnRDb3VudDogMixcbiAgICAgIHNvY2lhbEludGVuc2l0eTogMy41LFxuICAgICAgYXJ0aWNsZXM6IFt7IHRpdGxlOiAnQScsIHVybDogJ3UxJyB9LCB7IHRpdGxlOiAnQicsIHVybDogJ3UyJyB9XSxcbiAgICAgIGlzTW9jazogdHJ1ZVxuICAgIH1cblxuICAgIC8vIE1vY2sgdGhlIGludGVncmF0aW9uIGJlZm9yZSBpbXBvcnRpbmcgdGhlIHJvdXRlclxuICAgIGplc3QuZG9Nb2NrKCcuLi8uLi9zcmMvaW50ZWdyYXRpb25zL0dkZWx0SW50ZWdyYXRpb24uanMnLCAoKSA9PiB7XG4gICAgICByZXR1cm4gamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiAoe1xuICAgICAgICBnZXRTb2NpYWxFdmVudHM6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZShtb2NrRGF0YSlcbiAgICAgIH0pKVxuICAgIH0pXG5cbiAgICBjb25zdCBnZGVsdFJvdXRlciA9IHJlcXVpcmUoJy4uLy4uL3NyYy9yb3V0ZXMvZ2RlbHQuanMnKS5kZWZhdWx0IHx8IHJlcXVpcmUoJy4uLy4uL3NyYy9yb3V0ZXMvZ2RlbHQuanMnKVxuICAgIGNvbnN0IGFwcCA9IGV4cHJlc3MoKVxuICAgIGFwcC51c2UoJy9hcGkvZ2RlbHQnLCBnZGVsdFJvdXRlcilcblxuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgLmdldCgnL2FwaS9nZGVsdC9ldmVudHMnKVxuICAgICAgLnF1ZXJ5KHsgY291bnRyeTogJ0NPTCcsIHN0YXJ0RGF0ZTogJzIwMjUtMDEtMDEnLCBlbmREYXRlOiAnMjAyNS0wMS0wMicgfSlcblxuICAgIGV4cGVjdChyZXMuc3RhdHVzKS50b0JlKDIwMClcbiAgICBleHBlY3QocmVzLmJvZHkpLnRvTWF0Y2hPYmplY3QoeyBjb3VudHJ5OiAnQ09MJyB9KVxuICAgIGV4cGVjdChyZXMuYm9keSkudG9IYXZlUHJvcGVydHkoJ2FydGljbGVzJylcbiAgICBleHBlY3QoQXJyYXkuaXNBcnJheShyZXMuYm9keS5hcnRpY2xlcykpLnRvQmUodHJ1ZSlcbiAgfSlcbn0pXG4iXSwibWFwcGluZ3MiOiI7O0FBQUEsTUFBTUEsT0FBTyxHQUFHQyxPQUFPLENBQUMsU0FBUyxDQUFDO0FBQ2xDLE1BQU1DLE9BQU8sR0FBR0QsT0FBTyxDQUFDLFdBQVcsQ0FBQztBQUVwQ0UsUUFBUSxDQUFDLDBCQUEwQixFQUFFLE1BQU07RUFDekNDLFVBQVUsQ0FBQyxNQUFNO0lBQ2ZDLElBQUksQ0FBQ0MsWUFBWSxDQUFD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