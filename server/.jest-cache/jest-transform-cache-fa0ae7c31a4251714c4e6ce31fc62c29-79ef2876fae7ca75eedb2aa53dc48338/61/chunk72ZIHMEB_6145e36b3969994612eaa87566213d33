60c126941a90a9efb2dacc5782103760
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
}); // src/RequestController.ts
var _outvariant = require('outvariant');
var _deferredpromise = require('@open-draft/deferred-promise');

// src/InterceptorError.ts
var InterceptorError = class extends Error {
  constructor(message) {
    super(message);
    this.name = "InterceptorError";
    Object.setPrototypeOf(this, InterceptorError.prototype);
  }
};

// src/RequestController.ts
var kRequestHandled = Symbol("kRequestHandled");
var kResponsePromise = Symbol("kResponsePromise");
var RequestController = class {
  constructor(request) {
    this.request = request;
    this[kRequestHandled] = false;
    this[kResponsePromise] = new (0, _deferredpromise.DeferredPromise)();
  }
  /**
   * Respond to this request with the given `Response` instance.
   * @example
   * controller.respondWith(new Response())
   * controller.respondWith(Response.json({ id }))
   * controller.respondWith(Response.error())
   */
  respondWith(response) {
    _outvariant.invariant.as(InterceptorError, !this[kRequestHandled], 'Failed to respond to the "%s %s" request: the "request" event has already been handled.', this.request.method, this.request.url);
    this[kRequestHandled] = true;
    this[kResponsePromise].resolve(response);
  }
  /**
   * Error this request with the given reason.
   *
   * @example
   * controller.errorWith()
   * controller.errorWith(new Error('Oops!'))
   * controller.errorWith({ message: 'Oops!'})
   */
  errorWith(reason) {
    _outvariant.invariant.as(InterceptorError, !this[kRequestHandled], 'Failed to error the "%s %s" request: the "request" event has already been handled.', this.request.method, this.request.url);
    this[kRequestHandled] = true;
    this[kResponsePromise].resolve(reason);
  }
};
kResponsePromise, kRequestHandled;

// src/utils/emitAsync.ts
async function emitAsync(emitter, eventName, ...data) {
  const listeners = emitter.listeners(eventName);
  if (listeners.length === 0) {
    return;
  }
  for (const listener of listeners) {
    await listener.apply(emitter, data);
  }
}

// src/utils/handleRequest.ts

var _until = require('@open-draft/until');

// src/utils/isObject.ts
function isObject(value, loose = false) {
  return loose ? Object.prototype.toString.call(value).startsWith("[object ") : Object.prototype.toString.call(value) === "[object Object]";
}

// src/utils/isPropertyAccessible.ts
function isPropertyAccessible(obj, key) {
  try {
    obj[key];
    return true;
  } catch (e) {
    return false;
  }
}

// src/utils/responseUtils.ts
function createServerErrorResponse(body) {
  return new Response(JSON.stringify(body instanceof Error ? {
    name: body.name,
    message: body.message,
    stack: body.stack
  } : body), {
    status: 500,
    statusText: "Unhandled Exception",
    headers: {
      "Content-Type": "application/json"
    }
  });
}
function isResponseError(response) {
  return response != null && response instanceof Response && isPropertyAccessible(response, "type") && response.type === "error";
}
function isResponseLike(value) {
  return isObject(value, true) && isPropertyAccessible(value, "status") && isPropertyAccessible(value, "statusText") && isPropertyAccessible(value, "bodyUsed");
}

// src/utils/isNodeLikeError.ts
function isNodeLikeError(error) {
  if (error == null) {
    return false;
  }
  if (!(error instanceof Error)) {
    return false;
  }
  return "code" in error && "errno" in error;
}

// src/utils/handleRequest.ts
async function handleRequest(options) {
  const handleResponse = async response => {
    if (response instanceof Error) {
      options.onError(response);
      return true;
    }
    if (isResponseError(response)) {
      options.onRequestError(response);
      return true;
    }
    if (isResponseLike(response)) {
      await options.onResponse(response);
      return true;
    }
    if (isObject(response)) {
      options.onError(response);
      return true;
    }
    return false;
  };
  const handleResponseError = async error => {
    if (error instanceof InterceptorError) {
      throw result.error;
    }
    if (isNodeLikeError(error)) {
      options.onError(error);
      return true;
    }
    if (error instanceof Response) {
      return await handleResponse(error);
    }
    return false;
  };
  options.emitter.once("request", ({
    requestId: pendingRequestId
  }) => {
    if (pendingRequestId !== options.requestId) {
      return;
    }
    if (options.controller[kResponsePromise].state === "pending") {
      options.controller[kResponsePromise].resolve(void 0);
    }
  });
  const requestAbortPromise = new (0, _deferredpromise.DeferredPromise)();
  if (options.request.signal) {
    if (options.request.signal.aborted) {
      requestAbortPromise.reject(options.request.signal.reason);
    } else {
      options.request.signal.addEventListener("abort", () => {
        requestAbortPromise.reject(options.request.signal.reason);
      }, {
        once: true
      });
    }
  }
  const result = await _until.until.call(void 0, async () => {
    const requestListenersPromise = emitAsync(options.emitter, "request", {
      requestId: options.requestId,
      request: options.request,
      controller: options.controller
    });
    await Promise.race([
    // Short-circuit the request handling promise if the request gets aborted.
    requestAbortPromise, requestListenersPromise, options.controller[kResponsePromise]]);
    return await options.controller[kResponsePromise];
  });
  if (requestAbortPromise.state === "rejected") {
    options.onError(requestAbortPromise.rejectionReason);
    return true;
  }
  if (result.error) {
    if (await handleResponseError(result.error)) {
      return true;
    }
    if (options.emitter.listenerCount("unhandledException") > 0) {
      const unhandledExceptionController = new RequestController(options.request);
      await emitAsync(options.emitter, "unhandledException", {
        error: result.error,
        request: options.request,
        requestId: options.requestId,
        controller: unhandledExceptionController
      }).then(() => {
        if (unhandledExceptionController[kResponsePromise].state === "pending") {
          unhandledExceptionController[kResponsePromise].resolve(void 0);
        }
      });
      const nextResult = await _until.until.call(void 0, () => unhandledExceptionController[kResponsePromise]);
      if (nextResult.error) {
        return handleResponseError(nextResult.error);
      }
      if (nextResult.data) {
        return handleResponse(nextResult.data);
      }
    }
    options.onResponse(createServerErrorResponse(result.error));
    return true;
  }
  if (result.data) {
    return handleResponse(result.data);
  }
  return false;
}
exports.isPropertyAccessible = isPropertyAccessible;
exports.isObject = isObject;
exports.createServerErrorResponse = createServerErrorResponse;
exports.RequestController = RequestController;
exports.emitAsync = emitAsync;
exports.handleRequest = handleRequest;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfb3V0dmFyaWFudCIsInJlcXVpcmUiLCJfZGVmZXJyZWRwcm9taXNlIiwiSW50ZXJjZXB0b3JFcnJvciIsIkVycm9yIiwiY29uc3RydWN0b3IiLCJtZXNzYWdlIiwibmFtZSIsIk9iamVjdCIsInNldFByb3RvdHlwZU9mIiwicHJvdG90eXBlIiwia1JlcXVlc3RIYW5kbGVkIiwiU3ltYm9sIiwia1Jlc3BvbnNlUHJvbWlzZSIsIlJlcXVlc3RDb250cm9sbGVyIiwicmVxdWVzdCIsIkRlZmVycmVkUHJvbWlzZSIsInJlc3BvbmRXaXRoIiwicmVzcG9uc2UiLCJpbnZhcmlhbnQiLCJhcyIsIm1ldGhvZCIsInVybCIsInJlc29sdmUiLCJlcnJvcldpdGgiLCJyZWFzb24iLCJlbWl0QXN5bmMiLCJlbWl0dGVyIiwiZXZlbnROYW1lIiwiZGF0YSIsImxpc3RlbmVycyIsImxlbmd0aCIsImxpc3RlbmVyIiwiYXBwbHkiLCJfdW50aWwiLCJpc09iamVjdCIsInZhbHVlIiwibG9vc2UiLCJ0b1N0cmluZyIsImNhbGwiLCJzdGFydHNXaXRoIiwiaXNQcm9wZXJ0eUFjY2Vzc2libGUiLCJvYmoiLCJrZXkiLCJlIiwiY3JlYXRlU2VydmVyRXJyb3JSZXNwb25zZSIsImJvZHkiLCJSZXNwb25zZSIsIkpTT04iLCJzdHJpbmdpZnkiLCJzdGFjayIsInN0YXR1cyIsInN0YXR1c1RleHQiLCJoZWFkZXJzIiwiaXNSZXNwb25zZUVycm9yIiwidHlwZSIsImlzUmVzcG9uc2VMaWtlIiwiaXNOb2RlTGlrZUVycm9yIiwiZXJyb3IiLCJoYW5kbGVSZXF1ZXN0Iiwib3B0aW9ucyIsImhhbmRsZVJlc3BvbnNlIiwib25FcnJvciIsIm9uUmVxdWVzdEVycm9yIiwib25SZXNwb25zZSIsImhhbmRsZVJlc3BvbnNlRXJyb3IiLCJyZXN1bHQiLCJvbmNlIiwicmVxdWVzdElkIiwicGVuZGluZ1JlcXVlc3RJZCIsImNvbnRyb2xsZXIiLCJzdGF0ZSIsInJlcXVlc3RBYm9ydFByb21pc2UiLCJzaWduYWwiLCJhYm9ydGVkIiwicmVqZWN0IiwiYWRkRXZlbnRMaXN0ZW5lciIsInVudGlsIiwicmVxdWVzdExpc3RlbmVyc1Byb21pc2UiLCJQcm9taXNlIiwicmFjZSIsInJlamVjdGlvblJlYXNvbiIsImxpc3RlbmVyQ291bnQiLCJ1bmhhbmRsZWRFeGNlcHRpb25Db250cm9sbGVyIiwidGhlbiIsIm5leHRSZXN1bHQiXSwic291cmNlcyI6WyIuLi8uLi9zcmMvUmVxdWVzdENvbnRyb2xsZXIudHMiLCIuLi8uLi9zcmMvSW50ZXJjZXB0b3JFcnJvci50cyIsIi4uLy4uL3NyYy91dGlscy9lbWl0QXN5bmMudHMiLCIuLi8uLi9zcmMvdXRpbHMvaGFuZGxlUmVxdWVzdC50cyIsIi4uLy4uL3NyYy91dGlscy9pc09iamVjdC50cyIsIi4uLy4uL3NyYy91dGlscy9pc1Byb3BlcnR5QWNjZXNzaWJsZS50cyIsIi4uLy4uL3NyYy91dGlscy9yZXNwb25zZVV0aWxzLnRzIiwiLi4vLi4vc3JjL3V0aWxzL2lzTm9kZUxpa2VFcnJvci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBpbnZhcmlhbnQgfSBmcm9tICdvdXR2YXJpYW50J1xuaW1wb3J0IHsgRGVmZXJyZWRQcm9taXNlIH0gZnJvbSAnQG9wZW4tZHJhZnQvZGVmZXJyZWQtcHJvbWlzZSdcbmltcG9ydCB7IEludGVyY2VwdG9yRXJyb3IgfSBmcm9tICcuL0ludGVyY2VwdG9yRXJyb3InXG5cbmNvbnN0IGtSZXF1ZXN0SGFuZGxlZCA9IFN5bWJvbCgna1JlcXVlc3RIYW5kbGVkJylcbmV4cG9ydCBjb25zdCBrUmVzcG9uc2VQcm9taXNlID0gU3ltYm9sKCdrUmVzcG9uc2VQcm9taXNlJylcblxuZXhwb3J0IGNsYXNzIFJlcXVlc3RDb250cm9sbGVyIHtcbiAgLyoqXG4gICAqIEludGVybmFsIHJlc3BvbnNlIHByb21pc2UuXG4gICAqIEF2YWlsYWJsZSBvbmx5IGZvciB0aGUgbGlicmFyeSBpbnRlcm5hbHMgdG8gZ3JhYiB0aGVcbiAgICogcmVzcG9uc2UgaW5zdGFuY2UgcHJvdmlkZWQgYnkgdGhlIGRldmVsb3Blci5cbiAgICogQG5vdGUgVGhpcyBwcm9taXNlIGNhbm5vdCBiZSByZWplY3RlZC4gSXQncyBlaXRoZXIgaW5maW5pdGVseVxuICAgKiBwZW5kaW5nIG9yIHJlc29sdmVkIHdpdGggd2hpY2hldmVyIFJlc3BvbnNlIHdhcyBwYXNzZWQgdG8gYHJlc3BvbmRXaXRoKClgLlxuICAgKi9cbiAgW2tSZXNwb25zZVByb21pc2VdOiBEZWZlcnJlZFByb21pc2U8XG4gICAgUmVzcG9uc2UgfCBSZWNvcmQ8c3RyaW5nLCBhbnk+IHwgdW5kZWZpbmVkXG4gID47XG5cbiAgLyoqXG4gICAqIEludGVybmFsIGZsYWcgaW5kaWNhdGluZyBpZiB0aGlzIHJlcXVlc3QgaGFzIGJlZW4gaGFuZGxlZC5cbiAgICogQG5vdGUgVGhlIHJlc3BvbnNlIHByb21pc2UgYmVjb21lcyBcImZ1bGZpbGxlZFwiIG9uIHRoZSBuZXh0IHRpY2suXG4gICAqL1xuICBba1JlcXVlc3RIYW5kbGVkXTogYm9vbGVhblxuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVxdWVzdDogUmVxdWVzdCkge1xuICAgIHRoaXNba1JlcXVlc3RIYW5kbGVkXSA9IGZhbHNlXG4gICAgdGhpc1trUmVzcG9uc2VQcm9taXNlXSA9IG5ldyBEZWZlcnJlZFByb21pc2UoKVxuICB9XG5cbiAgLyoqXG4gICAqIFJlc3BvbmQgdG8gdGhpcyByZXF1ZXN0IHdpdGggdGhlIGdpdmVuIGBSZXNwb25zZWAgaW5zdGFuY2UuXG4gICAqIEBleGFtcGxlXG4gICAqIGNvbnRyb2xsZXIucmVzcG9uZFdpdGgobmV3IFJlc3BvbnNlKCkpXG4gICAqIGNvbnRyb2xsZXIucmVzcG9uZFdpdGgoUmVzcG9uc2UuanNvbih7IGlkIH0pKVxuICAgKiBjb250cm9sbGVyLnJlc3BvbmRXaXRoKFJlc3BvbnNlLmVycm9yKCkpXG4gICAqL1xuICBwdWJsaWMgcmVzcG9uZFdpdGgocmVzcG9uc2U6IFJlc3BvbnNlKTogdm9pZCB7XG4gICAgaW52YXJpYW50LmFzKFxuICAgICAgSW50ZXJjZXB0b3JFcnJvcixcbiAgICAgICF0aGlzW2tSZXF1ZXN0SGFuZGxlZF0sXG4gICAgICAnRmFpbGVkIHRvIHJlc3BvbmQgdG8gdGhlIFwiJXMgJXNcIiByZXF1ZXN0OiB0aGUgXCJyZXF1ZXN0XCIgZXZlbnQgaGFzIGFscmVhZHkgYmVlbiBoYW5kbGVkLicsXG4gICAgICB0aGlzLnJlcXVlc3QubWV0aG9kLFxuICAgICAgdGhpcy5yZXF1ZXN0LnVybFxuICAgIClcblxuICAgIHRoaXNba1JlcXVlc3RIYW5kbGVkXSA9IHRydWVcbiAgICB0aGlzW2tSZXNwb25zZVByb21pc2VdLnJlc29sdmUocmVzcG9uc2UpXG5cbiAgICAvKipcbiAgICAgKiBAbm90ZSBUaGUgcmVxdWVzdCBjb250cm9sbGVyIGRvZXNuJ3QgZG8gYW55dGhpbmdcbiAgICAgKiBhcGFydCBmcm9tIGxldHRpbmcgdGhlIGludGVyY2VwdG9yIGF3YWl0IHRoZSByZXNwb25zZVxuICAgICAqIHByb3ZpZGVkIGJ5IHRoZSBkZXZlbG9wZXIgdGhyb3VnaCB0aGUgcmVzcG9uc2UgcHJvbWlzZS5cbiAgICAgKiBFYWNoIGludGVyY2VwdG9yIGltcGxlbWVudHMgdGhlIGFjdHVhbCByZXNwb25kV2l0aC9lcnJvcldpdGhcbiAgICAgKiBsb2dpYyBiYXNlZCBvbiB0aGF0IGludGVyY2VwdG9yJ3MgbmVlZHMuXG4gICAgICovXG4gIH1cblxuICAvKipcbiAgICogRXJyb3IgdGhpcyByZXF1ZXN0IHdpdGggdGhlIGdpdmVuIHJlYXNvbi5cbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogY29udHJvbGxlci5lcnJvcldpdGgoKVxuICAgKiBjb250cm9sbGVyLmVycm9yV2l0aChuZXcgRXJyb3IoJ09vcHMhJykpXG4gICAqIGNvbnRyb2xsZXIuZXJyb3JXaXRoKHsgbWVzc2FnZTogJ09vcHMhJ30pXG4gICAqL1xuICBwdWJsaWMgZXJyb3JXaXRoKHJlYXNvbj86IEVycm9yIHwgUmVjb3JkPHN0cmluZywgYW55Pik6IHZvaWQge1xuICAgIGludmFyaWFudC5hcyhcbiAgICAgIEludGVyY2VwdG9yRXJyb3IsXG4gICAgICAhdGhpc1trUmVxdWVzdEhhbmRsZWRdLFxuICAgICAgJ0ZhaWxlZCB0byBlcnJvciB0aGUgXCIlcyAlc1wiIHJlcXVlc3Q6IHRoZSBcInJlcXVlc3RcIiBldmVudCBoYXMgYWxyZWFkeSBiZWVuIGhhbmRsZWQuJyxcbiAgICAgIHRoaXMucmVxdWVzdC5tZXRob2QsXG4gICAgICB0aGlzLnJlcXVlc3QudXJsXG4gICAgKVxuXG4gICAgdGhpc1trUmVxdWVzdEhhbmRsZWRdID0gdHJ1ZVxuXG4gICAgLyoqXG4gICAgICogQG5vdGUgUmVzb2x2ZSB0aGUgcmVzcG9uc2UgcHJvbWlzZSwgbm90IHJlamVjdC5cbiAgICAgKiBUaGlzIGhlbHBzIHVzIGRpZmZlcmVudGlhdGUgYmV0d2VlbiB1bmhhbmRsZWQgZXhjZXB0aW9uc1xuICAgICAqIGFuZCBpbnRlbmRlZCBlcnJvcnMgKFwiZXJyb3JXaXRoXCIpIHdoaWxlIHdhaXRpbmcgZm9yIHRoZSByZXNwb25zZS5cbiAgICAgKi9cbiAgICB0aGlzW2tSZXNwb25zZVByb21pc2VdLnJlc29sdmUocmVhc29uKVxuICB9XG59XG4iLCJleHBvcnQgY2xhc3MgSW50ZXJjZXB0b3JFcnJvciBleHRlbmRzIEVycm9yIHtcbiAgY29uc3RydWN0b3IobWVzc2FnZT86IHN0cmluZykge1xuICAgIHN1cGVyKG1lc3NhZ2UpXG4gICAgdGhpcy5uYW1lID0gJ0ludGVyY2VwdG9yRXJyb3InXG4gICAgT2JqZWN0LnNldFByb3RvdHlwZU9mKHRoaXMsIEludGVyY2VwdG9yRXJyb3IucHJvdG90eXBlKVxuICB9XG59XG4iLCJpbXBvcnQgeyBFbWl0dGVyLCBFdmVudE1hcCB9IGZyb20gJ3N0cmljdC1ldmVudC1lbWl0dGVyJ1xuXG4vKipcbiAqIEVtaXRzIGFuIGV2ZW50IG9uIHRoZSBnaXZlbiBlbWl0dGVyIGJ1dCBleGVjdXRlc1xuICogdGhlIGxpc3RlbmVycyBzZXF1ZW50aWFsbHkuIFRoaXMgYWNjb3VudHMgZm9yIGFzeW5jaHJvbm91c1xuICogbGlzdGVuZXJzIChlLmcuIHRob3NlIGhhdmluZyBcInNsZWVwXCIgYW5kIGhhbmRsaW5nIHRoZSByZXF1ZXN0KS5cbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGVtaXRBc3luYzxcbiAgRXZlbnRzIGV4dGVuZHMgRXZlbnRNYXAsXG4gIEV2ZW50TmFtZSBleHRlbmRzIGtleW9mIEV2ZW50c1xuPihcbiAgZW1pdHRlcjogRW1pdHRlcjxFdmVudHM+LFxuICBldmVudE5hbWU6IEV2ZW50TmFtZSxcbiAgLi4uZGF0YTogRXZlbnRzW0V2ZW50TmFtZV1cbik6IFByb21pc2U8dm9pZD4ge1xuICBjb25zdCBsaXN0ZW5lcnMgPSBlbWl0dGVyLmxpc3RlbmVycyhldmVudE5hbWUpXG5cbiAgaWYgKGxpc3RlbmVycy5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm5cbiAgfVxuXG4gIGZvciAoY29uc3QgbGlzdGVuZXIgb2YgbGlzdGVuZXJzKSB7XG4gICAgYXdhaXQgbGlzdGVuZXIuYXBwbHkoZW1pdHRlciwgZGF0YSlcbiAgfVxufVxuIiwiaW1wb3J0IHR5cGUgeyBFbWl0dGVyIH0gZnJvbSAnc3RyaWN0LWV2ZW50LWVtaXR0ZXInXG5pbXBvcnQgeyBEZWZlcnJlZFByb21pc2UgfSBmcm9tICdAb3Blbi1kcmFmdC9kZWZlcnJlZC1wcm9taXNlJ1xuaW1wb3J0IHsgdW50aWwgfSBmcm9tICdAb3Blbi1kcmFmdC91bnRpbCdcbmltcG9ydCB0eXBlIHsgSHR0cFJlcXVlc3RFdmVudE1hcCB9IGZyb20gJy4uL2dsb3NzYXJ5J1xuaW1wb3J0IHsgZW1pdEFzeW5jIH0gZnJvbSAnLi9lbWl0QXN5bmMnXG5pbXBvcnQgeyBrUmVzcG9uc2VQcm9taXNlLCBSZXF1ZXN0Q29udHJvbGxlciB9IGZyb20gJy4uL1JlcXVlc3RDb250cm9sbGVyJ1xuaW1wb3J0IHtcbiAgY3JlYXRlU2VydmVyRXJyb3JSZXNwb25zZSxcbiAgaXNSZXNwb25zZUVycm9yLFxuICBpc1Jlc3BvbnNlTGlrZSxcbiAgUmVzcG9uc2VFcnJvcixcbn0gZnJvbSAnLi9yZXNwb25zZVV0aWxzJ1xuaW1wb3J0IHsgSW50ZXJjZXB0b3JFcnJvciB9IGZyb20gJy4uL0ludGVyY2VwdG9yRXJyb3InXG5pbXBvcnQgeyBpc05vZGVMaWtlRXJyb3IgfSBmcm9tICcuL2lzTm9kZUxpa2VFcnJvcidcbmltcG9ydCB7IGlzT2JqZWN0IH0gZnJvbSAnLi9pc09iamVjdCdcblxuaW50ZXJmYWNlIEhhbmRsZVJlcXVlc3RPcHRpb25zIHtcbiAgcmVxdWVzdElkOiBzdHJpbmdcbiAgcmVxdWVzdDogUmVxdWVzdFxuICBlbWl0dGVyOiBFbWl0dGVyPEh0dHBSZXF1ZXN0RXZlbnRNYXA+XG4gIGNvbnRyb2xsZXI6IFJlcXVlc3RDb250cm9sbGVyXG5cbiAgLyoqXG4gICAqIENhbGxlZCB3aGVuIHRoZSByZXF1ZXN0IGhhcyBiZWVuIGhhbmRsZWRcbiAgICogd2l0aCB0aGUgZ2l2ZW4gYFJlc3BvbnNlYCBpbnN0YW5jZS5cbiAgICovXG4gIG9uUmVzcG9uc2U6IChyZXNwb25zZTogUmVzcG9uc2UpID0+IHZvaWQgfCBQcm9taXNlPHZvaWQ+XG5cbiAgLyoqXG4gICAqIENhbGxlZCB3aGVuIHRoZSByZXF1ZXN0IGhhcyBiZWVuIGhhbmRsZWRcbiAgICogd2l0aCB0aGUgZ2l2ZW4gYFJlc3BvbnNlLmVycm9yKClgIGluc3RhbmNlLlxuICAgKi9cbiAgb25SZXF1ZXN0RXJyb3I6IChyZXNwb25zZTogUmVzcG9uc2VFcnJvcikgPT4gdm9pZFxuXG4gIC8qKlxuICAgKiBDYWxsZWQgd2hlbiBhbiB1bmhhbmRsZWQgZXJyb3IgaGFwcGVucyBkdXJpbmcgdGhlXG4gICAqIHJlcXVlc3QgaGFuZGxpbmcuIFRoaXMgaXMgbmV2ZXIgYSB0aHJvd24gZXJyb3IvcmVzcG9uc2UuXG4gICAqL1xuICBvbkVycm9yOiAoZXJyb3I6IHVua25vd24pID0+IHZvaWRcbn1cblxuLyoqXG4gKiBAcmV0dXJucyB7UHJvbWlzZTxib29sZWFuPn0gSW5kaWNhdGVzIHdoZXRoZXIgdGhlIHJlcXVlc3QgaGFzIGJlZW4gaGFuZGxlZC5cbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGhhbmRsZVJlcXVlc3QoXG4gIG9wdGlvbnM6IEhhbmRsZVJlcXVlc3RPcHRpb25zXG4pOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgY29uc3QgaGFuZGxlUmVzcG9uc2UgPSBhc3luYyAoXG4gICAgcmVzcG9uc2U6IFJlc3BvbnNlIHwgRXJyb3IgfCBSZWNvcmQ8c3RyaW5nLCBhbnk+XG4gICkgPT4ge1xuICAgIGlmIChyZXNwb25zZSBpbnN0YW5jZW9mIEVycm9yKSB7XG4gICAgICBvcHRpb25zLm9uRXJyb3IocmVzcG9uc2UpXG4gICAgICByZXR1cm4gdHJ1ZVxuICAgIH1cblxuICAgIC8vIEhhbmRsZSBcIlJlc3BvbnNlLmVycm9yKClcIiBpbnN0YW5jZXMuXG4gICAgaWYgKGlzUmVzcG9uc2VFcnJvcihyZXNwb25zZSkpIHtcbiAgICAgIG9wdGlvbnMub25SZXF1ZXN0RXJyb3IocmVzcG9uc2UpXG4gICAgICByZXR1cm4gdHJ1ZVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEhhbmRsZSBub3JtYWwgcmVzcG9uc2VzIG9yIHJlc3BvbnNlLWxpa2Ugb2JqZWN0cy5cbiAgICAgKiBAbm90ZSBUaGlzIG11c3QgY29tZSBiZWZvcmUgdGhlIGFyYml0cmFyeSBvYmplY3QgY2hlY2tcbiAgICAgKiBzaW5jZSBSZXNwb25zZSBpbnN0YW5jZXMgYXJlLCBpbiBmYWN0LCBvYmplY3RzLlxuICAgICAqL1xuICAgIGlmIChpc1Jlc3BvbnNlTGlrZShyZXNwb25zZSkpIHtcbiAgICAgIGF3YWl0IG9wdGlvbnMub25SZXNwb25zZShyZXNwb25zZSlcbiAgICAgIHJldHVybiB0cnVlXG4gICAgfVxuXG4gICAgLy8gSGFuZGxlIGFyYml0cmFyeSBvYmplY3RzIHByb3ZpZGVkIHRvIGAuZXJyb3JXaXRoKHJlYXNvbilgLlxuICAgIGlmIChpc09iamVjdChyZXNwb25zZSkpIHtcbiAgICAgIG9wdGlvbnMub25FcnJvcihyZXNwb25zZSlcbiAgICAgIHJldHVybiB0cnVlXG4gICAgfVxuXG4gICAgcmV0dXJuIGZhbHNlXG4gIH1cblxuICBjb25zdCBoYW5kbGVSZXNwb25zZUVycm9yID0gYXN5bmMgKGVycm9yOiB1bmtub3duKTogUHJvbWlzZTxib29sZWFuPiA9PiB7XG4gICAgLy8gRm9yd2FyZCB0aGUgc3BlY2lhbCBpbnRlcmNlcHRvciBlcnJvciBpbnN0YW5jZXNcbiAgICAvLyB0byB0aGUgZGV2ZWxvcGVyLiBUaGVzZSBtdXN0IG5vdCBiZSBoYW5kbGVkIGluIGFueSB3YXkuXG4gICAgaWYgKGVycm9yIGluc3RhbmNlb2YgSW50ZXJjZXB0b3JFcnJvcikge1xuICAgICAgdGhyb3cgcmVzdWx0LmVycm9yXG4gICAgfVxuXG4gICAgLy8gU3VwcG9ydCBtb2NraW5nIE5vZGUuanMtbGlrZSBlcnJvcnMuXG4gICAgaWYgKGlzTm9kZUxpa2VFcnJvcihlcnJvcikpIHtcbiAgICAgIG9wdGlvbnMub25FcnJvcihlcnJvcilcbiAgICAgIHJldHVybiB0cnVlXG4gICAgfVxuXG4gICAgLy8gSGFuZGxlIHRocm93biByZXNwb25zZXMuXG4gICAgaWYgKGVycm9yIGluc3RhbmNlb2YgUmVzcG9uc2UpIHtcbiAgICAgIHJldHVybiBhd2FpdCBoYW5kbGVSZXNwb25zZShlcnJvcilcbiAgICB9XG5cbiAgICByZXR1cm4gZmFsc2VcbiAgfVxuXG4gIC8vIEFkZCB0aGUgbGFzdCBcInJlcXVlc3RcIiBsaXN0ZW5lciB0byBjaGVjayBpZiB0aGUgcmVxdWVzdFxuICAvLyBoYXMgYmVlbiBoYW5kbGVkIGluIGFueSB3YXkuIElmIGl0IGhhc24ndCwgcmVzb2x2ZSB0aGVcbiAgLy8gcmVzcG9uc2UgcHJvbWlzZSB3aXRoIHVuZGVmaW5lZC5cbiAgb3B0aW9ucy5lbWl0dGVyLm9uY2UoJ3JlcXVlc3QnLCAoeyByZXF1ZXN0SWQ6IHBlbmRpbmdSZXF1ZXN0SWQgfSkgPT4ge1xuICAgIGlmIChwZW5kaW5nUmVxdWVzdElkICE9PSBvcHRpb25zLnJlcXVlc3RJZCkge1xuICAgICAgcmV0dXJuXG4gICAgfVxuXG4gICAgaWYgKG9wdGlvbnMuY29udHJvbGxlcltrUmVzcG9uc2VQcm9taXNlXS5zdGF0ZSA9PT0gJ3BlbmRpbmcnKSB7XG4gICAgICBvcHRpb25zLmNvbnRyb2xsZXJba1Jlc3BvbnNlUHJvbWlzZV0ucmVzb2x2ZSh1bmRlZmluZWQpXG4gICAgfVxuICB9KVxuXG4gIGNvbnN0IHJlcXVlc3RBYm9ydFByb21pc2UgPSBuZXcgRGVmZXJyZWRQcm9taXNlPHZvaWQsIHVua25vd24+KClcblxuICAvKipcbiAgICogQG5vdGUgYHNpZ25hbGAgaXMgbm90IGFsd2F5cyBkZWZpbmVkIGluIFJlYWN0IE5hdGl2ZS5cbiAgICovXG4gIGlmIChvcHRpb25zLnJlcXVlc3Quc2lnbmFsKSB7XG4gICAgaWYgKG9wdGlvbnMucmVxdWVzdC5zaWduYWwuYWJvcnRlZCkge1xuICAgICAgcmVxdWVzdEFib3J0UHJvbWlzZS5yZWplY3Qob3B0aW9ucy5yZXF1ZXN0LnNpZ25hbC5yZWFzb24pXG4gICAgfSBlbHNlIHtcbiAgICAgIG9wdGlvbnMucmVxdWVzdC5zaWduYWwuYWRkRXZlbnRMaXN0ZW5lcihcbiAgICAgICAgJ2Fib3J0JyxcbiAgICAgICAgKCkgPT4ge1xuICAgICAgICAgIHJlcXVlc3RBYm9ydFByb21pc2UucmVqZWN0KG9wdGlvbnMucmVxdWVzdC5zaWduYWwucmVhc29uKVxuICAgICAgICB9LFxuICAgICAgICB7IG9uY2U6IHRydWUgfVxuICAgICAgKVxuICAgIH1cbiAgfVxuXG4gIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHVudGlsKGFzeW5jICgpID0+IHtcbiAgICAvLyBFbWl0IHRoZSBcInJlcXVlc3RcIiBldmVudCBhbmQgd2FpdCB1bnRpbCBhbGwgdGhlIGxpc3RlbmVyc1xuICAgIC8vIGZvciB0aGF0IGV2ZW50IGFyZSBmaW5pc2hlZCAoZS5nLiBhc3luYyBsaXN0ZW5lcnMgYXdhaXRlZCkuXG4gICAgLy8gQnkgdGhlIGVuZCBvZiB0aGlzIHByb21pc2UsIHRoZSBkZXZlbG9wZXIgY2Fubm90IGFmZmVjdCB0aGVcbiAgICAvLyByZXF1ZXN0IGFueW1vcmUuXG4gICAgY29uc3QgcmVxdWVzdExpc3RlbmVyc1Byb21pc2UgPSBlbWl0QXN5bmMob3B0aW9ucy5lbWl0dGVyLCAncmVxdWVzdCcsIHtcbiAgICAgIHJlcXVlc3RJZDogb3B0aW9ucy5yZXF1ZXN0SWQsXG4gICAgICByZXF1ZXN0OiBvcHRpb25zLnJlcXVlc3QsXG4gICAgICBjb250cm9sbGVyOiBvcHRpb25zLmNvbnRyb2xsZXIsXG4gICAgfSlcblxuICAgIGF3YWl0IFByb21pc2UucmFjZShbXG4gICAgICAvLyBTaG9ydC1jaXJjdWl0IHRoZSByZXF1ZXN0IGhhbmRsaW5nIHByb21pc2UgaWYgdGhlIHJlcXVlc3QgZ2V0cyBhYm9ydGVkLlxuICAgICAgcmVxdWVzdEFib3J0UHJvbWlzZSxcbiAgICAgIHJlcXVlc3RMaXN0ZW5lcnNQcm9taXNlLFxuICAgICAgb3B0aW9ucy5jb250cm9sbGVyW2tSZXNwb25zZVByb21pc2VdLFxuICAgIF0pXG5cbiAgICAvLyBUaGUgcmVzcG9uc2UgcHJvbWlzZSB3aWxsIHNldHRsZSBpbW1lZGlhdGVseSBvbmNlXG4gICAgLy8gdGhlIGRldmVsb3BlciBjYWxscyBlaXRoZXIgXCJyZXNwb25kV2l0aFwiIG9yIFwiZXJyb3JXaXRoXCIuXG4gICAgcmV0dXJuIGF3YWl0IG9wdGlvbnMuY29udHJvbGxlcltrUmVzcG9uc2VQcm9taXNlXVxuICB9KVxuXG4gIC8vIEhhbmRsZSB0aGUgcmVxdWVzdCBiZWluZyBhYm9ydGVkIHdoaWxlIHdhaXRpbmcgZm9yIHRoZSByZXF1ZXN0IGxpc3RlbmVycy5cbiAgaWYgKHJlcXVlc3RBYm9ydFByb21pc2Uuc3RhdGUgPT09ICdyZWplY3RlZCcpIHtcbiAgICBvcHRpb25zLm9uRXJyb3IocmVxdWVzdEFib3J0UHJvbWlzZS5yZWplY3Rpb25SZWFzb24pXG4gICAgcmV0dXJuIHRydWVcbiAgfVxuXG4gIGlmIChyZXN1bHQuZXJyb3IpIHtcbiAgICAvLyBIYW5kbGUgdGhlIGVycm9yIGR1cmluZyB0aGUgcmVxdWVzdCBsaXN0ZW5lciBleGVjdXRpb24uXG4gICAgLy8gVGhlc2UgY2FuIGJlIHRocm93biByZXNwb25zZXMgb3IgcmVxdWVzdCBlcnJvcnMuXG4gICAgaWYgKGF3YWl0IGhhbmRsZVJlc3BvbnNlRXJyb3IocmVzdWx0LmVycm9yKSkge1xuICAgICAgcmV0dXJuIHRydWVcbiAgICB9XG5cbiAgICAvLyBJZiB0aGUgZGV2ZWxvcGVyIGhhcyBhZGRlZCBcInVuaGFuZGxlZEV4Y2VwdGlvblwiIGxpc3RlbmVycyxcbiAgICAvLyBhbGxvdyB0aGVtIHRvIGhhbmRsZSB0aGUgZXJyb3IuIFRoZXkgY2FuIHRyYW5zbGF0ZSBpdCB0byBhXG4gICAgLy8gbW9ja2VkIHJlc3BvbnNlLCBuZXR3b3JrIGVycm9yLCBvciBmb3J3YXJkIGl0IGFzLWlzLlxuICAgIGlmIChvcHRpb25zLmVtaXR0ZXIubGlzdGVuZXJDb3VudCgndW5oYW5kbGVkRXhjZXB0aW9uJykgPiAwKSB7XG4gICAgICAvLyBDcmVhdGUgYSBuZXcgcmVxdWVzdCBjb250cm9sbGVyIGp1c3QgZm9yIHRoZSB1bmhhbmRsZWQgZXhjZXB0aW9uIGNhc2UuXG4gICAgICAvLyBUaGlzIGlzIG5lZWRlZCBiZWNhdXNlIHRoZSBvcmlnaW5hbCBjb250cm9sbGVyIG1pZ2h0IGhhdmUgYmVlbiBhbHJlYWR5XG4gICAgICAvLyBpbnRlcmFjdGVkIHdpdGggKGUuZy4gXCJyZXNwb25kV2l0aFwiIG9yIFwiZXJyb3JXaXRoXCIgY2FsbGVkIG9uIGl0KS5cbiAgICAgIGNvbnN0IHVuaGFuZGxlZEV4Y2VwdGlvbkNvbnRyb2xsZXIgPSBuZXcgUmVxdWVzdENvbnRyb2xsZXIoXG4gICAgICAgIG9wdGlvbnMucmVxdWVzdFxuICAgICAgKVxuXG4gICAgICBhd2FpdCBlbWl0QXN5bmMob3B0aW9ucy5lbWl0dGVyLCAndW5oYW5kbGVkRXhjZXB0aW9uJywge1xuICAgICAgICBlcnJvcjogcmVzdWx0LmVycm9yLFxuICAgICAgICByZXF1ZXN0OiBvcHRpb25zLnJlcXVlc3QsXG4gICAgICAgIHJlcXVlc3RJZDogb3B0aW9ucy5yZXF1ZXN0SWQsXG4gICAgICAgIGNvbnRyb2xsZXI6IHVuaGFuZGxlZEV4Y2VwdGlvbkNvbnRyb2xsZXIsXG4gICAgICB9KS50aGVuKCgpID0+IHtcbiAgICAgICAgLy8gSWYgYWxsIHRoZSBcInVuaGFuZGxlZEV4Y2VwdGlvblwiIGxpc3RlbmVycyBoYXZlIGZpbmlzaGVkXG4gICAgICAgIC8vIGJ1dCBoYXZlIG5vdCBoYW5kbGVkIHRoZSByZXNwb25zZSBpbiBhbnkgd2F5LCBwcmVlbXB0aXZlbHlcbiAgICAgICAgLy8gcmVzb2x2ZSB0aGUgcGVuZGluZyByZXNwb25zZSBwcm9taXNlIGZyb20gdGhlIG5ldyBjb250cm9sbGVyLlxuICAgICAgICAvLyBUaGlzIHByZXZlbnRzIGl0IGZyb20gaGFuZ2luZyBmb3JldmVyLlxuICAgICAgICBpZiAoXG4gICAgICAgICAgdW5oYW5kbGVkRXhjZXB0aW9uQ29udHJvbGxlcltrUmVzcG9uc2VQcm9taXNlXS5zdGF0ZSA9PT0gJ3BlbmRpbmcnXG4gICAgICAgICkge1xuICAgICAgICAgIHVuaGFuZGxlZEV4Y2VwdGlvbkNvbnRyb2xsZXJba1Jlc3BvbnNlUHJvbWlzZV0ucmVzb2x2ZSh1bmRlZmluZWQpXG4gICAgICAgIH1cbiAgICAgIH0pXG5cbiAgICAgIGNvbnN0IG5leHRSZXN1bHQgPSBhd2FpdCB1bnRpbChcbiAgICAgICAgKCkgPT4gdW5oYW5kbGVkRXhjZXB0aW9uQ29udHJvbGxlcltrUmVzcG9uc2VQcm9taXNlXVxuICAgICAgKVxuXG4gICAgICAvKipcbiAgICAgICAqIEBub3RlIEhhbmRsZSB0aGUgcmVzdWx0IG9mIHRoZSB1bmhhbmRsZWQgY29udHJvbGxlclxuICAgICAgICogaW4gdGhlIHNhbWUgd2F5IGFzIHRoZSBvcmlnaW5hbCByZXF1ZXN0IGNvbnRyb2xsZXIuXG4gICAgICAgKiBUaGUgZXhjZXB0aW9uIGhlcmUgaXMgdGhhdCB0aHJvd24gZXJyb3JzIHdpdGhpbiB0aGVcbiAgICAgICAqIFwidW5oYW5kbGVkRXhjZXB0aW9uXCIgZXZlbnQgZG8gTk9UIHJlc3VsdCBpbiBhbm90aGVyXG4gICAgICAgKiBlbWl0IG9mIHRoZSBzYW1lIGV2ZW50LiBUaGV5IGFyZSBmb3J3YXJkZWQgYXMtaXMuXG4gICAgICAgKi9cbiAgICAgIGlmIChuZXh0UmVzdWx0LmVycm9yKSB7XG4gICAgICAgIHJldHVybiBoYW5kbGVSZXNwb25zZUVycm9yKG5leHRSZXN1bHQuZXJyb3IpXG4gICAgICB9XG5cbiAgICAgIGlmIChuZXh0UmVzdWx0LmRhdGEpIHtcbiAgICAgICAgcmV0dXJuIGhhbmRsZVJlc3BvbnNlKG5leHRSZXN1bHQuZGF0YSlcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBPdGhlcndpc2UsIGNvZXJjZSB1bmhhbmRsZWQgZXhjZXB0aW9ucyB0byBhIDUwMCBJbnRlcm5hbCBTZXJ2ZXIgRXJyb3IgcmVzcG9uc2UuXG4gICAgb3B0aW9ucy5vblJlc3BvbnNlKGNyZWF0ZVNlcnZlckVycm9yUmVzcG9uc2UocmVzdWx0LmVycm9yKSlcbiAgICByZXR1cm4gdHJ1ZVxuICB9XG5cbiAgLyoqXG4gICAqIEhhbmRsZSBhIG1vY2tlZCBSZXNwb25zZSBpbnN0YW5jZS5cbiAgICogQG5vdGUgVGhhdCB0aGlzIGNhbiBhbHNvIGJlIGFuIEVycm9yIGluIGNhc2VcbiAgICogdGhlIGRldmVsb3BlciBjYWxsZWQgXCJlcnJvcldpdGhcIi4gVGhpcyBkaWZmZXJlbnRpYXRlc1xuICAgKiB1bmhhbmRsZWQgZXhjZXB0aW9ucyBmcm9tIGludGVuZGVkIGVycm9ycy5cbiAgICovXG4gIGlmIChyZXN1bHQuZGF0YSkge1xuICAgIHJldHVybiBoYW5kbGVSZXNwb25zZShyZXN1bHQuZGF0YSlcbiAgfVxuXG4gIC8vIEluIGFsbCBvdGhlciBjYXNlcywgY29uc2lkZXIgdGhlIHJlcXVlc3QgdW5oYW5kbGVkLlxuICByZXR1cm4gZmFsc2Vcbn1cbiIsIi8qKlxuICogRGV0ZXJtaW5lcyBpZiBhIGdpdmVuIHZhbHVlIGlzIGFuIGluc3RhbmNlIG9mIG9iamVjdC5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGlzT2JqZWN0PFQ+KHZhbHVlOiBhbnksIGxvb3NlID0gZmFsc2UpOiB2YWx1ZSBpcyBUIHtcbiAgcmV0dXJuIGxvb3NlXG4gICAgPyBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodmFsdWUpLnN0YXJ0c1dpdGgoJ1tvYmplY3QgJylcbiAgICA6IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT09ICdbb2JqZWN0IE9iamVjdF0nXG59XG4iLCIvKipcbiAqIEEgZnVuY3Rpb24gdGhhdCB2YWxpZGF0ZXMgaWYgcHJvcGVydHkgYWNjZXNzIGlzIHBvc3NpYmxlIG9uIGFuIG9iamVjdFxuICogd2l0aG91dCB0aHJvd2luZy4gSXQgcmV0dXJucyBgdHJ1ZWAgaWYgdGhlIHByb3BlcnR5IGFjY2VzcyBpcyBwb3NzaWJsZVxuICogYW5kIGBmYWxzZWAgb3RoZXJ3aXNlLlxuICpcbiAqIEVudmlyb25tZW50cyBsaWtlIG1pbmlmbGFyZSB3aWxsIHRocm93IG9uIHByb3BlcnR5IGFjY2VzcyBvbiBjZXJ0YWluIG9iamVjdHNcbiAqIGxpa2UgUmVxdWVzdCBhbmQgUmVzcG9uc2UsIGZvciB1bmltcGxlbWVudGVkIHByb3BlcnRpZXMuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBpc1Byb3BlcnR5QWNjZXNzaWJsZTxPYmogZXh0ZW5kcyBSZWNvcmQ8c3RyaW5nLCBhbnk+PihcbiAgb2JqOiBPYmosXG4gIGtleToga2V5b2YgT2JqXG4pIHtcbiAgdHJ5IHtcbiAgICBvYmpba2V5XVxuICAgIHJldHVybiB0cnVlXG4gIH0gY2F0Y2gge1xuICAgIHJldHVybiBmYWxzZVxuICB9XG59XG4iLCJpbXBvcnQgeyBpc09iamVjdCB9IGZyb20gJy4vaXNPYmplY3QnXG5pbXBvcnQgeyBpc1Byb3BlcnR5QWNjZXNzaWJsZSB9IGZyb20gJy4vaXNQcm9wZXJ0eUFjY2Vzc2libGUnXG5cbi8qKlxuICogQ3JlYXRlcyBhIGdlbmVyaWMgNTAwIFVuaGFuZGxlZCBFeGNlcHRpb24gcmVzcG9uc2UuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVTZXJ2ZXJFcnJvclJlc3BvbnNlKGJvZHk6IHVua25vd24pOiBSZXNwb25zZSB7XG4gIHJldHVybiBuZXcgUmVzcG9uc2UoXG4gICAgSlNPTi5zdHJpbmdpZnkoXG4gICAgICBib2R5IGluc3RhbmNlb2YgRXJyb3JcbiAgICAgICAgPyB7XG4gICAgICAgICAgICBuYW1lOiBib2R5Lm5hbWUsXG4gICAgICAgICAgICBtZXNzYWdlOiBib2R5Lm1lc3NhZ2UsXG4gICAgICAgICAgICBzdGFjazogYm9keS5zdGFjayxcbiAgICAgICAgICB9XG4gICAgICAgIDogYm9keVxuICAgICksXG4gICAge1xuICAgICAgc3RhdHVzOiA1MDAsXG4gICAgICBzdGF0dXNUZXh0OiAnVW5oYW5kbGVkIEV4Y2VwdGlvbicsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICB9LFxuICAgIH1cbiAgKVxufVxuXG5leHBvcnQgdHlwZSBSZXNwb25zZUVycm9yID0gUmVzcG9uc2UgJiB7IHR5cGU6ICdlcnJvcicgfVxuXG4vKipcbiAqIENoZWNrIGlmIHRoZSBnaXZlbiByZXNwb25zZSBpcyBhIGBSZXNwb25zZS5lcnJvcigpYC5cbiAqXG4gKiBAbm90ZSBTb21lIGVudmlyb25tZW50cywgbGlrZSBNaW5pZmxhcmUgKENsb3VkZmxhcmUpIGRvIG5vdFxuICogaW1wbGVtZW50IHRoZSBcIlJlc3BvbnNlLnR5cGVcIiBwcm9wZXJ0eSBhbmQgdGhyb3cgb24gaXRzIGFjY2Vzcy5cbiAqIFNhZmVseSBjaGVjayBpZiB3ZSBjYW4gYWNjZXNzIFwidHlwZVwiIG9uIFwiUmVzcG9uc2VcIiBiZWZvcmUgY29udGludWluZy5cbiAqIEBzZWUgaHR0cHM6Ly9naXRodWIuY29tL21zd2pzL21zdy9pc3N1ZXMvMTgzNFxuICovXG5leHBvcnQgZnVuY3Rpb24gaXNSZXNwb25zZUVycm9yKHJlc3BvbnNlOiB1bmtub3duKTogcmVzcG9uc2UgaXMgUmVzcG9uc2VFcnJvciB7XG4gIHJldHVybiAoXG4gICAgcmVzcG9uc2UgIT0gbnVsbCAmJlxuICAgIHJlc3BvbnNlIGluc3RhbmNlb2YgUmVzcG9uc2UgJiZcbiAgICBpc1Byb3BlcnR5QWNjZXNzaWJsZShyZXNwb25zZSwgJ3R5cGUnKSAmJlxuICAgIHJlc3BvbnNlLnR5cGUgPT09ICdlcnJvcidcbiAgKVxufVxuXG4vKipcbiAqIENoZWNrIGlmIHRoZSBnaXZlbiB2YWx1ZSBpcyBhIGBSZXNwb25zZWAgb3IgYSBSZXNwb25zZS1saWtlIG9iamVjdC5cbiAqIFRoaXMgaXMgZGlmZmVyZW50IGZyb20gYHZhbHVlIGluc3RhbmNlb2YgUmVzcG9uc2VgIGJlY2F1c2UgaXQgc3VwcG9ydHNcbiAqIGN1c3RvbSBgUmVzcG9uc2VgIGNvbnN0cnVjdG9ycywgbGlrZSB0aGUgb25lIHdoZW4gdXNpbmcgVW5kaWNpIGRpcmVjdGx5LlxuICovXG5leHBvcnQgZnVuY3Rpb24gaXNSZXNwb25zZUxpa2UodmFsdWU6IHVua25vd24pOiB2YWx1ZSBpcyBSZXNwb25zZSB7XG4gIHJldHVybiAoXG4gICAgaXNPYmplY3Q8UmVjb3JkPHN0cmluZywgYW55Pj4odmFsdWUsIHRydWUpICYmXG4gICAgaXNQcm9wZXJ0eUFjY2Vzc2libGUodmFsdWUsICdzdGF0dXMnKSAmJlxuICAgIGlzUHJvcGVydHlBY2Nlc3NpYmxlKHZhbHVlLCAnc3RhdHVzVGV4dCcpICYmXG4gICAgaXNQcm9wZXJ0eUFjY2Vzc2libGUodmFsdWUsICdib2R5VXNlZCcpXG4gIClcbn1cbiIsImV4cG9ydCBmdW5jdGlvbiBpc05vZGVMaWtlRXJyb3IoXG4gIGVycm9yOiB1bmtub3duXG4pOiBlcnJvciBpcyBOb2RlSlMuRXJybm9FeGNlcHRpb24ge1xuICBpZiAoZXJyb3IgPT0gbnVsbCkge1xuICAgIHJldHVybiBmYWxzZVxuICB9XG5cbiAgaWYgKCEoZXJyb3IgaW5zdGFuY2VvZiBFcnJvcikpIHtcbiAgICByZXR1cm4gZmFsc2VcbiAgfVxuXG4gIHJldHVybiAnY29kZScgaW4gZXJyb3IgJiYgJ2Vycm5vJyBpbiBlcnJvclxufVxuIl0sIm1hcHBpbmdzIjoiOzs7OztBQUFBLElBQUFBLFdBQVMsR0FBQUMsT0FBQSxDQUFpQjtBQUMxQixJQUFBQyxnQkFBUyxHQUFBRCxPQUFBLCtCQUF1Qjs7O0FDRHpCLElBQU1FLGdCQUFBLEdBQU4sY0FBK0JDLEtBQUEsQ0FBTTtFQUMxQ0MsWUFBWUMsT0FBQSxFQUFrQjtJQUM1QixNQUFNQSxPQUFPO0lBQ2IsS0FBS0MsSUFBQSxHQUFPO0lBQ1pDLE1BQUEsQ0FBT0MsY0FBQSxDQUFlLE1BQU1OLGdCQUFBLENBQWlCTyxTQUFTO0VBQ3hEO0FBQ0Y7OztBREZBLElBQU1DLGVBQUEsR0FBa0JDLE1BQUEsQ0FBTyxpQkFBaUI7QUFDekMsSUFBTUMsZ0JBQUEsR0FBbUJELE1BQUEsQ0FBTyxrQkFBa0I7QUFFbEQsSUFBTUUsaUJBQUEsR0FBTixNQUF3QjtFQWtCN0JULFlBQW9CVSxPQUFBLEVBQWtCO0lBQWxCLEtBQUFBLE9BQUEsR0FBQUEsT0FBQTtJQUNsQixLQUFLSixlQUFlLElBQUk7SUFDeEIsS0FBS0UsZ0JBQWdCLElBQUksS0FBSSxHQUFBWCxnQkFBZ0IsQ0FBQWMsZUFBQTtFQUMvQztFQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0VBU09DLFlBQVlDLFFBQUEsRUFBMEI7SUFDM0NsQixXQUFVLENBQUFtQixTQUFBLENBQUFDLEVBQUEsQ0FDUmpCLGdCQUFBLEVBQ0EsQ0FBQyxLQUFLUSxlQUFlLEdBQ3JCLDJGQUNBLEtBQUtJLE9BQUEsQ0FBUU0sTUFBQSxFQUNiLEtBQUtOLE9BQUEsQ0FBUU8sR0FDZjtJ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QUFDO0VBR0QsSUFBSTJELG1CQUFBLENBQW9CRCxLQUFBLEtBQVUsWUFBWTtJQUM1Q1gsT0FBQSxDQUFRRSxPQUFBLENBQVFVLG1CQUFBLENBQW9CUyxlQUFlO0lBQ25ELE9BQU87RUFDVDtFQUVBLElBQUlmLE1BQUEsQ0FBT1IsS0FBQSxFQUFPO0lBR2hCLElBQUksTUFBTU8sbUJBQUEsQ0FBb0JDLE1BQUEsQ0FBT1IsS0FBSyxHQUFHO01BQzNDLE9BQU87SUFDVDtJQUtBLElBQUlFLE9BQUEsQ0FBUWpDLE9BQUEsQ0FBUXVELGFBQUEsQ0FBYyxvQkFBb0IsSUFBSSxHQUFHO01BSTNELE1BQU1DLDRCQUFBLEdBQStCLElBQUlyRSxpQkFBQSxDQUN2QzhDLE9BQUEsQ0FBUTdDLE9BQ1Y7TUFFQSxNQUFNVyxTQUFBLENBQVVrQyxPQUFBLENBQVFqQyxPQUFBLEVBQVMsc0JBQXNCO1FBQ3JEK0IsS0FBQSxFQUFPUSxNQUFBLENBQU9SLEtBQUE7UUFDZDNDLE9BQUEsRUFBUzZDLE9BQUEsQ0FBUTdDLE9BQUE7UUFDakJxRCxTQUFBLEVBQVdSLE9BQUEsQ0FBUVEsU0FBQTtRQUNuQkUsVUFBQSxFQUFZYTtNQUNkLENBQUMsRUFBRUMsSUFBQSxDQUFLLE1BQU07UUFLWixJQUNFRCw0QkFBQSxDQUE2QnRFLGdCQUFnQixFQUFFMEQsS0FBQSxLQUFVLFdBQ3pEO1VBQ0FZLDRCQUFBLENBQTZCdEUsZ0JBQWdCLEVBQUVVLE9BQUEsQ0FBUSxNQUFTO1FBQ2xFO01BQ0YsQ0FBQztNQUVELE1BQU04RCxVQUFBLEdBQWEsTUFBTW5ELE1BQUEsQ0FBQTJDLEtBQUEsQ0FBQXRDLElBQUEsU0FDdkIsTUFBTTRDLDRCQUFBLENBQTZCdEUsZ0JBQWdCLENBQ3JEO01BU0EsSUFBSXdFLFVBQUEsQ0FBVzNCLEtBQUEsRUFBTztRQUNwQixPQUFPTyxtQkFBQSxDQUFvQm9CLFVBQUEsQ0FBVzNCLEtBQUs7TUFDN0M7TUFFQSxJQUFJMkIsVUFBQSxDQUFXeEQsSUFBQSxFQUFNO1FBQ25CLE9BQU9nQyxjQUFBLENBQWV3QixVQUFBLENBQVd4RCxJQUFJO01BQ3ZDO0lBQ0Y7SUFHQStCLE9BQUEsQ0FBUUksVUFBQSxDQUFXbkIseUJBQUEsQ0FBMEJxQixNQUFBLENBQU9SLEtBQUssQ0FBQztJQUMxRCxPQUFPO0VBQ1Q7RUFRQSxJQUFJUSxNQUFBLENBQU9yQyxJQUFBLEVBQU07SUFDZixPQUFPZ0MsY0FBQSxDQUFlSyxNQUFBLENBQU9yQyxJQUFJO0VBQ25DO0VBR0EsT0FBTztBQUNUIiwiaWdub3JlTGlzdCI6W119