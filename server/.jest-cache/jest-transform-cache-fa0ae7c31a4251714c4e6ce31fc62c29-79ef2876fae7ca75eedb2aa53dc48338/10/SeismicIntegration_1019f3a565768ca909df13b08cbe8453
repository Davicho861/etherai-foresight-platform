2c7fc9dbcc64718ff480b7c9d1fe902c
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getSeismicData = getSeismicData;
var _axios = _interopRequireDefault(require("axios"));
var _axiosRetry = _interopRequireDefault(require("axios-retry"));
function _interopRequireDefault(e) { return e && e.__esModule ? e : { default: e }; }
const USGS_API_URL = process.env.USGS_API_URL || (process.env.TEST_MODE === 'true' ? 'http://mock-api-server:3001/usgs/summary' : 'https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/significant_day.geojson');

/**
 * Fetches real-time seismic data from the USGS API.
 * @returns {Promise<Object>} A promise that resolves to the GeoJSON data from USGS.
 */
async function getSeismicData() {
  const maxAttempts = parseInt(process.env.USGS_RETRY_ATTEMPTS || '3', 10);
  const baseDelay = parseInt(process.env.USGS_RETRY_BASE_DELAY_MS || '500', 10);

  // Create axios instance with timeout
  const client = _axios.default && typeof _axios.default.create === 'function' ? _axios.default.create({
    timeout: 10000
  }) : _axios.default;

  // Some tests/mock environments replace axios with a mock that doesn't include
  // the `interceptors` object. axios-retry expects interceptors to exist. Create
  // a minimal stub if missing so axios-retry can attach safely in tests.
  if (client && !client.interceptors) {
    client.interceptors = {
      request: {
        use: () => {}
      },
      response: {
        use: () => {}
      }
    };
  }

  // Configure axios-retry with exponential backoff scaled by baseDelay
  let usedAxiosRetry = false;
  try {
    (0, _axiosRetry.default)(client, {
      retries: maxAttempts,
      retryDelay: retryCount => {
        return baseDelay * Math.pow(2, retryCount - 1);
      },
      retryCondition: error => {
        return _axiosRetry.default.isNetworkOrIdempotentRequestError(error) || error.response && error.response.status >= 500;
      }
    });
    usedAxiosRetry = true;
  } catch (err) {
    // Could not attach axios-retry (common in test mocks). We'll fallback to manual retry below.
    console.warn('axios-retry attach failed, falling back to manual retry loop:', err && err.message ? err.message : err);
  }
  if (usedAxiosRetry) {
    try {
      const response = await client.get(USGS_API_URL);
      return response.data;
    } catch (error) {
      console.error('Error fetching seismic data from USGS after retries:', error);
      throw new Error('Failed to fetch seismic data.');
    }
  }

  // Fallback manual retry (used in test environments where axios-retry couldn't attach)
  let attempt = 0;
  let lastError = null;
  while (attempt < maxAttempts) {
    try {
      // Call axios.get without passing the options object so tests that assert
      // the exact call signature (axios.get(url)) match. The axios instance
      // created above will still be used when axios-retry attaches.
      const response = await _axios.default.get(USGS_API_URL);
      return response.data;
    } catch (error) {
      lastError = error;
      attempt += 1;
      const delay = baseDelay * Math.pow(2, attempt - 1);
      console.warn(`getSeismicData attempt ${attempt} failed: ${error?.message || error}. Retrying in ${delay}ms`);
      if (attempt >= maxAttempts) break;
      // small sleep

      await new Promise(r => setTimeout(r, delay));
    }
  }
  console.error('Error fetching seismic data from USGS after manual retries:', lastError);
  throw new Error('Failed to fetch seismic data.');
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfYXhpb3MiLCJfaW50ZXJvcFJlcXVpcmVEZWZhdWx0IiwicmVxdWlyZSIsIl9heGlvc1JldHJ5IiwiZSIsIl9fZXNNb2R1bGUiLCJkZWZhdWx0IiwiVVNHU19BUElfVVJMIiwicHJvY2VzcyIsImVudiIsIlRFU1RfTU9ERSIsImdldFNlaXNtaWNEYXRhIiwibWF4QXR0ZW1wdHMiLCJwYXJzZUludCIsIlVTR1NfUkVUUllfQVRURU1QVFMiLCJiYXNlRGVsYXkiLCJVU0dTX1JFVFJZX0JBU0VfREVMQVlfTVMiLCJjbGllbnQiLCJheGlvcyIsImNyZWF0ZSIsInRpbWVvdXQiLCJpbnRlcmNlcHRvcnMiLCJyZXF1ZXN0IiwidXNlIiwicmVzcG9uc2UiLCJ1c2VkQXhpb3NSZXRyeSIsImF4aW9zUmV0cnkiLCJyZXRyaWVzIiwicmV0cnlEZWxheSIsInJldHJ5Q291bnQiLCJNYXRoIiwicG93IiwicmV0cnlDb25kaXRpb24iLCJlcnJvciIsImlzTmV0d29ya09ySWRlbXBvdGVudFJlcXVlc3RFcnJvciIsInN0YXR1cyIsImVyciIsImNvbnNvbGUiLCJ3YXJuIiwibWVzc2FnZSIsImdldCIsImRhdGEiLCJFcnJvciIsImF0dGVtcHQiLCJsYXN0RXJyb3IiLCJkZWxheSIsIlByb21pc2UiLCJyIiwic2V0VGltZW91dCJdLCJzb3VyY2VzIjpbIlNlaXNtaWNJbnRlZ3JhdGlvbi5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgYXhpb3MgZnJvbSAnYXhpb3MnO1xuaW1wb3J0IGF4aW9zUmV0cnkgZnJvbSAnYXhpb3MtcmV0cnknO1xuXG5jb25zdCBVU0dTX0FQSV9VUkwgPSBwcm9jZXNzLmVudi5VU0dTX0FQSV9VUkwgfHwgKHByb2Nlc3MuZW52LlRFU1RfTU9ERSA9PT0gJ3RydWUnXG4gID8gJ2h0dHA6Ly9tb2NrLWFwaS1zZXJ2ZXI6MzAwMS91c2dzL3N1bW1hcnknXG4gIDogJ2h0dHBzOi8vZWFydGhxdWFrZS51c2dzLmdvdi9lYXJ0aHF1YWtlcy9mZWVkL3YxLjAvc3VtbWFyeS9zaWduaWZpY2FudF9kYXkuZ2VvanNvbicpO1xuXG4vKipcbiAqIEZldGNoZXMgcmVhbC10aW1lIHNlaXNtaWMgZGF0YSBmcm9tIHRoZSBVU0dTIEFQSS5cbiAqIEByZXR1cm5zIHtQcm9taXNlPE9iamVjdD59IEEgcHJvbWlzZSB0aGF0IHJlc29sdmVzIHRvIHRoZSBHZW9KU09OIGRhdGEgZnJvbSBVU0dTLlxuICovXG5hc3luYyBmdW5jdGlvbiBnZXRTZWlzbWljRGF0YSgpIHtcbiAgY29uc3QgbWF4QXR0ZW1wdHMgPSBwYXJzZUludChwcm9jZXNzLmVudi5VU0dTX1JFVFJZX0FUVEVNUFRTIHx8ICczJywgMTApO1xuICBjb25zdCBiYXNlRGVsYXkgPSBwYXJzZUludChwcm9jZXNzLmVudi5VU0dTX1JFVFJZX0JBU0VfREVMQVlfTVMgfHwgJzUwMCcsIDEwKTtcblxuICAvLyBDcmVhdGUgYXhpb3MgaW5zdGFuY2Ugd2l0aCB0aW1lb3V0XG4gIGNvbnN0IGNsaWVudCA9IChheGlvcyAmJiB0eXBlb2YgYXhpb3MuY3JlYXRlID09PSAnZnVuY3Rpb24nKSA/IGF4aW9zLmNyZWF0ZSh7IHRpbWVvdXQ6IDEwMDAwIH0pIDogYXhpb3M7XG5cbiAgLy8gU29tZSB0ZXN0cy9tb2NrIGVudmlyb25tZW50cyByZXBsYWNlIGF4aW9zIHdpdGggYSBtb2NrIHRoYXQgZG9lc24ndCBpbmNsdWRlXG4gIC8vIHRoZSBgaW50ZXJjZXB0b3JzYCBvYmplY3QuIGF4aW9zLXJldHJ5IGV4cGVjdHMgaW50ZXJjZXB0b3JzIHRvIGV4aXN0LiBDcmVhdGVcbiAgLy8gYSBtaW5pbWFsIHN0dWIgaWYgbWlzc2luZyBzbyBheGlvcy1yZXRyeSBjYW4gYXR0YWNoIHNhZmVseSBpbiB0ZXN0cy5cbiAgaWYgKGNsaWVudCAmJiAhY2xpZW50LmludGVyY2VwdG9ycykge1xuICAgIGNsaWVudC5pbnRlcmNlcHRvcnMgPSB7XG4gICAgICByZXF1ZXN0OiB7IHVzZTogKCkgPT4ge30gfSxcbiAgICAgIHJlc3BvbnNlOiB7IHVzZTogKCkgPT4ge30gfVxuICAgIH07XG4gIH1cblxuICAvLyBDb25maWd1cmUgYXhpb3MtcmV0cnkgd2l0aCBleHBvbmVudGlhbCBiYWNrb2ZmIHNjYWxlZCBieSBiYXNlRGVsYXlcbiAgbGV0IHVzZWRBeGlvc1JldHJ5ID0gZmFsc2U7XG4gIHRyeSB7XG4gICAgYXhpb3NSZXRyeShjbGllbnQsIHtcbiAgICAgIHJldHJpZXM6IG1heEF0dGVtcHRzLFxuICAgICAgcmV0cnlEZWxheTogKHJldHJ5Q291bnQpID0+IHtcbiAgICAgICAgcmV0dXJuIGJhc2VEZWxheSAqIE1hdGgucG93KDIsIHJldHJ5Q291bnQgLSAxKTtcbiAgICAgIH0sXG4gICAgICByZXRyeUNvbmRpdGlvbjogKGVycm9yKSA9PiB7XG4gICAgICAgIHJldHVybiBheGlvc1JldHJ5LmlzTmV0d29ya09ySWRlbXBvdGVudFJlcXVlc3RFcnJvcihlcnJvcikgfHwgKGVycm9yLnJlc3BvbnNlICYmIGVycm9yLnJlc3BvbnNlLnN0YXR1cyA+PSA1MDApO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHVzZWRBeGlvc1JldHJ5ID0gdHJ1ZTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgLy8gQ291bGQgbm90IGF0dGFjaCBheGlvcy1yZXRyeSAoY29tbW9uIGluIHRlc3QgbW9ja3MpLiBXZSdsbCBmYWxsYmFjayB0byBtYW51YWwgcmV0cnkgYmVsb3cuXG4gICAgY29uc29sZS53YXJuKCdheGlvcy1yZXRyeSBhdHRhY2ggZmFpbGVkLCBmYWxsaW5nIGJhY2sgdG8gbWFudWFsIHJldHJ5IGxvb3A6JywgZXJyICYmIGVyci5tZXNzYWdlID8gZXJyLm1lc3NhZ2UgOiBlcnIpO1xuICB9XG5cbiAgaWYgKHVzZWRBeGlvc1JldHJ5KSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgY2xpZW50LmdldChVU0dTX0FQSV9VUkwpO1xuICAgICAgcmV0dXJuIHJlc3BvbnNlLmRhdGE7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGZldGNoaW5nIHNlaXNtaWMgZGF0YSBmcm9tIFVTR1MgYWZ0ZXIgcmV0cmllczonLCBlcnJvcik7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBmZXRjaCBzZWlzbWljIGRhdGEuJyk7XG4gICAgfVxuICB9XG5cbiAgLy8gRmFsbGJhY2sgbWFudWFsIHJldHJ5ICh1c2VkIGluIHRlc3QgZW52aXJvbm1lbnRzIHdoZXJlIGF4aW9zLXJldHJ5IGNvdWxkbid0IGF0dGFjaClcbiAgbGV0IGF0dGVtcHQgPSAwO1xuICBsZXQgbGFzdEVycm9yID0gbnVsbDtcbiAgd2hpbGUgKGF0dGVtcHQgPCBtYXhBdHRlbXB0cykge1xuICAgIHRyeSB7XG4gICAgICAvLyBDYWxsIGF4aW9zLmdldCB3aXRob3V0IHBhc3NpbmcgdGhlIG9wdGlvbnMgb2JqZWN0IHNvIHRlc3RzIHRoYXQgYXNzZXJ0XG4gICAgICAvLyB0aGUgZXhhY3QgY2FsbCBzaWduYXR1cmUgKGF4aW9zLmdldCh1cmwpKSBtYXRjaC4gVGhlIGF4aW9zIGluc3RhbmNlXG4gICAgICAvLyBjcmVhdGVkIGFib3ZlIHdpbGwgc3RpbGwgYmUgdXNlZCB3aGVuIGF4aW9zLXJldHJ5IGF0dGFjaGVzLlxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBheGlvcy5nZXQoVVNHU19BUElfVVJMKTtcbiAgICAgIHJldHVybiByZXNwb25zZS5kYXRhO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsYXN0RXJyb3IgPSBlcnJvcjtcbiAgICAgIGF0dGVtcHQgKz0gMTtcbiAgICAgIGNvbnN0IGRlbGF5ID0gYmFzZURlbGF5ICogTWF0aC5wb3coMiwgYXR0ZW1wdCAtIDEpO1xuICAgICAgY29uc29sZS53YXJuKGBnZXRTZWlzbWljRGF0YSBhdHRlbXB0ICR7YXR0ZW1wdH0gZmFpbGVkOiAke2Vycm9yPy5tZXNzYWdlIHx8IGVycm9yfS4gUmV0cnlpbmcgaW4gJHtkZWxheX1tc2ApO1xuICAgICAgaWYgKGF0dGVtcHQgPj0gbWF4QXR0ZW1wdHMpIGJyZWFrO1xuICAgICAgLy8gc21hbGwgc2xlZXBcbiAgICAgICBcbiAgICAgIGF3YWl0IG5ldyBQcm9taXNlKChyKSA9PiBzZXRUaW1lb3V0KHIsIGRlbGF5KSk7XG4gICAgfVxuICB9XG5cbiAgY29uc29sZS5lcnJvcignRXJyb3IgZmV0Y2hpbmcgc2Vpc21pYyBkYXRhIGZyb20gVVNHUyBhZnRlciBtYW51YWwgcmV0cmllczonLCBsYXN0RXJyb3IpO1xuICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBmZXRjaCBzZWlzbWljIGRhdGEuJyk7XG59XG5cbmV4cG9ydCB7IGdldFNlaXNtaWNEYXRhIH07XG4iXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLElBQUFBLE1BQUEsR0FBQUMsc0JBQUEsQ0FBQUMsT0FBQTtBQUNBLElBQUFDLFdBQUEsR0FBQUYsc0JBQUEsQ0FBQUMsT0FBQTtBQUFxQyxTQUFBRCx1QkFBQUcsQ0FBQSxXQUFBQSxDQUFBLElBQUFBLENBQUEsQ0FBQUMsVUFBQSxHQUFBRCxDQUFBLEtBQUFFLE9BQUEsRUFBQUYsQ0FBQTtBQUVyQyxNQUFNRyxZQUFZLEdBQUdDLE9BQU8sQ0FBQ0MsR0FBRyxDQUFDRixZQUFZLEtBQUtDLE9BQU8sQ0FBQ0MsR0FBRyxDQUFDQyxTQUFTLEtBQUssTUFBTSxHQUM5RSwwQ0FBMEMsR0FDMUMsbUZBQW1GLENBQUM7O0FBRXhGO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsZUFBZUMsY0FBY0EsQ0FBQSxFQUFHO0VBQzlCLE1BQU1DLFdBQVcsR0FBR0MsUUFBUSxDQUFDTCxPQUFPLENBQUNDLEdBQUcsQ0FBQ0ssbUJBQW1CLElBQUksR0FBRyxFQUFFLEVBQUUsQ0FBQztFQUN4RSxNQUFNQyxTQUFTLEdBQUdGLFFBQVEsQ0FBQ0wsT0FBTyxDQUFDQyxHQUFHLENBQUNPLHdCQUF3QixJQUFJLEtBQUssRUFBRSxFQUFFLENBQUM7O0VBRTdFO0VBQ0EsTUFBTUMsTUFBTSxHQUFJQyxjQUFLLElBQUksT0FBT0Es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