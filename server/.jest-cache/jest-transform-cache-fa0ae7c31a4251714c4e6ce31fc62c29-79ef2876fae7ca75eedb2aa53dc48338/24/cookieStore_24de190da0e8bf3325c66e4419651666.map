{"version":3,"names":["cookieStore_exports","__export","cookieStore","module","exports","__toCommonJS","import_is_node_process","require","import_outvariant","import_tough_cookie","import_jsonParse","CookieStore","storageKey","jar","memoryStore","constructor","isNodeProcess","invariant","localStorage","MemoryCookieStore","idx","getCookieStoreIndex","CookieJar","getCookies","url","getCookiesSync","setCookie","cookieName","persist","cookiesString","getItem","rawCookies","jsonParse","cookies","rawCookie","cookie","Cookie","fromJSON","domain","path","key","data","push","toJSON","setItem","JSON","stringify"],"sources":["../../../src/core/utils/cookieStore.ts"],"sourcesContent":["import { isNodeProcess } from 'is-node-process'\nimport { invariant } from 'outvariant'\nimport {\n  Cookie,\n  CookieJar,\n  MemoryCookieStore,\n  type MemoryCookieStoreIndex,\n} from 'tough-cookie'\nimport { jsonParse } from './internal/jsonParse'\n\nclass CookieStore {\n  #storageKey = '__msw-cookie-store__'\n  #jar: CookieJar\n  #memoryStore: MemoryCookieStore\n\n  constructor() {\n    if (!isNodeProcess()) {\n      invariant(\n        typeof localStorage !== 'undefined',\n        'Failed to create a CookieStore: `localStorage` is not available in this environment. This is likely an issue with your environment, which has been detected as browser (or browser-like) environment and must implement global browser APIs correctly.',\n      )\n    }\n\n    this.#memoryStore = new MemoryCookieStore()\n    this.#memoryStore.idx = this.getCookieStoreIndex()\n    this.#jar = new CookieJar(this.#memoryStore)\n  }\n\n  public getCookies(url: string): Array<Cookie> {\n    return this.#jar.getCookiesSync(url)\n  }\n\n  public async setCookie(cookieName: string, url: string): Promise<void> {\n    await this.#jar.setCookie(cookieName, url)\n    this.persist()\n  }\n\n  private getCookieStoreIndex(): MemoryCookieStoreIndex {\n    if (typeof localStorage === 'undefined') {\n      return {}\n    }\n\n    const cookiesString = localStorage.getItem(this.#storageKey)\n    if (cookiesString == null) {\n      return {}\n    }\n\n    const rawCookies = jsonParse<Array<Record<string, unknown>>>(cookiesString)\n    if (rawCookies == null) {\n      return {}\n    }\n\n    const cookies: MemoryCookieStoreIndex = {}\n\n    for (const rawCookie of rawCookies) {\n      const cookie = Cookie.fromJSON(rawCookie)\n\n      if (cookie != null && cookie.domain != null && cookie.path != null) {\n        cookies[cookie.domain] ||= {}\n        cookies[cookie.domain][cookie.path] ||= {}\n        cookies[cookie.domain][cookie.path][cookie.key] = cookie\n      }\n    }\n\n    return cookies\n  }\n\n  private persist(): void {\n    if (typeof localStorage === 'undefined') {\n      return\n    }\n\n    const data = []\n    const { idx } = this.#memoryStore\n\n    for (const domain in idx) {\n      for (const path in idx[domain]) {\n        for (const key in idx[domain][path]) {\n          data.push(idx[domain][path][key].toJSON())\n        }\n      }\n    }\n\n    localStorage.setItem(this.#storageKey, JSON.stringify(data))\n  }\n}\n\nexport const cookieStore = new CookieStore()\n"],"mappings":"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","ignoreList":[]}